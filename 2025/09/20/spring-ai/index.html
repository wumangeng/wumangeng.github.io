<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Spring AI">
    <meta name="description" content="曾梦想仗剑走天涯，后来喝多了，剑丢了马也被偷了，就没去了">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>


    <title>Spring AI | 山河远阔</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="山河远阔" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">山河远阔</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>时光轴</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">山河远阔</div>
        <div class="logo-desc">
            
            曾梦想仗剑走天涯，后来喝多了，剑丢了马也被偷了，就没去了
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			时光轴
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wumangeng/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wumangeng/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://wumangeng-github-io.oss-cn-guangzhou.aliyuncs.com/hexo-blog/blog-image/1747741091046-75e76e43-b253-4c0d-8c15-25ab15ab6e20.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Spring AI</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Spring/">
                                <span class="chip bg-color">Spring</span>
                            </a>
                        
                            <a href="/tags/Spring-AI/">
                                <span class="chip bg-color">Spring AI</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Spring/" class="post-category">
                                Spring
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
         
                

                <!-- 增加在文章页显示作者名的功能 -->
                <div class="text-color" align=center style="font-size:large">
                    
                        <i class="far fa-square"></i> wmg
                    
                </div>

                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-09-20
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    30k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://wumangeng-github-io.oss-cn-guangzhou.aliyuncs.com/hexo-blog/blog-image/1747741091046-75e76e43-b253-4c0d-8c15-25ab15ab6e20.png" alt="img"></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/svg/22309163/1747741168425-a383115b-dad3-4b21-816c-5341b4e06e57.svg" alt="img"></p>
<p>Spring AI 是一个面向人工智能工程的应用框架。解决了 AI 集成的基本挑战：将企业数据和API与AI 模型连接起来。</p>
<h3 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h3><h4 id="提示词工厂"><a href="#提示词工厂" class="headerlink" title="提示词工厂"></a><strong>提示词工厂</strong></h4><p>可以说是大模型应用中最简单也是最核心的一个技术。他是我们更大模型交互的媒介，提示词给的好大模型才能按你想要的方式响应。</p>
<h4 id="对话拦截advisors"><a href="#对话拦截advisors" class="headerlink" title="对话拦截advisors"></a><strong>对话拦截advisors</strong></h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747830520019-359b73ff-8526-45ba-952c-3ede2f45ae0b.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_56,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>面向切面的思想对对模型对话和响应进行增强。</p>
<h4 id="对话记忆"><a href="#对话记忆" class="headerlink" title="对话记忆"></a><strong>对话记忆</strong></h4><pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">@Autowired
ChatMemoryRepository chatMemoryRepository;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>通过一个bean组件就可以让大模型拥有对话记忆功能，可谓是做到了开箱即用</p>
<h4 id="tools"><a href="#tools" class="headerlink" title="tools"></a><strong>tools</strong></h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747830520060-5e3615a6-ca38-467e-964c-aa6a72862756.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_46,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>让大模型可以跟企业业务API进行互联 ，这一块实现起来也是非常的优雅</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">class DateTimeTools &#123;

    @Tool(description = "Get the current date and time in the user's timezone")
    String getCurrentDateTime() &#123;
        return LocalDateTime.now().atZone(LocaleContextHolder.getTimeZone().toZoneId()).toString();
    &#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="RAG技术下的-ETL"><a href="#RAG技术下的-ETL" class="headerlink" title="RAG技术下的 ETL"></a><strong>RAG技术下的 ETL</strong></h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747830520070-10ff2cbb-5292-4f22-8229-ea9cb4e66331.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_96,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>让大模型可以跟企业业务数据进行互联（包括读取文件、分隔文件、向量化） 向量数据库支持 目前支持20+种向量数据库的集成 这块我到时候也会详细去讲</p>
<h4 id="MCP"><a href="#MCP" class="headerlink" title="MCP"></a><strong>MCP</strong></h4><p>让tools外部化，形成公共工具让外部开箱即用。 原来MCP协议的JAVA SDK就是spring ai团队提供的 提供了MCP 客户端、服务端、以及<a target="_blank" rel="noopener" href="https://spring.io/blog/2025/05/19/spring-ai-mcp-client-oauth2">MCP认证授权方案</a> ，还有目前正在孵化的<a target="_blank" rel="noopener" href="https://github.com/tzolov/spring-mcp-agent">Spring MCP Agent</a> 开源项目:</p>
<h4 id="模型的评估"><a href="#模型的评估" class="headerlink" title="模型的评估"></a><strong>模型的评估</strong></h4><p>可以测试大模型的幻觉反应(<code>在系列课详细讲解</code>）</p>
<h4 id="可观察性"><a href="#可观察性" class="headerlink" title="可观察性"></a><strong>可观察性</strong></h4><p>它把AI运行时的大量关键指标暴露出来， 可以提供Spring Boot actuctor进行观测(<code>在系列课详细讲解</code>）</p>
<h4 id="agent应用"><a href="#agent应用" class="headerlink" title="agent应用"></a><strong>agent应用</strong></h4><p>springai 提供了5种agent模式的示例</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/evaluator-optimizer">Evaluator Optimizer</a> – The model analyzes its own responses and refines them through a structured process of self-evaluation.</li>
</ol>
<p><img src="https://raw.githubusercontent.com/spring-io/spring-io-static/refs/heads/main/blog/tzolov/20250520/anthropic-augmented-llm-agents.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_68,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/routing-workflow">Routing</a> – This pattern enables intelligent routing of inputs to specialized handlers based on classification of the user request and context.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/orchestrator-workers">Orchestrator Workers</a> – This pattern is a flexible approach for handling complex tasks that require dynamic task decomposition and specialized processing</li>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/chain-workflow">Chaining</a> – The pattern decomposes complex tasks into a sequence of steps, where each LLM call processes the output of the previous one.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/parallelization-worflow">Parallelization</a> – The pattern is useful for scenarios requiring parallel execution of LLM calls with automated output aggregation.</li>
</ol>
<p> 学完这5种你会对对模型下的agent应用有一个完整认识(<code>在系列课详细讲解</code>）</p>
<h2 id="langchain4j-vs-springAI"><a href="#langchain4j-vs-springAI" class="headerlink" title="langchain4j vs springAI"></a>langchain4j vs springAI</h2><table>
<thead>
<tr>
<th></th>
<th><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750768821298-20a7d9eb-6e79-4c56-aa3a-c8c462b9667f.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_11,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></th>
<th><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750768832185-9c0429a9-86b4-435c-8645-052b44178b38.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_29,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></th>
</tr>
</thead>
<tbody><tr>
<td>生态</td>
<td>不依赖Spring，需要单独集成Spring</td>
<td>Spring官方，和Spring无缝集成</td>
</tr>
<tr>
<td>诞生</td>
<td>更早，中国团队，受 LangChain 启发</td>
<td>稍晚，但是明显后来居上</td>
</tr>
<tr>
<td>jdk</td>
<td>v0.35.0 前的版本支持jdk8   ，后支持jdk17</td>
<td>全版本jdk17</td>
</tr>
<tr>
<td>功能</td>
<td>没有mcp server, 官方建议使用<a target="_blank" rel="noopener" href="https://github.com/quarkiverse/quarkus-mcp-server">quarkus-mcp-server</a></td>
<td>早期落后langchain4j， 现在功能全面，并且生态活跃，开源贡献者众多</td>
</tr>
<tr>
<td>易用性</td>
<td>尚可，中文文档</td>
<td>易用，api优雅</td>
</tr>
<tr>
<td>最终</td>
<td>不需要spring选择！</td>
<td>无脑选！</td>
</tr>
</tbody></table>
<h2 id="大模型选型"><a href="#大模型选型" class="headerlink" title="大模型选型"></a>大模型选型</h2><ol>
<li><p>自研（算法 c++  python 深度学习 机器学习 神经网络 视觉处理 952 211研究生 ）AI算法岗位</p>
</li>
<li><p>云端大模型     占用算力  token计费     功能完善成熟   </p>
</li>
<li><p>开源的大模型（本地部署）Ollama  购买算力    </p>
</li>
<li><ol>
<li>选型</li>
<li>自己构建选型–&gt;评估流程</li>
</ol>
</li>
<li><ol>
<li><ol>
<li>业务确定：（ 电商、医疗、教育 ）</li>
<li>样本准备：数据集样本 选择题</li>
<li>任务定制：问答  （利用多个大模型）</li>
<li>评估： 人工评估</li>
</ol>
</li>
</ol>
</li>
<li><ol>
<li>通用能力毕竟好的</li>
</ol>
</li>
<li><ol>
<li><ol>
<li>2月份   deepseek   6710亿   671b = 算力 显存   H20  96G   140万  ； 比 openai gpt4节省了40/1 成本。</li>
<li>3月份   阿里  qwq-32b(不带深度思考)   32b=320亿   媲美deepseek-r1  32G   比deepseek-r1节省20/1</li>
<li>4月份   阿里  qwen3 (深度思考)    2350亿=235b   赶超了deepseek-r1  比deepseek-r1节省2-3倍    选择(qwen3-30b)</li>
<li>5月    deepseek-r1-0528     6710亿   671b  性能都要要</li>
</ol>
</li>
</ol>
</li>
<li><p>对成本有要求： 选择(qwen3-30b)      </p>
</li>
<li><p>不差钱 deepseek-r1-0528 满血版本</p>
</li>
<li><ol>
<li><ol>
<li><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750856081070-bd44ac03-07d8-468f-a75a-6304f697812a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_97,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></li>
</ol>
</li>
</ol>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750856081223-6550aa2b-d971-4987-a8f4-c96875ed5129.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_97,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/jeinlee1991/chinese-llm-benchmark/main/pic/%E6%80%BB%E5%88%86.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_109,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h2><ol>
<li>创建项目</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747831963607-5dfd6f93-1d11-4408-acee-a8116d0cf0e7.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_28,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.xs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-GA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>spring-ai-GA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>公众号：程序员徐庶<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-ai.version</span><span class="token punctuation">></span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-ai.version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span> 

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-bom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-ai.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="接入deepseek"><a href="#接入deepseek" class="headerlink" title="接入deepseek"></a>接入deepseek</h3><ol>
<li>依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-starter-model-deepseek<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>获取deepseek api-key</li>
</ol>
<ul>
<li><strong>API Key</strong>：需从 DeepSeek 创建并获取 API 密钥：<a target="_blank" rel="noopener" href="https://platform.deepseek.com/api_keys">https://platform.deepseek.com/api_keys</a></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747832077989-a12b8be5-a8d2-4d2a-8ae5-7d4913b50acb.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_54,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747832096179-5c93c5b2-e568-4915-8463-ceeaac75f62b.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_52,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>配置</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">ai</span><span class="token punctuation">:</span>
    <span class="token key atrule">deepseek</span><span class="token punctuation">:</span>
      <span class="token key atrule">api-key</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>DEEP_SEEK_KEY<span class="token punctuation">&#125;</span>
      <span class="token key atrule">chat</span><span class="token punctuation">:</span>
        <span class="token key atrule">options</span><span class="token punctuation">:</span>
          <span class="token key atrule">model</span><span class="token punctuation">:</span> deepseek<span class="token punctuation">-</span>chat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>测试</li>
</ol>
<p><code>&lt;artifactId&gt;spring-ai-starter-model-deepseek&lt;/artifactId&gt;</code> 会为你增加自动配置类， 其中DeepSeekChatModel这个就是专门负责智能对话的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xs<span class="token punctuation">.</span>springaiga</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token punctuation">.</span>deepseek<span class="token punctuation">.</span></span><span class="token class-name">DeepSeekChatModel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeepseelTest</span> <span class="token punctuation">&#123;</span>


    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                         <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> call <span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"你是谁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747832330018-cbc151a4-6de9-4949-9d84-4ad7d5fdb559.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_37,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="流式对话"><a href="#流式对话" class="headerlink" title="流式对话"></a>流式对话</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChat2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                         <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">"你是谁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 阻塞输出</span>
        stream<span class="token punctuation">.</span><span class="token function">toIterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">print</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="options配置选项"><a href="#options配置选项" class="headerlink" title="options配置选项"></a>options配置选项</h4><h5 id="temperature（温度）"><a href="#temperature（温度）" class="headerlink" title="temperature（温度）"></a>temperature（温度）</h5><p>0-2  浮点数值    </p>
<p><strong>数值越高</strong>  更有创造性   热情</p>
<p>数值越低  保守  </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                            <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">DeepSeekChatOptions</span> options <span class="token operator">=</span> <span class="token class-name">DeepSeekChatOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">temperature</span><span class="token punctuation">(</span><span class="token number">1.9d</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ChatResponse</span> res <span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Prompt</span><span class="token punctuation">(</span><span class="token string">"请写一句诗描述清晨。"</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以通过配置文件配置</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.ai.deepseek.chat.options.temperature</span><span class="token punctuation">=</span><span class="token attr-value">0.8</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>temperature:0.2   规规矩矩，像是被应试教育出来的老实学生没有创造力</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747890503560-3f26de5a-a3f3-48a6-86f8-c7bf6dc6923a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_15,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>temperature:1.9   可以看出来表现欲更强， 像是一个在领导面前想要表现的你.<img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747890748919-bf48b998-7b65-455d-a304-5d6c01677e5f.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_38,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>也可以通过提示词降低他的主观臆想：</p>
<ul>
<li>只引用可靠来源中的信息，不做任何假设或扩展描述。</li>
<li>请只基于已知事实回答，不要主观臆想或添加额外内容。</li>
<li>请简明、客观地给出答案，不要进行修饰或补充未经请求的信息。</li>
</ul>
<h6 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h6><table>
<thead>
<tr>
<th><strong>temperature 范围</strong></th>
<th><strong>建议业务场景</strong></th>
<th><strong>输出风格</strong></th>
<th><strong>说明/应用举例</strong></th>
</tr>
</thead>
<tbody><tr>
<td>0.0 ~ 0.2</td>
<td>严谨问答、代码补全、数学答题</td>
<td>严格、确定、标准</td>
<td>法律/金融答题、接口返回模板、考试答卷等</td>
</tr>
<tr>
<td>0.3 ~ 0.6</td>
<td>聊天机器人、日常摘要、辅助写作</td>
<td>稍有变化、较稳妥</td>
<td>公众号摘要、普通对话、邮件生成等</td>
</tr>
<tr>
<td>0.7 ~ 1.0</td>
<td>创作内容、广告文案、标题生成</td>
<td>丰富、有创意、灵活</td>
<td>诗歌、短文案、趣味对话、产品描述等</td>
</tr>
<tr>
<td>1.1 ~ 1.5</td>
<td>脑洞风格、头脑风暴、灵感碰撞场景</td>
<td>大开脑洞、变化极强</td>
<td>故事创作、异想天开的推荐语、多样化内容</td>
</tr>
</tbody></table>
<hr>
<p><strong>说明：</strong></p>
<ul>
<li>温度越低，输出越收敛和中规中矩；</li>
<li>温度越高，输出越多变、富有惊喜但有风险；</li>
<li>实战用法一般建议选 <strong>0.5~0.8</strong> 作为日常生产起点，需要根据业务不断测试调整。</li>
</ul>
<h5 id="maxTokens"><a href="#maxTokens" class="headerlink" title="maxTokens"></a>maxTokens</h5><p>默认低 token</p>
<p><code>maxTokens</code>：限制AI模型生成的最大token数（近似理解为字数上限）。</p>
<ul>
<li>需要简洁回复、打分、列表、短摘要等，建议小值（如10~50）。</li>
<li>防止用户跑长对话导致无关内容或花费过多token费用。</li>
<li>如果遇到生成内容经常被截断，可以适当配置更大maxTokens。</li>
</ul>
<h5 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h5><p> 截断你不想输出的内容  比如：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">ai</span><span class="token punctuation">:</span>
    <span class="token key atrule">deepseek</span><span class="token punctuation">:</span>
      <span class="token key atrule">api-key</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>DEEP_SEEK_KEY<span class="token punctuation">&#125;</span>
      <span class="token key atrule">chat</span><span class="token punctuation">:</span>
        <span class="token key atrule">options</span><span class="token punctuation">:</span>
          <span class="token key atrule">model</span><span class="token punctuation">:</span> deepseek<span class="token punctuation">-</span>chat
          <span class="token key atrule">max-tokens</span><span class="token punctuation">:</span> <span class="token number">20</span>
          <span class="token key atrule">stop</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"\n"</span>    <span class="token comment">#只想一行</span>
              <span class="token punctuation">-</span> <span class="token string">"。"</span>    <span class="token comment">#只想一句话</span>
              <span class="token punctuation">-</span> <span class="token string">"政治"</span>  <span class="token comment">#敏感词</span>
              <span class="token punctuation">-</span> <span class="token string">"最后最总结一下"</span>  <span class="token comment">#这种AI惯用的模板词， 减少AI词汇， 让文章更拟人</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="模型推理"><a href="#模型推理" class="headerlink" title="模型推理"></a>模型推理</h5><p>设置深度思考，  思考的内容有个专业名词叫：Chain of Thought (CoT)</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747914817445-76e8a32a-ddea-4ed0-bb6d-d498f14ad682.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_24,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>在deepseek中，  deepseek-reasoner模型是深度思考模型：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747914659592-870470ec-2b9e-4fd8-963e-446808af56f6.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_26,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deepSeekReasonerExample</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DeepSeekChatModel</span> deepSeekChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DeepSeekChatOptions</span> options <span class="token operator">=</span> <span class="token class-name">DeepSeekChatOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"deepseek-reasoner"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Prompt</span> prompt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Prompt</span><span class="token punctuation">(</span><span class="token string">"请写一句诗描述清晨。"</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChatResponse</span> res <span class="token operator">=</span> deepSeekChatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DeepSeekAssistantMessage</span> assistantMessage <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">DeepSeekAssistantMessage</span><span class="token punctuation">)</span>res<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> reasoningContent <span class="token operator">=</span> assistantMessage<span class="token punctuation">.</span><span class="token function">getReasoningContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> assistantMessage<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>reasoningContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deepSeekReasonerStreamExample</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DeepSeekChatModel</span> deepSeekChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DeepSeekChatOptions</span> options <span class="token operator">=</span> <span class="token class-name">DeepSeekChatOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"deepseek-reasoner"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Prompt</span> prompt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Prompt</span><span class="token punctuation">(</span><span class="token string">"请写一句诗描述清晨。"</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatResponse</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> deepSeekChatModel<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>

        stream<span class="token punctuation">.</span><span class="token function">toIterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>res <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DeepSeekAssistantMessage</span> assistantMessage <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">DeepSeekAssistantMessage</span><span class="token punctuation">)</span>res<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> reasoningContent <span class="token operator">=</span> assistantMessage<span class="token punctuation">.</span><span class="token function">getReasoningContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>reasoningContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">toIterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>res <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DeepSeekAssistantMessage</span> assistantMessage <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">DeepSeekAssistantMessage</span><span class="token punctuation">)</span>res<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> assistantMessage<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以在配置文件中配置</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.ai.deepseek.chat.options.model</span><span class="token punctuation">=</span> <span class="token attr-value">deepseek-reasoner</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750928853497-d5ef1895-6b22-480e-8f80-721797eada97.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_16,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>当调用chatModel.call</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Prompt</span> prompt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Prompt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Generation</span> generation <span class="token operator">=</span> <span class="token function">call</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>generation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> generation<span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><ol>
<li>首先会将提示词解析到Prompt对象中 （用于远程请求的messages）</li>
</ol>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748356262503-f20736ce-10bd-426d-9e99-73ddcdd06bc7.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_24,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>调用deepseekModel#call—&gt; internalCall方法</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ChatResponse</span> <span class="token function">internalCall</span><span class="token punctuation">(</span><span class="token class-name">Prompt</span> prompt<span class="token punctuation">,</span> <span class="token class-name">ChatResponse</span> previousChatResponse<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// a</span>
    <span class="token class-name">ChatCompletionRequest</span> request <span class="token operator">=</span> <span class="token function">createRequest</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//..省略   </span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatCompletion</span><span class="token punctuation">></span></span> completionEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryTemplate
    <span class="token comment">// b</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>ctx <span class="token operator">-></span> <span class="token keyword">this</span><span class="token punctuation">.</span>deepSeekApi<span class="token punctuation">.</span><span class="token function">chatCompletionEntity</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> chatCompletion <span class="token operator">=</span> completionEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//..省略</span>
    <span class="token class-name">ChatResponse</span> chatResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatResponse</span><span class="token punctuation">(</span>generations<span class="token punctuation">,</span>
                                                 <span class="token function">from</span><span class="token punctuation">(</span>completionEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accumulatedUsage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    observationContext<span class="token punctuation">.</span><span class="token function">setResponse</span><span class="token punctuation">(</span>chatResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> chatResponse<span class="token punctuation">;</span>
    <span class="token comment">//.. 省略</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><ol>
<li>通过createRequest封装为远程请求所需的json对象</li>
<li>通过spring retry 重试机制去远程请求</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">deepseekthis.deepSeekApi.chatCompletionEntity(request)
&#x2F;&#x2F; 通过restClient 进行远程请求
public ResponseEntity&lt;ChatCompletion&gt; chatCompletionEntity(ChatCompletionRequest chatRequest) &#123;
 
		return this.restClient.post()
			.uri(this.getEndpoint(chatRequest))
			.body(chatRequest)
			.retrieve()
			.toEntity(ChatCompletion.class);
	&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><ol>
<li>封装响应数据</li>
</ol>
</li>
</ol>
<h3 id="接入阿里百炼"><a href="#接入阿里百炼" class="headerlink" title="接入阿里百炼"></a>接入阿里百炼</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750994049968-43797508-45f3-426a-adfa-3f5dcd73ef13.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_112,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10?x-oss-process=image/crop,x_0,y_0,w_1423,h_1555" alt="img"></p>
<p>阿里自己的团队维护spring-ai-alibaba.   但是也必须依赖spring-ai 。   好处是扩展度更高，坏处是必须是springai先出来， spring-ai-alibaba.延迟几天出来。</p>
<p>如果需要接入阿里的百炼平台， 就必须用该组件</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ol>
<li>申请api-key</li>
</ol>
<p>在调用前，您需要<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/model-studio/get-api-key">开通模型服务并获取API Key</a>，再<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/model-studio/developer-reference/configure-api-key-through-environment-variables">配置API Key到环境变量</a>。</p>
<ol>
<li>依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-alibaba-bom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-alibaba-starter-dashscope<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>配置</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">spring<span class="token operator">:</span>
  ai<span class="token operator">:</span>
    dashscope<span class="token operator">:</span>
      api<span class="token operator">-</span>key<span class="token operator">:</span> $<span class="token punctuation">&#123;</span>AI_DASHSCOPE_API_KEY<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>使用</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testQwen</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> content <span class="token operator">=</span> dashScopeChatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"你好你是谁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="文生图"><a href="#文生图" class="headerlink" title="文生图"></a>文生图</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">text2Img</span><span class="token punctuation">(</span>
          <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeImageModel</span> imageModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">DashScopeImageOptions</span> imageOptions <span class="token operator">=</span> <span class="token class-name">DashScopeImageOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">withModel</span><span class="token punctuation">(</span><span class="token string">"wanx2.1-t2i-turbo"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">ImageResponse</span> imageResponse <span class="token operator">=</span> imageModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
               <span class="token keyword">new</span> <span class="token class-name">ImagePrompt</span><span class="token punctuation">(</span><span class="token string">"程序员徐庶"</span><span class="token punctuation">,</span> imageOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> imageUrl <span class="token operator">=</span> imageResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 图片url</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>imageUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 图片base64</span>
       <span class="token comment">// imageResponse.getResult().getOutput().getB64Json();</span>

       <span class="token comment">/*
       按文件流相应
       InputStream in = url.openStream();

       response.setHeader("Content-Type", MediaType.IMAGE_PNG_VALUE);
       response.getOutputStream().write(in.readAllBytes());
       response.getOutputStream().flush();*/</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="文生语音text2audio"><a href="#文生语音text2audio" class="headerlink" title="文生语音text2audio"></a>文生语音text2audio</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// https://bailian.console.aliyun.com/?spm=5176.29619931.J__Z58Z6CX7MY__Ll8p1ZOR.1.74cd59fcXOTaDL&amp;tab=doc#/doc/?type=model&amp;url=https%3A%2F%2Fhelp.aliyun.com%2Fdocument_detail%2F2842586.html&amp;renderType=iframe</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testText2Audio</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeSpeechSynthesisModel</span> speechSynthesisModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">DashScopeSpeechSynthesisOptions</span> options <span class="token operator">=</span> <span class="token class-name">DashScopeSpeechSynthesisOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token comment">//.voice()   // 人声</span>
               <span class="token comment">//.speed()    // 语速</span>
               <span class="token comment">//.model()    // 模型</span>
               <span class="token comment">//.responseFormat(DashScopeSpeechSynthesisApi.ResponseFormat.MP3)</span>
               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">SpeechSynthesisResponse</span> response <span class="token operator">=</span> speechSynthesisModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
               <span class="token keyword">new</span> <span class="token class-name">SpeechSynthesisPrompt</span><span class="token punctuation">(</span><span class="token string">"大家好， 我是人帅活好的徐庶。"</span><span class="token punctuation">,</span>options<span class="token punctuation">)</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/output.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="语音翻译audio2text"><a href="#语音翻译audio2text" class="headerlink" title="语音翻译audio2text"></a>语音翻译audio2text</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> AUDIO_RESOURCES_URL <span class="token operator">=</span> <span class="token string">"https://dashscope.oss-cn-beijing.aliyuncs.com/samples/audio/paraformer/hello_world_female2.wav"</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAudio2Text</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span>
            <span class="token class-name">DashScopeAudioTranscriptionModel</span> transcriptionModel
    <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DashScopeAudioTranscriptionOptions</span> transcriptionOptions <span class="token operator">=</span> <span class="token class-name">DashScopeAudioTranscriptionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//.withModel()   模型</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AudioTranscriptionPrompt</span> prompt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioTranscriptionPrompt</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">UrlResource</span><span class="token punctuation">(</span>AUDIO_RESOURCES_URL<span class="token punctuation">)</span><span class="token punctuation">,</span>
                transcriptionOptions
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AudioTranscriptionResponse</span> response <span class="token operator">=</span> transcriptionModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
                prompt
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="多模态"><a href="#多模态" class="headerlink" title="多模态"></a>多模态</h4><p>图片  语音  视频  传给大模型  理解</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">@Test
    public void testMultimodal(@Autowired DashScopeChatModel dashScopeChatModel
    ) throws MalformedURLException &#123;
        // flac、mp3、mp4、mpeg、mpga、m4a、ogg、wav 或 webm。
        var audioFile = new ClassPathResource("/files/xushu.png");

        Media media = new Media(MimeTypeUtils.IMAGE_JPEG, audioFile);
        DashScopeChatOptions options = DashScopeChatOptions.builder()
                .withMultiModel(true)
                .withModel("qwen-vl-max-latest").build();

        Prompt  prompt= Prompt.builder().chatOptions(options)
                .messages(UserMessage.builder().media(media)
                        .text("识别图片").build())
                .build();
        ChatResponse response = dashScopeChatModel.call(prompt);

        System.out.println(response.getResult().getOutput().getText());
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="文生视频（更多功能）"><a href="#文生视频（更多功能）" class="headerlink" title="文生视频（更多功能）"></a>文生视频（更多功能）</h4><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>dashscope-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- 请将 'the-latest-version' 替换为最新版本号：https://mvnrepository.com/artifact/com.alibaba/dashscope-sdk-java --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>the-latest-version<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
@Test
    public void text2Video() throws ApiException, NoApiKeyException, InputRequiredException &#123;
        VideoSynthesis vs = new VideoSynthesis();
        VideoSynthesisParam param =
                VideoSynthesisParam.builder()
                        .model("wanx2.1-t2v-turbo")
                        .prompt("一只小猫在月光下奔跑")
                        .size("1280*720")
                        .apiKey(System.getenv("ALI_AI_KEY"))
                        .build();
        System.out.println("please wait...");
        VideoSynthesisResult result = vs.call(param);
        System.out.println(result.getOutput().getVideoUrl());
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="接入ollama本地模型"><a href="#接入ollama本地模型" class="headerlink" title="接入ollama本地模型"></a>接入ollama本地模型</h3><p>ollama是大语言模型的运行环境  ，  支持将开源的大语言模型以离线的方式部署到本地，进行私有化部署。  这也是企业中常用的方案，  因为本地化部署能保证企业级的数据安全， 降低企业使用成本。</p>
<h4 id="1-1-本地大模型安装"><a href="#1-1-本地大模型安装" class="headerlink" title="1.1. 本地大模型安装"></a>1.1. 本地大模型安装</h4><p>  \1. <a target="_blank" rel="noopener" href="https://ollama.com/download">https://ollama.com/download</a></p>
<p>  \2. 点击下载， 一直下一步即可非常简单</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747915924346-0df0e1a5-be5d-4fab-8805-970f30d60a5e.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_16,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li><p>安装完后运行cmd –&gt; ollama list  查看已安装的大模型（开始肯定什么都没有）</p>
</li>
<li><p>拉取模型 <code>ollama run qwen3:4b</code> </p>
</li>
<li><ol>
<li>这里的4b=40亿参数   对应gpu显存差不多是4G ，当然8B也可以只是比较卡</li>
</ol>
</li>
<li><p>测试</p>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747917729824-c0ee37c7-2768-46a7-ae1e-7df3554f8383.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="1-2-基于spring-ai使用"><a href="#1-2-基于spring-ai使用" class="headerlink" title="1.2. 基于spring-ai使用"></a>1.2. 基于spring-ai使用</h4><ol>
<li>添加依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-starter-model-ollama<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<ol>
<li>配置</li>
</ol>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.ai.ollama.base-url</span><span class="token punctuation">=</span> <span class="token attr-value">http://localhost:11434</span>
<span class="token attr-name">spring.ai.ollama.chat.model</span><span class="token punctuation">=</span> <span class="token attr-value">qwen3:4b</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol>
<li>测试</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author 公众号：程序员徐庶
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OllamaTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaChatModel</span> ollamaChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> text <span class="token operator">=</span> ollamaChatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"你是谁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747918232750-104c6590-3bf0-40aa-8019-af8a43befa0b.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_38,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="1-3-关闭thingking"><a href="#1-3-关闭thingking" class="headerlink" title="1.3. 关闭thingking"></a>1.3. 关闭thingking</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1751199163428-8570576c-1cf9-4b4e-ba78-4991cdcd13d1.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_163,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>  可以通过 在提示词结尾加入“/no_think” 指令</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> text <span class="token operator">=</span> ollamaChatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"你是谁/no_think"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但是依然有<think>标签， 暂时可以前端单独处理下</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747921581411-27f379ce-ebb8-45d1-ba78-898f80b3ee50.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_28,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>ollama  0.9.0  支持了关闭think。但是在spring1.0版本还不兼容</p>
<p><a target="_blank" rel="noopener" href="https://ollama.com/blog/thinking">https://ollama.com/blog/thinking</a></p>
<h4 id="1-4-流式输出"><a href="#1-4-流式输出" class="headerlink" title="1.4. 流式输出"></a>1.4. 流式输出</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1751199935702-f444a59a-b3b5-46b3-aafe-71669d3460fb.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_86,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testStream</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

       <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">"你是谁/no_think"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 阻塞输出</span>
       stream<span class="token punctuation">.</span><span class="token function">toIterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ollama  0.8.0之前的版本不支持  stream+tools </p>
<p><a target="_blank" rel="noopener" href="https://ollama.com/blog/streaming-tool">https://ollama.com/blog/streaming-tool</a>  0.8.0+支持stream+tools .  但是和springai1.0有兼容问题：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai/issues/3369">https://github.com/spring-projects/spring-ai/issues/3369</a></p>
<p>在SpringAi 1.0.1已修复:</p>
<ul>
<li>在Ollama聊天模型响应中添加了持续时间元数据的空安全检查，以防止潜在的空指针异常<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai/commit/1eecd17529fbfc3c25d95a4324adb6fe2c302a65">1eecd17</a></li>
</ul>
<h4 id="1-5-多模态"><a href="#1-5-多模态" class="headerlink" title="1.5. 多模态"></a>1.5. 多模态</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1751201032657-afcb978c-9da7-41cf-ae95-d3eaf9732a2f.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_173,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>目前ollama支持的多模态模型：  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ollama.com/library/llama4">Meta Llama 4</a></li>
<li><a target="_blank" rel="noopener" href="https://ollama.com/library/gemma3">Google Gemma 3</a></li>
<li><a target="_blank" rel="noopener" href="https://ollama.com/library/qwen2.5vl">Qwen 2.5 VL</a></li>
<li><a target="_blank" rel="noopener" href="https://ollama.com/library/mistral-small3.1">Mistral Small 3.1</a></li>
<li>and more <a target="_blank" rel="noopener" href="https://ollama.com/search?c=vision">vision models</a>.</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 多模态  图像识别，  采用的gemma3 
 * @param ollamaChatModel
 */</span>
 <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMultimodality</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaChatModel</span> ollamaChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> imageResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"gradle.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OllamaOptions</span> ollamaOptions <span class="token operator">=</span> <span class="token class-name">OllamaOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"gemma3"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Media</span> media <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Media</span><span class="token punctuation">(</span><span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>IMAGE_PNG<span class="token punctuation">,</span> imageResource<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ChatResponse</span> response <span class="token operator">=</span> ollamaChatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Prompt</span><span class="token punctuation">(</span>
                        <span class="token class-name">UserMessage</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">media</span><span class="token punctuation">(</span>media<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"识别图片"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        ollamaOptions
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749038999303-f187d9b1-dfb1-44ae-8f47-3aef01134ca3.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_25,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="ChatClient"><a href="#ChatClient" class="headerlink" title="ChatClient"></a>ChatClient</h2><p>ChatClient 基于ChatModel进行了封装提供了通用的 API，它适用所有的大模型， 使用ChatClient可以让你面向SpringAi通用的api 而无需面向为每一种不同的模型的api来进行编程，   虽然您仍然可以使用 ChatModel 来实现某些模型更加个性化的操作（ChatModel更偏向于底层），但 ChatClient 提供了灵活、更全面的方法来构建您的客户端选项以与模型进行交互： 比如系统提示词、格式式化响应、聊天记忆 、tools 都更加易用和优雅，所以除非ChatClient无法实现，否则我们<strong>优先考虑用ChatClient</strong>。</p>
<p>所以我们后续基于ChatClient来进行学习应用。   基于ChatModel来学习源码，因为ChatClient底层依然还是ChatModel的封装。</p>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><ul>
<li><strong>必须通过ChatClient.Builder 来进行构造</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClientTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatClient</span><span class="token punctuation">(</span><span class="token class-name">ChatClient<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这种方式会在底层自动注入1个<code>ChatModel </code>， 如果你配置了多个模型依赖，  会无法注入。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748589278091-50435556-59e5-4967-8bba-c7aded90781a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_39,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>可以通过这种方式动态选择ChatModel：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClientTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                                    <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="流式"><a href="#流式" class="headerlink" title="流式"></a>流式</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 阻塞输出</span>
        content<span class="token punctuation">.</span><span class="token function">toIterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="《多个模型动态切管理实战》"><a href="#《多个模型动态切管理实战》" class="headerlink" title="《多个模型动态切管理实战》"></a>《多个模型动态切管理实战》</h2><p>1）application.properties</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># DeepSeek 配置</span>
<span class="token attr-name">spring.ai.deepseek.chat.api-key</span><span class="token punctuation">=</span><span class="token attr-value">你的APIKey</span>
<span class="token attr-name">spring.ai.deepseek.chat.options.model</span><span class="token punctuation">=</span><span class="token attr-value">deepseek-chat</span>

<span class="token comment"># Ollama 配置，模型暂定qwen3:4b已拉取到本地</span>
<span class="token attr-name">spring.ai.ollama.chat.base-url</span><span class="token punctuation">=</span><span class="token attr-value">http://localhost:11434</span>
<span class="token attr-name">spring.ai.ollama.chat.options.model</span><span class="token punctuation">=</span><span class="token attr-value">qwen3:4b</span>
<span class="token attr-name">&lt;!--</span> <span class="token attr-value">DeepSeek --></span>
 &lt;dependency>
    &lt;groupId>org.springframework.ai&lt;/groupId>
    &lt;artifactId>spring-ai-starter-model-deepseek&lt;/artifactId>
&lt;/dependency>
<span class="token attr-name">&lt;!--</span> <span class="token attr-value">Ollama --></span>
&lt;dependency>
    &lt;groupId>org.springframework.ai&lt;/groupId>
    &lt;artifactId>spring-ai-starter-model-ollama&lt;/artifactId>
&lt;/dependency><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>定义3个ChatClient的bean。  也可以根据请求动态创建， 看需求</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 公众号：程序员徐庶
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AiConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span> <span class="token function">deepseekR1</span><span class="token punctuation">(</span><span class="token class-name">DeepSeekChatProperties</span> chatProperties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">DeepSeekApi</span> deepSeekApi <span class="token operator">=</span> <span class="token class-name">DeepSeekApi</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiKey</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"DEEP_SEEK_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">DeepSeekChatModel</span> deepSeekChatModel <span class="token operator">=</span> <span class="token class-name">DeepSeekChatModel</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deepSeekApi</span><span class="token punctuation">(</span>deepSeekApi<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultOptions</span><span class="token punctuation">(</span><span class="token class-name">DeepSeekChatOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token class-name">DeepSeekApi<span class="token punctuation">.</span>ChatModel</span><span class="token punctuation">.</span>DEEPSEEK_REASONER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>deepSeekChatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span> <span class="token function">deepseekV3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">DeepSeekApi</span> deepSeekApi <span class="token operator">=</span> <span class="token class-name">DeepSeekApi</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiKey</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"DEEP_SEEK_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">DeepSeekChatModel</span> deepSeekChatModel <span class="token operator">=</span> <span class="token class-name">DeepSeekChatModel</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deepSeekApi</span><span class="token punctuation">(</span>deepSeekApi<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultOptions</span><span class="token punctuation">(</span>
                        <span class="token class-name">DeepSeekChatOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token class-name">DeepSeekApi<span class="token punctuation">.</span>ChatModel</span><span class="token punctuation">.</span>DEEPSEEK_CHAT<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>deepSeekChatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span> <span class="token function">ollama</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaApi</span> ollamaApi<span class="token punctuation">,</span> <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaChatProperties</span> options<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">OllamaChatModel</span> ollamaChatModel <span class="token operator">=</span> <span class="token class-name">OllamaChatModel</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ollamaApi</span><span class="token punctuation">(</span>ollamaApi<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultOptions</span><span class="token punctuation">(</span><span class="token class-name">OllamaOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>ollamaChatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>请求：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiModelsController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ChatClient</span><span class="token punctuation">></span></span> chatClientMap<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/chat"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">generation</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> model<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> chatClientMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="提示词"><a href="#提示词" class="headerlink" title="提示词"></a>提示词</h2><p>在生成式人工智能中，创建提示对于开发人员来说是一项至关重要的任务。这些提示的质量和结构会显著影响人工智能输出的有效性。投入时间和精力设计周到的提示可以显著提升人工智能的成果。</p>
<p>例如，一项重要的研究表明，以“深呼吸，一步一步解决这个问题”作为提示开头，可以显著提高解决问题的效率。这凸显了精心选择的语言对生成式人工智能系统性能的影响。</p>
<h3 id="提示词类型："><a href="#提示词类型：" class="headerlink" title="提示词类型："></a>提示词类型：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">MessageType</span> <span class="token punctuation">&#123;</span>

	<span class="token function">USER</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>		<span class="token comment">// 用户（显示）</span>

	<span class="token function">ASSISTANT</span><span class="token punctuation">(</span><span class="token string">"assistant"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// AI回复</span>

	<span class="token function">SYSTEM</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// 系统 （隐式）</span>

	<span class="token function">TOOL</span><span class="token punctuation">(</span><span class="token string">"tool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 工具</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>SYSTEM****系统角色</strong>：引导AI的行为和响应方式，设置AI如何解释和回复输入的参数或规则。这类似于在发起对话之前向AI提供指令。</li>
<li><strong>USER****用户角色</strong>：代表用户的输入——他们向AI提出的问题、命令或语句。这个角色至关重要，因为它构成了AI响应的基础。</li>
<li><strong>ASSISTANT助手角色</strong>：AI 对用户输入的响应。它不仅仅是一个答案或反应，对于维持对话的流畅性至关重要。通过追踪 AI 之前的响应（其“助手角色”消息），系统可以确保交互的连贯性以及与上下文的相关性。助手消息也可能包含功能工具调用请求信息。它就像 AI 中的一项特殊功能，在需要执行特定功能（例如计算、获取数据或其他不仅仅是对话的任务）时使用。</li>
<li><strong>TOOL工具/功能角色</strong>：工具/功能角色专注于响应工具调用助手消息返回附加信息。</li>
</ul>
<h3 id="提示词模板："><a href="#提示词模板：" class="headerlink" title="提示词模板："></a>提示词模板：</h3><p>有时候， 提示词里面的内容不能写死， 需要根据对话动态传入</p>
<h4 id="chatModel"><a href="#chatModel" class="headerlink" title="chatModel $"></a>chatModel $</h4><p>可以使用SystemPromptTemplate  </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> userText <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
    请告诉我三位著名的海盗，他们的黄金时代和他们的动机。
    每位海盗至少写一句话。
    """</span><span class="token punctuation">;</span>

<span class="token class-name">Message</span> userMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserMessage</span><span class="token punctuation">(</span>userText<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> systemText <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
  你是一个友好的 AI 助手，帮助人们寻找信息。
  你的名字是 &#123;name&#125;。
  你应该用你的名字回复用户的请求，并以一种 &#123;voice&#125; 的风格进行回复。
  """</span><span class="token punctuation">;</span>

<span class="token class-name">SystemPromptTemplate</span> systemPromptTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemPromptTemplate</span><span class="token punctuation">(</span>systemText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Message</span> systemMessage <span class="token operator">=</span> systemPromptTemplate<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">"voice"</span><span class="token punctuation">,</span> voice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Prompt</span> prompt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Prompt</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>userMessage<span class="token punctuation">,</span> systemMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Generation</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="chatClient"><a href="#chatClient" class="headerlink" title="chatClient"></a>chatClient</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> answer <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u
            <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"告诉我5部&#123;composer&#125;的电影."</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"composer"</span><span class="token punctuation">,</span> <span class="token string">"周星驰"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><h3 id="自定义提示词模板"><a href="#自定义提示词模板" class="headerlink" title="自定义提示词模板"></a>自定义提示词模板</h3><h4 id="chatModel-1"><a href="#chatModel-1" class="headerlink" title="chatModel $"></a>chatModel $</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PromptTemplate</span> promptTemplate <span class="token operator">=</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">renderer</span><span class="token punctuation">(</span><span class="token class-name">StTemplateRenderer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startDelimiterToken</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endDelimiterToken</span><span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
            告诉我5部&lt;composer>的电影.
            """</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> prompt <span class="token operator">=</span> promptTemplate<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"composer"</span><span class="token punctuation">,</span> <span class="token string">"John Williams"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="chatClient-1"><a href="#chatClient-1" class="headerlink" title="chatClient"></a>chatClient</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> answer <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u
            <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"告诉我5部&lt;composer>的电影"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"composer"</span><span class="token punctuation">,</span> <span class="token string">"John Williams"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">templateRenderer</span><span class="token punctuation">(</span><span class="token class-name">StTemplateRenderer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startDelimiterToken</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endDelimiterToken</span><span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="提示词模板文件"><a href="#提示词模板文件" class="headerlink" title="提示词模板文件"></a>提示词模板文件</h3><h4 id="chatModel-2"><a href="#chatModel-2" class="headerlink" title="chatModel $"></a>chatModel $</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:/prompts/system-message.st"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Resource</span> systemResource<span class="token punctuation">;</span>

<span class="token class-name">SystemPromptTemplate</span> systemPromptTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemPromptTemplate</span><span class="token punctuation">(</span>systemResource<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="chatClient-2"><a href="#chatClient-2" class="headerlink" title="chatClient"></a>chatClient</h4><p>/prompts/system-message.st</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">告诉我5部&#123;composer&#125;的电影<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPrompt</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">,</span>
                       <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:/prompts/system-message.st"</span><span class="token punctuation">)</span>
                       <span class="token class-name">Resource</span> systemResource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ChatClient</span>  chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">defaultSystem</span><span class="token punctuation">(</span>systemResource<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"composer"</span><span class="token punctuation">,</span><span class="token string">"周星驰"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="提示词设置技巧"><a href="#提示词设置技巧" class="headerlink" title="提示词设置技巧 $"></a>提示词设置技巧 $</h3><h4 id="简单技巧"><a href="#简单技巧" class="headerlink" title="简单技巧"></a>简单技巧</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/introduction/examples.en#text-summarization"><strong>文本摘要</strong></a>：<br>将大量文本缩减为简洁的摘要，捕捉关键点和主要思想，同时省略不太重要的细节。</li>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/introduction/examples.en#question-answering"><strong>问答</strong></a>：<br>专注于根据用户提出的问题，从提供的文本中获取具体答案。它旨在精准定位并提取相关信息以响应查询。</li>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/introduction/examples.en#text-classification"><strong>文本分类</strong></a>：<br>系统地将文本分类到预定义的类别或组中，分析文本并根据其内容将其分配到最合适的类别。</li>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/introduction/examples.en#conversation"><strong>对话</strong></a>：<br>创建交互式对话，让人工智能可以与用户进行来回交流，模拟自然的对话流程。</li>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/introduction/examples.en#code-generation"><strong>代码生成</strong></a>：<br>根据特定的用户要求或描述生成功能代码片段，将自然语言指令转换为可执行代码。</li>
</ul>
<h4 id="高级技术"><a href="#高级技术" class="headerlink" title="高级技术"></a>高级技术</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/techniques/zeroshot"><strong>零样本</strong></a><strong>、</strong><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/techniques/fewshot"><strong>少样本学习</strong></a>：<br>使模型能够利用特定问题类型的极少或没有先前的示例做出准确的预测或响应，并使用学习到的概括来理解和执行新任务。</li>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/techniques/cot"><strong>思路链</strong></a>：<br>将多个AI响应连接起来，创建连贯且符合语境的对话。它帮助AI保持讨论的线索，确保相关性和连续性。</li>
<li><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/techniques/react"><strong>ReAct（推理 + 行动）</strong></a>：<br>在这种方法中，人工智能首先分析输入（推理），然后确定最合适的行动或响应方案。它将理解与决策结合在一起。</li>
</ul>
<h4 id="Microsoft-指导"><a href="#Microsoft-指导" class="headerlink" title="Microsoft 指导"></a>Microsoft 指导</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/guidance"><strong>提示创建和优化框架</strong></a>：<br>微软提供了一种结构化的方法来开发和完善提示。该框架指导用户创建有效的提示，以便从 AI 模型中获取所需的响应，并优化交互以提高清晰度和效率。</li>
</ul>
<ol>
<li><p><strong>指令明确</strong></p>
</li>
<li><ol>
<li>避免情绪化内容</li>
</ol>
</li>
<li><ol>
<li><ol>
<li>“求求你好好说啊<del>！”“你这样我不会啊</del>”</li>
</ol>
</li>
</ol>
</li>
<li><ol>
<li>不要让大模型去猜去臆想你的想法， 描述足够清楚</li>
</ol>
</li>
<li><ol>
<li><ol>
<li>补充必要背景信息：身份、场景、用途、已有内容等，避免 AI “脑补” 出错。</li>
<li>避免“或许、可能、你懂的”等模糊修饰语 </li>
</ol>
</li>
</ol>
</li>
<li><ol>
<li>把大模型当一个小学生，你描述的任务越清楚他执行越具体<br>❌ 模糊：写一篇文章<br>✅ 清晰：写一篇 800 字的高考作文，主题 “坚持与创新”，结构分引言、三个论点（每个配历史案例）、结论，语言风格正式书面</li>
</ol>
</li>
<li><p><strong>格式清晰（结构化）</strong><br> 可以通关markdown格式，确定一级标题、二级标题、列表 这样更利于模型理解。后续维也更加清晰</p>
</li>
</ol>
<p>公式：「角色设定」+「具体任务（技能）」+「限制条件（约束）」+「示例参考」</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"># 角色
你是一位热情、专业的导游，熟悉各种旅游目的地的风土人情和景点信息。你的任务是根据用户的需求，为他们规划一条合理且有趣的旅游路线。

## 技能
### 技能<span class="token number">1</span>：理解客户需求
<span class="token operator">-</span> 询问并了解用户的旅行偏好，包括但不限于目的地、预算、出行日期、活动偏好等信息。
<span class="token operator">-</span> 根据用户的需求，提供个性化的旅游建议。

### 技能<span class="token number">2</span>：规划旅游路线
<span class="token operator">-</span> 结合用户的旅行偏好，设计一条详细的旅游路线，包括行程安排、交通方式、住宿建议、餐饮推荐等。
<span class="token operator">-</span> 提供每个景点的详细介绍，包括历史背景、特色活动、最佳游览时间等。

### 技能<span class="token number">3</span>：提供实用旅行建议
<span class="token operator">-</span> 给出旅行中的实用建议，如必备物品清单、当地风俗习惯、安全提示等。
<span class="token operator">-</span> 回答用户关于旅行的各种问题，例如签证、保险、货币兑换等。
<span class="token operator">-</span> 如果有不确定的地方，可以调用搜索工具来获取相关信息。

## 限制
<span class="token operator">-</span> 只讨论与旅行相关的话题。
<span class="token operator">-</span> 确保所有推荐都基于客户的旅行需求。
<span class="token operator">-</span> 不得提供任何引导客户参与非法活动的建议。
<span class="token operator">-</span> 所提供的价格均为预估，可能会受到季节等因素的影响。
<span class="token operator">-</span> 不提供预订服务，只提供旅行建议和信息。
# 知识库
请记住以下材料，他们可能对回答问题有帮助。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="Advisor对话拦截"><a href="#Advisor对话拦截" class="headerlink" title="Advisor对话拦截"></a>Advisor对话拦截</h2><p>Spring AI 利用面向切面的思想提供 Advisors API ， 它提供了灵活而强大的方法来拦截、修改和增强 Spring 应用程序中的 AI 驱动交互。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748595841228-a2cc26e0-025d-4795-b9d5-acc8aa14ce12.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_13,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><code>Advisor </code>接口提供了<code>CallAdvisor</code>和组成<code>CallAdvisorChain</code>（适用于非流式场景），以及<code>StreamAdvisor</code>和 （<code>StreamAdvisorChain</code>适用于流式场景）。它还包括<code>ChatClientRequest</code>，用于表示未密封的 Prompt 请求，以及 ，<code>ChatClientResponse</code>用于表示聊天完成响应。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/jpeg/22309163/1748596397995-c75e2484-0562-4e76-94e5-785c48fa3da9.jpeg?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_56,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="日志拦截："><a href="#日志拦截：" class="headerlink" title="日志拦截："></a>日志拦截：</h3><p>由于整个对话过程是一个“黑盒”， 不利于我们调试， 可以通过SimpleLoggerAdvisor拦截对话记录可以帮助观察我们发了什么信息给大模型便于调试。</p>
<ol>
<li>设置defaultAdvisors</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdvisorTest</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">SimpleLoggerAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>设置日志级别</li>
</ol>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">logging.level.org.springframework.ai.chat.client.advisor</span><span class="token punctuation">=</span><span class="token attr-value">DEBUG</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>日志中就记录了<br>request:  请求的日志信息</p>
<p>response: 响应的信息</p>
<h3 id="自定义拦截："><a href="#自定义拦截：" class="headerlink" title="自定义拦截："></a>自定义拦截：</h3><h4 id="重读（Re2）"><a href="#重读（Re2）" class="headerlink" title="重读（Re2）"></a>重读（Re2）</h4><p> 重读策略的核心在于让LLMs重新审视输入问题，这借鉴了人类解决问题的思维方式。通过这种方式，LLMs能够更深入地理解问题，发现复杂的模式，从而在各种推理任务中表现得更加强大。</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties">&#123;Input_Query&#125;
再次阅读问题：&#123;Input_Query&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>







<p>可以基于BaseAdvisor来实现自定义Advisor， 他实现了重复的代码 提供 模板方法让我们可以专注自己业务编写即可。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 公众号：程序员徐庶
 */</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReReadingAdvisor</span> <span class="token keyword">implements</span> <span class="token class-name">BaseAdvisor</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_USER_TEXT_ADVISE <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
      &#123;re2_input_query&#125;
      Read the question again: &#123;re2_input_query&#125;
      """</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">ChatClientRequest</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ChatClientRequest</span> chatClientRequest<span class="token punctuation">,</span> <span class="token class-name">AdvisorChain</span> advisorChain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 获得用户输入文本</span>
		<span class="token class-name">String</span> inputQuery <span class="token operator">=</span> chatClientRequest<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 定义重复输入模版</span>
		<span class="token class-name">String</span> augmentedSystemText <span class="token operator">=</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>DEFAULT_USER_TEXT_ADVISE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"re2_input_query"</span><span class="token punctuation">,</span> inputQuery<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 设置请求的提示词</span>
		<span class="token class-name">ChatClientRequest</span> processedChatClientRequest <span class="token operator">=</span>
				<span class="token comment">// 不保留</span>
				<span class="token class-name">ChatClientRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token class-name">Prompt</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span>augmentedSystemText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> processedChatClientRequest<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">ChatClientResponse</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ChatClientResponse</span> chatClientResponse<span class="token punctuation">,</span> <span class="token class-name">AdvisorChain</span> advisorChain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//我们不做任何处理</span>
		<span class="token keyword">return</span> chatClientResponse<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>测试：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdvisorTest</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">SimpleLoggerAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"中国有多大？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReReadingAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1751620554294-e45fc2f1-68ab-4551-ae10-bfdd21d3891a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_13,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><strong>记住！</strong>   <img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748870548847-b2868cb2-027b-42f0-b0bf-42a21bf462d2.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_9,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>dvisor只有结合ChatClient才能用！   是SpringAi上层提供的。  模型底层并没有这个东西</p>
<h2 id="对话记忆-1"><a href="#对话记忆-1" class="headerlink" title="对话记忆"></a>对话记忆</h2><p>大型语言模型 (LLM) 是无状态的，这意味着它们不会保留先前交互的信息。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫徐庶 "</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫什么 ？"</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748870080223-31727dfd-e598-4a56-8d4a-de362b0d82e8.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_32,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>那我们平常跟一些大模型聊天是怎么记住我们对话的呢？实际上，每次对话都需要将之前的对话消息内置发送给大模型，这种方式称为多轮对话。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748870240621-6c24ff74-035a-426e-bd0f-a5e60e5c15f4.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_33,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>SpringAi提供了一个<code>ChatMemory</code>的组件用于存储聊天记录，允许您使用 LLM 跨多个交互存储和检索信息。并且可以为不同用户的多个交互之间维护上下文或状态。</p>
<p>可以在每次对话的时候把当前聊天信息和模型的响应存储到ChatMemory， 然后下一次对话把聊天记录取出来再发给大模型。  </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">`

<span class="token comment">//输出 名字叫徐庶</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但是这样做未免太麻烦！ 能不能简化？ 思考一下！<img src="https://cdn.nlark.com/yuque/0/2025/jpeg/22309163/1748870288123-c016b85f-a5cf-4771-9291-0c18b3ae205b.jpeg?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_11,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/gif/22309163/1748870322552-35a0ab03-ea1f-46c7-9c32-21ebb241dbad.gif" alt="img">用我们之前的Advisor对话拦截是不是就可以不用每次手动去维护了。  并且SpringAi早已体贴的为我提供了<code>ChatMemoryAutoConfiguration</code>自动配置类</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-autoconfigure-model-chat-memory<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
@AutoConfiguration
@ConditionalOnClass(&#123; ChatMemory.class, ChatMemoryRepository.class &#125;)
public class ChatMemoryAutoConfiguration &#123;

	@Bean
	@ConditionalOnMissingBean
	ChatMemoryRepository chatMemoryRepository() &#123;
		return new InMemoryChatMemoryRepository();
	&#125;

	@Bean
	@ConditionalOnMissingBean
	ChatMemory chatMemory(ChatMemoryRepository chatMemoryRepository) &#123;
		return MessageWindowChatMemory.builder().chatMemoryRepository(chatMemoryRepository).build();
	&#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>所以我们可以这样用：</p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>SpringAi提供了  <code>PromptChatMemoryAdvisor</code>   专门用于对话记忆的拦截</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatMemoryTest</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">ChatMemory</span> chatMemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                        <span class="token class-name">PromptChatMemoryAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatMemory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫徐庶 ？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReReadingAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫什么 ？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReReadingAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="配置聊天记录最大存储数量"><a href="#配置聊天记录最大存储数量" class="headerlink" title="配置聊天记录最大存储数量"></a>配置聊天记录最大存储数量</h3><p>你要知道， 我们把聊天记录发给大模型， 都是算token计数的。</p>
<p>大模型的token是有上限了，  如果你发送过多聊天记录，可能就会导致token过长。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748871034319-bcb8f5e9-b1bb-431e-8776-f54d93d6ff85.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_21,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>并且更多的token也意味更多的费用， 更久的解析时间.  所以不建议太长</p>
<p>（DEFAULT_MAX_MESSAGES默认20即10次对话）</p>
<p>  一旦超出DEFAULT_MAX_MESSAGES只会存最后面N条（可以理解为先进先出），参考<code>MessageWindowChatMemory</code>源码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">ChatMemory</span> <span class="token function">chatMemory</span><span class="token punctuation">(</span><span class="token class-name">ChatMemoryRepository</span> chatMemoryRepository<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">return</span> <span class="token class-name">MessageWindowChatMemory</span>
             <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">maxMessages</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">chatMemoryRepository</span><span class="token punctuation">(</span>chatMemoryRepository<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="配置多用户隔离记忆"><a href="#配置多用户隔离记忆" class="headerlink" title="配置多用户隔离记忆"></a>配置多用户隔离记忆</h3><p>如果有多个用户在进行对话， 肯定不能将对话记录混在一起， 不同的用户的对话记忆需要隔离</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫徐庶 ？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>advisorSpec <span class="token operator">-></span> advisorSpec<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token class-name">ChatMemory</span><span class="token punctuation">.</span>CONVERSATION_ID<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫什么 ？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>advisorSpec <span class="token operator">-></span> advisorSpec<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token class-name">ChatMemory</span><span class="token punctuation">.</span>CONVERSATION_ID<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫什么 ？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>advisorSpec <span class="token operator">-></span> advisorSpec<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token class-name">ChatMemory</span><span class="token punctuation">.</span>CONVERSATION_ID<span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>会发现， 不同的CONVERSATION_ID，会有不同的记忆</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748871907406-385208ea-02bf-40d8-ab33-48ee834f59a4.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="原理源码"><a href="#原理源码" class="headerlink" title="原理源码$"></a>原理源码$</h3><p>主要有前置存储</p>
<pre class="line-numbers language-none"><code class="language-none">MessageWindowChatMemory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>具体存储实现</p>
<pre class="line-numbers language-none"><code class="language-none">ChatMemoryRepository<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748936717843-1c2d02a4-1b8a-4e14-89c8-e6809b240893.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="数据库存储对话记忆"><a href="#数据库存储对话记忆" class="headerlink" title="数据库存储对话记忆"></a>数据库存储对话记忆</h3><p>默认情况， 对话内容会存在jvm内存会导致：</p>
<ol>
<li>一直存最终会撑爆JVM导致OOM。</li>
<li>重启就丢了， 如果已想存储到第三方存储进行持久化</li>
</ol>
<p>springAi内置提供了以下几种方式（例如 Cassandra、JDBC 或 Neo4j）， 这里演示下JDBC方式</p>
<ol>
<li>添加依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-starter-model-chat-memory-repository-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--jdbc--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>


<span class="token comment">&lt;!--mysql驱动--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ol>
<li>添加配置</li>
</ol>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.ai.chat.memory.repository.jdbc.initialize-schema</span><span class="token punctuation">=</span><span class="token attr-value">always</span>
<span class="token attr-name">spring.ai.chat.memory.repository.jdbc.schema</span><span class="token punctuation">=</span><span class="token attr-value">classpath:/schema-mysql.sql</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/springai<span class="token punctuation">?</span>characterEncoding=utf8<span class="token important">&amp;useSSL=false&amp;serverTimezone=UTC&amp;</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>配置类</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatMemoryConfig</span> <span class="token punctuation">&#123;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">ChatMemory</span> <span class="token function">chatMemory</span><span class="token punctuation">(</span><span class="token class-name">JdbcChatMemoryRepository</span> chatMemoryRepository<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">MessageWindowChatMemory</span>
        <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">maxMessages</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">chatMemoryRepository</span><span class="token punctuation">(</span>chatMemoryRepository<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>resources/schema-mysql.sql（目前1.0.0版本需要自己定义，没有提供脚本）</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CREATE TABLE IF NOT <span class="token class-name">EXISTS</span> SPRING_AI_CHAT_MEMORY <span class="token punctuation">(</span>
    `conversation_id` <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    `content` TEXT <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    `type` <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    `timestamp` TIMESTAMP <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>

    INDEX `SPRING_AI_CHAT_MEMORY_CONVERSATION_ID_TIMESTAMP_IDX` <span class="token punctuation">(</span>`conversation_id`<span class="token punctuation">,</span> `timestamp`<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ol>
<li>测试</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatMemoryTest</span> <span class="token punctuation">&#123;</span>


    <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">DeepSeekChatModel</span> chatModel<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">ChatMemory</span> chatMemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                        <span class="token class-name">PromptChatMemoryAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatMemory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"你好，我叫徐庶！"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReReadingAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>advisorSpec <span class="token operator">-></span> advisorSpec<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token class-name">ChatMemory</span><span class="token punctuation">.</span>CONVERSATION_ID<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"我叫什么 ？"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReReadingAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>advisorSpec <span class="token operator">-></span> advisorSpec<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token class-name">ChatMemory</span><span class="token punctuation">.</span>CONVERSATION_ID<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到由于我设置<code>.maxMessages(1)</code>数据库只存一条</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1748937116139-c2400662-b5af-4f98-8c37-cce47407912a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_42,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="Redis存储"><a href="#Redis存储" class="headerlink" title="Redis存储"></a>Redis存储</h3><p>如果你想用redis ， 你需要自己实现ChatMemoryRepository接口（自己实现增、删、查）</p>
<p>但是alibaba-ai有现成的实现：（还包括ES）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-ai-alibaba/tree/main/community/memories">https://github.com/alibaba/spring-ai-alibaba/tree/main/community/memories</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>jedis<span class="token punctuation">.</span>version<span class="token punctuation">></span></span><span class="token number">5.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>jedis<span class="token punctuation">.</span>version<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">></span>

<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>ai<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>ai<span class="token operator">-</span>alibaba<span class="token operator">-</span>starter<span class="token operator">-</span>memory<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>


    <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>redis<span class="token punctuation">.</span>clients<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>jedis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span>$<span class="token punctuation">&#123;</span>jedis<span class="token punctuation">.</span>version<span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
spring<span class="token operator">:</span>
  ai<span class="token operator">:</span>
    memory<span class="token operator">:</span>
      redis<span class="token operator">:</span>
        host<span class="token operator">:</span> localhost
        port<span class="token operator">:</span> <span class="token number">6379</span>
        timeout<span class="token operator">:</span>  <span class="token number">5000</span>
        password<span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisMemoryConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.ai.memory.redis.host&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> redisHost<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.ai.memory.redis.port&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> redisPort<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.ai.memory.redis.password&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> redisPassword<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.ai.memory.redis.timeout&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> redisTimeout<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisChatMemoryRepository</span> <span class="token function">redisChatMemoryRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">RedisChatMemoryRepository</span><span class="token punctuation">.</span><span class="token function">_builder_</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span>redisHost<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>redisPort<span class="token punctuation">)</span>
                <span class="token comment">// 若没有设置密码则注释该项</span>
<span class="token comment">//           .password(redisPassword)</span>
                <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>redisTimeout<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="多层次记忆架构-痛点"><a href="#多层次记忆架构-痛点" class="headerlink" title="多层次记忆架构 痛点"></a><strong>多层次记忆架构</strong> <strong>痛点</strong></h3><p>记忆多=聪明， 记忆多会触发token上限</p>
<p>要知道， 无论你用什么存储对话以及， 也只能保证服务端的存储性能。  </p>
<p>但是一旦聊天记录多了依然会超过token上限， 但是有时候我们依然希望存储更多的聊天记录，这样才能保证整个对话更像“人”。    </p>
<p><strong>多层次记忆架构（模仿人类）</strong></p>
<ul>
<li><ul>
<li><strong>近期记忆</strong>：保留在上下文窗口中的最近几轮对话，每轮对话完成后立即存储（可通过ChatMemory）；   10 条</li>
<li><strong>中期记忆</strong>：通过RAG检索的相关历史对话(每轮对话完成后，异步将对话内容转换为向量并存入向量数据库）    5条</li>
<li><strong>长期记忆</strong>：关键信息的固化总结 </li>
</ul>
</li>
<li><ul>
<li><ul>
<li><strong>方式一：定时批处理</strong></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>通过定时任务（如每天或每周）对积累的对话进行总结和提炼</li>
<li>提取关键信息、用户偏好、重要事实等 </li>
<li>批处理方式降低计算成本，适合大规模处理 </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><strong>方式二：关键点实时处理</strong></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>在对话中识别出关键信息点时立即提取并存储</li>
<li>例如，当用户明确表达偏好、提供个人信息或设置持久性指令时 </li>
<li>采用”写入触发器”机制，在特定条件下自动更新长期记忆 </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="结构化输出"><a href="#结构化输出" class="headerlink" title="结构化输出"></a>结构化输出</h2><h3 id="基础类型："><a href="#基础类型：" class="headerlink" title="基础类型："></a>基础类型：</h3><p>以Boolean为例 ， 在agent中可以用于判定用于的内容2个分支，  不同的分支走不同的逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
<span class="token annotation punctuation">@BeforeEach</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                  <span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBoolOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Boolean</span> isComplain <span class="token operator">=</span> chatClient
    <span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
            请判断用户信息是否表达了投诉意图?
            只能用 true 或 false 回答，不要输出多余内容
            """</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"你们家的快递迟迟不到,我要退货！"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分支逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isComplain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户是投诉，转接人工客服！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户不是投诉，自动流转客服机器人。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// todo 继续调用 客服ChatClient进行对话</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Pojo类型："><a href="#Pojo类型：" class="headerlink" title="Pojo类型："></a>Pojo类型：</h3><p>用购物APP应该见过复制一个地址， 自动为你填入每个输入框。  用大模型轻松完成！</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749126843402-3cca89cf-d3a8-40c6-aa95-3664d526feb9.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_11,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testEntityOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Address</span> address <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                        请从下面这条文本中提取收货信息
                        """</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"收货人：张三，电话13588888888，地址：浙江省杭州市西湖区文一西路100号8幢202室"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token class-name">Address</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> name<span class="token punctuation">,</span>        <span class="token comment">// 收件人姓名</span>
    <span class="token class-name">String</span> phone<span class="token punctuation">,</span>       <span class="token comment">// 联系电话</span>
    <span class="token class-name">String</span> province<span class="token punctuation">,</span>    <span class="token comment">// 省</span>
    <span class="token class-name">String</span> city<span class="token punctuation">,</span>        <span class="token comment">// 市</span>
    <span class="token class-name">String</span> district<span class="token punctuation">,</span>    <span class="token comment">// 区/县</span>
    <span class="token class-name">String</span> detail       <span class="token comment">// 详细地址</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/jpeg/22309163/1749126360371-0165c51c-79c1-4058-9b1e-32c75182f51d.jpeg?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_80,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><code>ChatModel</code>或者直接使用低级API：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testLowEntityOut</span><span class="token punctuation">(</span>
           <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BeanOutputConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActorsFilms</span><span class="token punctuation">></span></span> beanOutputConverter <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">BeanOutputConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">ActorsFilms</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> format <span class="token operator">=</span> beanOutputConverter<span class="token punctuation">.</span><span class="token function">getFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> actor <span class="token operator">=</span> <span class="token string">"周星驰"</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        提供5部&#123;actor&#125;导演的电影.
        &#123;format&#125;
        """</span><span class="token punctuation">;</span>

        <span class="token class-name">PromptTemplate</span> promptTemplate <span class="token operator">=</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variables</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"actor"</span><span class="token punctuation">,</span> actor<span class="token punctuation">,</span> <span class="token string">"format"</span><span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChatResponse</span> response <span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
                promptTemplate<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ActorsFilms</span> actorsFilms <span class="token operator">=</span> beanOutputConverter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>actorsFilms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="-2"><a href="#-2" class="headerlink" title=""></a></h4><h2 id="链接多个模型协调工作实战-初代tools："><a href="#链接多个模型协调工作实战-初代tools：" class="headerlink" title="链接多个模型协调工作实战 - 初代tools： $"></a>链接多个模型协调工作实战 - 初代tools： $</h2><h4 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h4><p>大模型如果它无法和企业API互联那将毫无意义！  比如我们开发一个智能票务助手，  当用户需要退票， 基础大模型它肯定做不到， 因为票务信息都存在了我们系统中， 必须通过我们系统的业务方法才能进行退票。  那怎么能让大模型“调用”我们自己系统的业务方法呢？ 今天叫大家通过结构化输入连接多个模型一起协同完成这个任务：</p>
<h4 id="票务助手"><a href="#票务助手" class="headerlink" title="票务助手"></a>票务助手<img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749133561508-8d90a71e-e734-471e-a36e-5605fabc6b8c.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></h4><h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749133770407-472b9b4b-f1a8-43f2-b3d2-86d40abb3491.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_17,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749133811144-c451d972-8ffc-4760-8b47-dfd14d4db5df.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_11,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>输入姓名和预定号：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749133789344-aab6fec6-8dd9-415f-98cc-1f77c7c45f60.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_18,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749133804610-66c41dfc-a556-49be-9353-e90eee657c20.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_21,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>普通对话：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749133832665-d12ca731-fae6-4991-8f17-cb0039a9a1ac.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AiJob</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">record</span> <span class="token class-name">Job</span><span class="token punctuation">(</span><span class="token class-name">JobType</span> jobType<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keyInfos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">JobType</span><span class="token punctuation">&#123;</span>
        CANCEL<span class="token punctuation">,</span>
        QUERY<span class="token punctuation">,</span>
        OTHER<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 公众号：程序员徐庶
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AiConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span> <span class="token function">planningChatClient</span><span class="token punctuation">(</span><span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">,</span>
                                         <span class="token class-name">DashScopeChatProperties</span> options<span class="token punctuation">,</span>
                                         <span class="token class-name">ChatMemory</span> chatMemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DashScopeChatOptions</span> dashScopeChatOptions <span class="token operator">=</span> <span class="token class-name">DashScopeChatOptions</span><span class="token punctuation">.</span><span class="token function">fromOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dashScopeChatOptions<span class="token punctuation">.</span><span class="token function">setTemperature</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span>  <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">defaultSystem</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                            # 票务助手任务拆分规则
                            ## 1.要求
                            ### 1.1 根据用户内容识别任务
                            
                            ## 2. 任务
                            ### 2.1 JobType:退票(CANCEL) 要求用户提供姓名和预定号， 或者从对话中提取；
                            ### 2.2 JobType:查票(QUERY) 要求用户提供预定号， 或者从对话中提取；
                            ### 2.3 JobType:其他(OTHER)
                            """</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                            <span class="token class-name">MessageChatMemoryAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatMemory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">defaultOptions</span><span class="token punctuation">(</span>dashScopeChatOptions<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span> <span class="token function">botChatClient</span><span class="token punctuation">(</span><span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">,</span>
                                    <span class="token class-name">DashScopeChatProperties</span> options<span class="token punctuation">,</span>
                                         <span class="token class-name">ChatMemory</span> chatMemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">DashScopeChatOptions</span> dashScopeChatOptions <span class="token operator">=</span> <span class="token class-name">DashScopeChatOptions</span><span class="token punctuation">.</span><span class="token function">fromOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dashScopeChatOptions<span class="token punctuation">.</span><span class="token function">setTemperature</span><span class="token punctuation">(</span><span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultSystem</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                           你是XS航空智能客服代理， 请以友好的语气服务用户。
                            """</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                        <span class="token class-name">MessageChatMemoryAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatMemory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultOptions</span><span class="token punctuation">(</span>dashScopeChatOptions<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiModelsController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ChatClient</span> planningChatClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ChatClient</span> botChatClient<span class="token punctuation">;</span>




    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/stream"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"text/stream;charset=UTF8"</span><span class="token punctuation">)</span>
    <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">stream</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建一个用于接收多条消息的 Sink</span>
        <span class="token class-name">Sinks<span class="token punctuation">.</span>Many</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> sink <span class="token operator">=</span> <span class="token class-name">Sinks</span><span class="token punctuation">.</span><span class="token function">many</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unicast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onBackpressureBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 推送消息</span>
        sink<span class="token punctuation">.</span><span class="token function">tryEmitNext</span><span class="token punctuation">(</span><span class="token string">"正在计划任务...&lt;br/>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AiJob<span class="token punctuation">.</span>Job</span> job <span class="token operator">=</span> planningChatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token class-name">AiJob<span class="token punctuation">.</span>Job</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">jobType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> CANCEL <span class="token operator">-></span><span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// todo.. 执行业务</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">keyInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    sink<span class="token punctuation">.</span><span class="token function">tryEmitNext</span><span class="token punctuation">(</span><span class="token string">"请输入姓名和订单号."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    sink<span class="token punctuation">.</span><span class="token function">tryEmitNext</span><span class="token punctuation">(</span><span class="token string">"退票成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">case</span> QUERY <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// todo.. 执行业务</span>
                sink<span class="token punctuation">.</span><span class="token function">tryEmitNext</span><span class="token punctuation">(</span><span class="token string">"查询预定信息：xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">case</span> OTHER <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> content <span class="token operator">=</span> botChatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                content<span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>sink<span class="token operator">::</span><span class="token function">tryEmitNext</span><span class="token punctuation">)</span> <span class="token comment">// 推送每条AI流内容</span>
                        <span class="token punctuation">.</span><span class="token function">doOnComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> sink<span class="token punctuation">.</span><span class="token function">tryEmitComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">default</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sink<span class="token punctuation">.</span><span class="token function">tryEmitNext</span><span class="token punctuation">(</span><span class="token string">"解析失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sink<span class="token punctuation">.</span><span class="token function">asFlux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="tools-function-call"><a href="#tools-function-call" class="headerlink" title="tools/function-call"></a>tools/function-call</h2><p><img src="https://cdn.nlark.com/yuque/0/2025/webp/22309163/1751958968629-336b4ca5-3ea0-4ad3-bb1a-32b5c89ba5ae.webp?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_23,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>想做企业级智能应用开发，  你肯定会有需求要让大模型和你的企业API能够互连，  </p>
<p>因为对于基础大模型来说， 他只具备通用信息，他的参数都是拿公网进行训练，并且有一定的时间延迟，  无法得知一些具体业务数据和实时数据， 这些数据往往被各软件系统存储在自己数据库中：</p>
<p>比如我问大模型：“中国有多少个叫徐庶的” 他肯定不知道，  我们就需要去调用政务系统的接口。</p>
<p>比如我现在开发一个智能票务助手，  我现在跟AI说需要退票， AI怎么做到呢？  就需要让AI调用我们自己系统的退票业务方法，进行操作数据库。</p>
<p>在之前我们可以通过链接多个模型的方式达到，  但是很麻烦，  那用tools， 可以轻松完成。</p>
<p>tool calling也可以直接叫tool（也称为function-call）, 主要用于提供大模型不具备的信息和能力：</p>
<ol>
<li><strong>信息检索：</strong>可用于从外部源（如数据库、Web 服务、文件系统或 Web 搜索引擎）检索信息。目标是增强模型的知识，使其能够回答无法回答的问题。例如，工具可用于检索给定位置的当前天气、检索最新的新闻文章或查询数据库以获取特定记录。  这也是一种检索增强方式。</li>
<li><strong>采取行动：</strong>例如发送电子邮件、在数据库中创建新记录、提交表单或触发工作流。目标是自动执行原本需要人工干预或显式编程的任务。例如，可以使用工具为与聊天机器人交互的客户预订航班，在网页上填写表单等。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749392971318-e337a759-874f-45ca-a4f1-8d61d7b05245.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_9,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img">需要使用tools必须要先保证大模型支持。   比如ollama列出了支持tool的模型</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749392917151-41ed9d80-529d-49c2-93e9-abe22b2c4b94.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_45,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1751958667763-7a8e7375-fa12-44b8-8521-b219f9ba10e3.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_35,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img">        </p>
<ol>
<li>声明tools的类:</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">class</span> <span class="token class-name">NameCountsTools</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Tool</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"长沙有多少名字的数量"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token class-name">LocationNameCounts</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@ToolParam</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"名字"</span><span class="token punctuation">)</span>
            <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"10个"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>将Tool类配置为bean（非必须）</li>
<li>@Tool 用户告诉大模型提供了什么工具</li>
<li>@ToolParam 用于告诉大模型你要用这个工具需要什么参数（非必须）</li>
</ol>
<ol>
<li>绑定到ChatClient</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ToolTest</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@Autowired</span>
                      <span class="token class-name">NameCountsTools</span> nameCountsTools<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultTools</span><span class="token punctuation">(</span>nameCountsTools<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChatOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"长沙有多少个叫徐庶的/no_think"</span><span class="token punctuation">)</span>
                <span class="token comment">// .tools() 也可以单独绑定当前对话</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749453132339-95c40010-427f-452a-8f6e-580b62b493eb.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_15,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749454119801-20e17389-b5da-4af2-a683-af5ec9ee3bd3.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_54,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li> 当我们设置了defaultTools 相当于就告诉了大模型我提供了什么工具， 你需要用我的工具必须给我什么参数， 底层实际就是将这些信息封装了json提供给大模型</li>
<li>当大模型识别到我们的对话需要用到工具， 就会响应需要调用tool</li>
</ol>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749454861533-d726d036-c384-44c7-aa9c-25d084837e79.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_170,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="tools注意事项："><a href="#tools注意事项：" class="headerlink" title="tools注意事项："></a>tools注意事项：</h3><ol>
<li><strong>参数或者返回值不支持：</strong></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1751966390991-d75eacfb-c7ae-4b5f-91fb-d3c3f3f2f0ec.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><strong>推荐</strong>：  pojo  record   java基础类型   list  map </p>
<ol>
<li><strong>Tools参数无法自动推算问题</strong></li>
</ol>
<ul>
<li><em>温度</em>（即模型随机性）太低，AI可能缺失自由度变得比较拘谨（从一定程度可以解决， 但是不推荐）</li>
<li>也可以通过描述更加明确</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Tool</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"获取指定位置天气,根据位置自动推算经纬度"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAirQuality</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ToolParam</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"纬度"</span><span class="token punctuation">)</span> <span class="token keyword">double</span> latitude<span class="token punctuation">,</span>
                              <span class="token annotation punctuation">@ToolParam</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"经度"</span><span class="token punctuation">)</span> <span class="token keyword">double</span> longitude<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">"天晴"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<ol>
<li><strong>大模型“强行适配”Tool参数的幻觉问题</strong></li>
</ol>
<ul>
<li>加严参数描述与校验</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"真实人名（必填，必须为人的真实姓名，严禁用其他信息代替；如缺失请传null）"</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>后端代码加强校验和兜底保护</li>
<li>系统Prompt设定限制</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">“严禁随意补全或猜测工具调用参数。
参数如缺失或语义不准，请不要补充或随意传递，请直接放弃本次工具调用。”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>高风险接口（如资金、风控等）tools方法<strong>加强人工确认，多走一步校验。</strong></li>
</ul>
<ol>
<li><strong>工具暴露的接口名、方法名、参数名要可读、业务化</strong></li>
</ol>
<ul>
<li>AI是“看”你的签名和注释来决定用不用工具的；</li>
<li>尽量避免乱码、缩写等。</li>
</ul>
<ol>
<li><strong>方法参数数量不宜过多</strong></li>
</ol>
<ul>
<li>建议每个工具方法尽量少于5个参数，否则AI提示会变复杂、出错率高。</li>
</ul>
<ol>
<li><strong>工具方法不适合做超耗时操作， 更长的耗时意味着用户延迟响应时间变长</strong></li>
</ol>
<p>性能优化 能异步处理就异步处理、 查询数据  redis</p>
<ol>
<li><p><strong>关于Tools的权限控制</strong></p>
</li>
<li><ol>
<li>可以利用SpringSecurity限制</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Tool</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"退票"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasRole('ADMIN')"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">cancel</span><span class="token punctuation">(</span>
        <span class="token comment">// @ToolParam告诉大模型参数的描述</span>
  <span class="token annotation punctuation">@ToolParam</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"预定号，可以是纯数字"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ticketNumber<span class="token punctuation">,</span>
  <span class="token annotation punctuation">@ToolParam</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"真实人名（必填，必须为人的真实姓名，严禁用其他信息代替；如缺失请传null）"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name
       <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 当前登录用户名</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 先查询 --->先校验</span>
    ticketService<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>ticketNumber<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> username<span class="token operator">+</span><span class="token string">"退票成功！"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><ol>
<li>将tools和权限资源一起存储， 然后动态设置tools</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">.defaultToolCallbacks(toolService.getToolCallList(toolService))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>根据当前用户读取当前用户所属角色的所有tools</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ToolCallback</span><span class="token punctuation">></span></span> <span class="token function">getToolCallList</span><span class="token punctuation">(</span><span class="token class-name">ToolService</span> toolService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">findMethod</span><span class="token punctuation">(</span><span class="token class-name">ToolService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"cancel"</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ToolDefinition</span> build <span class="token operator">=</span> <span class="token class-name">ToolDefinition</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"cancel"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"退票"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">inputSchema</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                        &#123;
                          "type": "object",
                          "properties": &#123;
                            "ticketNumber": &#123;
                              "type": "string",
                              "description": "预定号，可以是纯数字"
                            &#125;,
                            "name": &#123;
                              "type": "string",
                              "description": "真实人名"
                            &#125;
                          &#125;,
                          "required": ["ticketNumber", "name"]
                        &#125;
                        """</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ToolCallback</span> toolCallback <span class="token operator">=</span> <span class="token class-name">MethodToolCallback</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toolDefinition</span><span class="token punctuation">(</span>
                        build<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toolMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toolObject</span><span class="token punctuation">(</span>toolService<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>toolCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><strong>tools过多导致AI出现选择困难证</strong>     </li>
</ol>
<p>问题：    </p>
<ol>
<li><ol>
<li>token上限</li>
<li>选择困难证</li>
</ol>
</li>
</ol>
<p>tools的描述作用   保存  向量数据库。 </p>
<p>实现方式：</p>
<ol>
<li>把所有的tools描述信息存入到向量数据库</li>
<li>每次对话的时候根据当前对话信息检索到相似的tools（RAG）</li>
<li>然后动态设置tools </li>
</ol>
<h2 id="《智能客服项目实战》"><a href="#《智能客服项目实战》" class="headerlink" title="《智能客服项目实战》"></a><strong>《智能客服项目实战》</strong></h2><p><a target="_blank" rel="noopener" href="https://www.yuque.com/geren-t8lyq/ncgl94/yqnlrri5gavanx0f?singleDoc#"><strong>https://www.yuque.com/geren-t8lyq/ncgl94/yqnlrri5gavanx0f?singleDoc#</strong></a> <strong>《Spring AI1.0 智能航空助手项目》</strong></p>
<h3 id="项目效果："><a href="#项目效果：" class="headerlink" title="项目效果："></a>项目效果：</h3><h4 id="角色预设："><a href="#角色预设：" class="headerlink" title="角色预设："></a>角色预设：</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752411906784-7e52fb76-0f69-4224-b4ec-8217d525bea6.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_53,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="记忆对话"><a href="#记忆对话" class="headerlink" title="记忆对话"></a>记忆对话</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752412010405-7e36f066-e742-4dec-9f1a-7f608e70f8e1.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_18,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="tools-1"><a href="#tools-1" class="headerlink" title="tools"></a>tools</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752412032155-7ee5fea7-1003-42f5-9c87-951be3343f04.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_54,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="MCP-1"><a href="#MCP-1" class="headerlink" title="MCP"></a>MCP</h2><h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><ol>
<li>当有服务商需要将tools提供外部使用（比如高德地图提供了位置服务tools， 比如百度提供了联网搜索的tools…）</li>
<li> 或者在企业级中， 有多个智能应用，想将通用的tools公共化</li>
</ol>
<p>  怎么办？  </p>
<p>可以把tools单独抽取出来，  由应用程序读取外部的tools。     那关键是怎么读呢？ 怎么解析呢？  如果每个提供商各用一种规则你能想象有多麻烦！ 所以MCP就诞生了，  他指定了标准规则，  以jsonrpc2.0的方式进行通讯。 </p>
<p>那问题又来了， 以什么方式通讯呢？   http?  rpc?  stdio?      mcp提供了sse和stdio这2种方式。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749538652064-fa3cda1e-d919-4e45-999c-db97817ba693.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_55,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h3><p>Streamable http目前springai1.0版本不支持， 我们先掌握SSE和STDIO</p>
<p>分别说下STDIO和SSE的方式：</p>
<ul>
<li><strong>STDIO</strong>更适合客户端桌面应用和辅助工具</li>
<li><strong>SSE</strong>更适合web应用 、业务有关的公共tools</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749543212615-6e6d670b-73d7-4c49-aab9-6640ee8b98c8.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_28,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="STDIO"><a href="#STDIO" class="headerlink" title="STDIO"></a>STDIO</h4><h5 id="MCP-Server"><a href="#MCP-Server" class="headerlink" title="MCP Server"></a>MCP Server</h5><h6 id="现成共用MCP-Server"><a href="#现成共用MCP-Server" class="headerlink" title="现成共用MCP Server"></a>现成共用MCP Server</h6><p>现在有很多MCP 服务 给大家提供一个网站：<a target="_blank" rel="noopener" href="https://mcp.so/zh">MCP Server（MCP 服务器）</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743148612881-af22674d-a11a-4914-a3a0-eaf1f83a01aa.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_38,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>那MCP有了， 怎么调用呢？  这里介绍2种使用方式：</p>
<h6 id="自定义MCP-Server"><a href="#自定义MCP-Server" class="headerlink" title="自定义MCP Server"></a>自定义MCP Server</h6><p>创建一个springai项目</p>
<ol>
<li>依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--mcp-server  --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-starter-mcp-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
            <span class="token comment">&lt;!--springai  --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-bom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-ai.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- 打包 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ol>
<li>添加工具</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserToolService</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> userScore <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token string">"xushu"</span><span class="token punctuation">,</span><span class="token number">99.0</span><span class="token punctuation">,</span>
        <span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">,</span>
        <span class="token string">"lisi"</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Tool</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"获取用户分数"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>userScore<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> userScore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>  

        <span class="token keyword">return</span> <span class="token string">"未检索到当前用户"</span><span class="token operator">+</span>userName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>暴露工具</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ToolCallbackProvider</span> <span class="token function">weatherTools</span><span class="token punctuation">(</span><span class="token class-name">UserToolService</span> userToolService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">MethodToolCallbackProvider</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toolObjects</span><span class="token punctuation">(</span>userToolService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>配置</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">banner-mode</span><span class="token punctuation">:</span> off
  <span class="token key atrule">ai</span><span class="token punctuation">:</span>
    <span class="token key atrule">mcp</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>weather<span class="token punctuation">-</span>server
        <span class="token key atrule">version</span><span class="token punctuation">:</span> 0.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p># 注意：您必须禁用横幅和控制台日志记录，以允许 STDIO 传输!!工作  banner-mode: off</p>
<ol>
<li>打包  mvn package</li>
</ol>
<p>此时target/生成了jar则成功！</p>
<h5 id="MCP-Client"><a href="#MCP-Client" class="headerlink" title="MCP Client"></a>MCP Client</h5><h6 id="通过工具"><a href="#通过工具" class="headerlink" title="通过工具"></a>通过工具</h6><p>CherryStudio、Cursor 、Claude Desktop、<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=saoudrizwan.claude-dev">Cline </a> 等等很多， 这里不一一演示， 不会的话自己找个文章， 工具使用都很简单!</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743151169161-51d3e731-8ad4-48e3-85bc-2519460274ec.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_38,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>以Cline为例： 他是Vscode的插件</p>
<ol>
<li>安装VSCode</li>
</ol>
<ol>
<li>安装插件：</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743506292616-d840d75c-1ee7-4954-b3c1-80c472c23321.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>配置cline的模型：</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743506403789-4eedfc69-694e-4409-8b30-9711f3d5d5bb.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>配置cline的mcpserver<img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743506882142-2aa504e7-2ff4-470a-a859-ba6428ae0673.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_51,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></li>
</ol>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"mcpServers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"baidu-map"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"cmd"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/c"</span><span class="token punctuation">,</span>
                <span class="token string">"npx"</span><span class="token punctuation">,</span>
                <span class="token string">"-y"</span><span class="token punctuation">,</span>
                <span class="token string">"@baidumap/mcp-server-baidu-map"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"BAIDU_MAP_API_KEY"</span><span class="token operator">:</span> <span class="token string">"LEyBQxG9UzR9C1GZ6zDHsFDVKvBem2do"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"filesystem"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"cmd"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/c"</span><span class="token punctuation">,</span>
                <span class="token string">"npx"</span><span class="token punctuation">,</span>
                <span class="token string">"-y"</span><span class="token punctuation">,</span>
                <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span>
                <span class="token string">"C:/Users/tuling/Desktop"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"mcp-server-weather"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"java"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"-Dspring.ai.mcp.server.stdio=true"</span><span class="token punctuation">,</span>
                <span class="token string">"-Dlogging.pattern.console="</span><span class="token punctuation">,</span>
                <span class="token string">"-jar"</span><span class="token punctuation">,</span>
                <span class="token string">"D:\\ideaworkspace\\git_pull\\tuling-flight-booking_all\\mcp-stdio-server\\target\\mcp-stdio-server-xs-1.0.jar"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>开启cline权限</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743506993562-39b29cae-c7f0-4912-9d36-7ff5957347eb.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743507041841-ad6dca07-fe24-41a4-af70-fa74e5300dda.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>6.测试：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1743507165047-e40b880f-ddd3-410a-ad0d-0d300bce963a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_12,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h6 id="通过Spring-AI"><a href="#通过Spring-AI" class="headerlink" title="通过Spring AI"></a>通过Spring AI</h6><ol>
<li>依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--既支持sse\也支持Stdio--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-starter-mcp-client-webflux<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2 配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">ai</span><span class="token punctuation">:</span>
    <span class="token key atrule">mcp</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">request-timeout</span><span class="token punctuation">:</span> <span class="token number">60000</span>
        <span class="token key atrule">stdio</span><span class="token punctuation">:</span>
          <span class="token key atrule">servers-configuration</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/mcp<span class="token punctuation">-</span>servers<span class="token punctuation">-</span>config.json
          <span class="token key atrule">connections</span><span class="token punctuation">:</span>
            <span class="token key atrule">server1</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> /path/to/server
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>port=8080
                <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mode=production
              <span class="token key atrule">env</span><span class="token punctuation">:</span>
                <span class="token key atrule">API_KEY</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>api<span class="token punctuation">-</span>key
                <span class="token key atrule">DEBUG</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>mcp-servers-config.json：</li>
</ol>
<p>获取Baidu地图key: <a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/apiconsole/key">控制台 | 百度地图开放平台</a></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"mcpServers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"baidu-map"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"cmd"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/c"</span><span class="token punctuation">,</span>
                <span class="token string">"npx"</span><span class="token punctuation">,</span>
                <span class="token string">"-y"</span><span class="token punctuation">,</span>
                <span class="token string">"@baidumap/mcp-server-baidu-map"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"BAIDU_MAP_API_KEY"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"filesystem"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"cmd"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/c"</span><span class="token punctuation">,</span>
                <span class="token string">"npx"</span><span class="token punctuation">,</span>
                <span class="token string">"-y"</span><span class="token punctuation">,</span>
                <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span>
                <span class="token string">"C:/Users/tuling/Desktop"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"mcp-server-weather"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"java"</span><span class="token punctuation">,</span>
            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"-Dspring.ai.mcp.server.stdio=true"</span><span class="token punctuation">,</span>
                <span class="token string">"-Dlogging.pattern.console="</span><span class="token punctuation">,</span>
                <span class="token string">"-jar"</span><span class="token punctuation">,</span>
                <span class="token string">"D:\\xxx\\target\\mcp-stdio-server-xs-1.0.jar"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>绑定到Chatclient</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author wx:程序员徐庶
 * @version 1.0
 * @description: 智能航空助手:需要一对一解答关注wx: 程序员徐庶
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@CrossOrigin</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenAiController</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">OpenAiController</span><span class="token punctuation">(</span>
            <span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">,</span>
                            <span class="token comment">// 外部 mcp tools</span>
                            <span class="token class-name">ToolCallbackProvider</span> mcpTools<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span><span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">defaultToolCallbacks</span><span class="token punctuation">(</span>mcpTools<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    

 <span class="token annotation punctuation">@CrossOrigin</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/ai/generateStreamAsString"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>TEXT_EVENT_STREAM_VALUE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">generateStreamAsString</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"message"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"讲个笑话"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span>  content<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 调试日志</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">io</span><span class="token punctuation">:</span>
      <span class="token key atrule">modelcontextprotocol</span><span class="token punctuation">:</span>
        <span class="token key atrule">client</span><span class="token punctuation">:</span> DEBUG
        <span class="token key atrule">spec</span><span class="token punctuation">:</span> DEBUG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="-3"><a href="#-3" class="headerlink" title=""></a></h6><h4 id="SSE"><a href="#SSE" class="headerlink" title="SSE"></a>SSE</h4><h5 id="MCP-Server-1"><a href="#MCP-Server-1" class="headerlink" title="MCP Server"></a>MCP Server</h5><p>这种方式需要将部署为Web服务</p>
<ol>
<li>依赖</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>mcp服务器核心依赖— 响应式<span class="token operator">--</span><span class="token operator">></span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>ai<span class="token operator">-</span>starter<span class="token operator">-</span>mcp<span class="token operator">-</span>server<span class="token operator">-</span>webflux<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>定义外部工具</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserToolService</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> userScore <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
            <span class="token string">"xushu"</span><span class="token punctuation">,</span><span class="token number">99.0</span><span class="token punctuation">,</span>
            <span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">,</span>
            <span class="token string">"lisi"</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Tool</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"获取用户分数"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>userScore<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> userScore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token string">"未检索到当前用户"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>暴露工具</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">ToolCallbackProvider</span> <span class="token function">weatherToolCallbackProvider</span><span class="token punctuation">(</span><span class="token class-name">WeatherService</span> weatherService<span class="token punctuation">,</span>
                                                           <span class="token class-name">UserToolService</span> userToolService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token class-name">MethodToolCallbackProvider</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toolObjects</span><span class="token punctuation">(</span>userToolService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>配置</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8088</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<ol>
<li>启动</li>
</ol>
<h5 id="MCP-Client-1"><a href="#MCP-Client-1" class="headerlink" title="MCP Client"></a>MCP Client</h5><ol>
<li>添加依赖</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--既支持sse\也支持Stdio--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-ai-starter-mcp-client-webflux<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>配置</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">spring:
  ai:
    mcp:
      client:
        enabled: true
        name: my-mcp-client
        version: 1.0.0
        request-timeout: 30s
        type: ASYNC  # or SYNC
        sse:
          connections:
            server1:
              url: http://localhost:8088<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>代码</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author wx:程序员徐庶
 * @version 1.0
 * @description: 智能航空助手:需要一对一解答关注wx: 程序员徐庶
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@CrossOrigin</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenAiController</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">OpenAiController</span><span class="token punctuation">(</span>
        <span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">,</span>
        <span class="token comment">// 外部 mcp tools</span>
        <span class="token class-name">ToolCallbackProvider</span> mcpTools<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span><span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">defaultToolCallbacks</span><span class="token punctuation">(</span>mcpTools<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@CrossOrigin</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/ai/generateStreamAsString"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>TEXT_EVENT_STREAM_VALUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">generateStreamAsString</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"message"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"讲个笑话"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span>  content<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="-4"><a href="#-4" class="headerlink" title=""></a></h4><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><ol>
<li>STDIO 是基于标准输入\输出流的方式， 需要在MCP 客户端安装一个包（可以是jar包、python包、npm包等..）. 它是“客户端”的MCP Server。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752585876004-6075ff95-4059-4c69-a950-3a0c51f7a0d3.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_18,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>SSE  是基于Http的方式进行通讯， 需要将MCP Server部署为一个web服务. 它是服务端的MCP Server</li>
</ol>
<h5 id="STDIO原理"><a href="#STDIO原理" class="headerlink" title="STDIO原理"></a>STDIO原理</h5><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752591174064-97591e76-da2c-4c04-81d4-6aebe59361fd.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_16,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>很多人不理解stdio到底什么意思， 为什么一定要把stdio server的banner关掉， 还要清空控制台？</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749543942465-684dee68-7d74-4a28-aa11-914d178dd9e2.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_98,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li><p>首先SpringAi底层会读取到mcp-servers-config.json的信息</p>
</li>
<li><p>然后执行命令（其实聪明的小伙伴早就发现了，mcp-servers-config.json文件中就是一堆shell命令）</p>
</li>
<li><ol>
<li>怎么执行？  熟悉java的同学应该知道，java里面有一个对象用于执行命令：</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ProcessBuilder</span> processBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       processBuilder<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">"java"</span><span class="token punctuation">,</span><span class="token string">"-version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Process</span> process <span class="token operator">=</span> processBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       process<span class="token punctuation">.</span><span class="token function">errorReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>所以springAi底层相当于读取到信息后， 会通过processBuilder去执行命令</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> commands<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"java"</span><span class="token punctuation">,</span>
                <span class="token string">"-Dspring.ai.mcp.server.stdio=true"</span><span class="token punctuation">,</span>
                <span class="token string">"-Dlogging.pattern.console="</span><span class="token punctuation">,</span>
                <span class="token string">"-jar"</span><span class="token punctuation">,</span>
                <span class="token string">"D:\\ideaworkspace\\git_pull\\tuling-flight-booking_all\\mcp-stdio-server\\target\\mcp-stdio-server-xs-1.0.jar"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token class-name">ProcessBuilder</span> processBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        processBuilder<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// processBuilder.environment().put("username","xushu");</span>

        <span class="token class-name">Process</span> process <span class="token operator">=</span> processBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>其实你也完全可以自己通过mcd去执行命令</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749544393733-af10cef8-2d9d-4fb9-a14b-1b61761afcda.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_54,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li>运行jar -jar mcp-stdio-server.jar</li>
<li>输入{“jsonrpc”:”2.0”,”method”:”tools/list”,”id”:”3b3f3431-1”,”params”:{}}</li>
<li>输出tools列表</li>
</ol>
<p>这就是标准输入输出流!    看到这里你应该知道， 为什么需要<code>-Dlogging.pattern.console=</code>  完全是为了清空控制台，才能读取信息!</p>
<p>所以利用java也是一样的原理：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> commands<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"java"</span><span class="token punctuation">,</span>
                <span class="token string">"-Dspring.ai.mcp.server.stdio=true"</span><span class="token punctuation">,</span>
                <span class="token string">"-Dlogging.pattern.console="</span><span class="token punctuation">,</span>
                <span class="token string">"-jar"</span><span class="token punctuation">,</span>
                <span class="token string">"D:\\ideaworkspace\\git_pull\\tuling-flight-booking_all\\mcp-stdio-server\\target\\mcp-stdio-server-xs-1.0.jar"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token class-name">ProcessBuilder</span> processBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        processBuilder<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">;</span>
        processBuilder<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"xushu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Process</span> process <span class="token operator">=</span> processBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedReader</span> processReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> line<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token operator">=</span>processReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//String jsonMessage="&#123;\"jsonrpc\":\"2.0\",\"method\":\"initialize\",\"id\":\"3670122a-0\",\"params\":&#123;\"protocolVersion\":\"2024-11-05\",\"capabilities\":&#123;&#125;,\"clientInfo\":&#123;\"name\":\"spring-ai-mcp-client\",\"version\":\"1.0.0\"&#125;&#125;&#125;";</span>
                <span class="token class-name">String</span> jsonMessage <span class="token operator">=</span> <span class="token string">"&#123;\"jsonrpc\":\"2.0\",\"method\":\"tools/list\",\"id\":\"3b3f3431-1\",\"params\":&#123;&#125;&#125;"</span><span class="token punctuation">;</span>

                jsonMessage <span class="token operator">=</span> jsonMessage<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">var</span> os <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>os<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>jsonMessage<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    os<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写入完成！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*JSONRPCRequest[jsonrpc=2.0, method=initialize, id=5d83d0d1-0, params=InitializeRequest[protocolVersion=2024-11-05, capabilities=ClientCapabilities[experimental=null, roots=null, sampling=null],
        clientInfo=Implementation[name=spring-ai-mcp-client, version=1.0.0]]]*/</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>通过ProcessBuilder执行命令</li>
<li>通过子线程轮询 process.getInputStream 获取输出流</li>
<li>通过process.getOutputStream(); 进行写入流</li>
</ol>
<p>所以整个过程是这样的：再回顾上面的图</p>
<p>启动程序—&gt;读取mcpjson—&gt;通过ProcessBuilder启动命令—&gt; 写入初始化jsonrpc—-&gt;写入获取tools列表jsonrpc—-&gt;请求大模型（携带tools）—-&gt;写入请求外部tool的jsonrpc—-&gt;获取数据—&gt;发送给大模型—-&gt;响应。</p>
<h4 id="STDIO源码"><a href="#STDIO源码" class="headerlink" title="STDIO源码"></a>STDIO源码</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749543994705-06c671de-1be4-4d18-838f-2148c7eac45d.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_96,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="MCP鉴权"><a href="#MCP鉴权" class="headerlink" title="MCP鉴权"></a>MCP鉴权</h4><p>在做MCP企业级方案落地时， 我们可能不想让没有权限的人访问MCP Server,  或者需要根据不同的用户返回不同的数据， 这里就涉及到MCP Server授权操作。</p>
<p>那MCP Server有2种传输方式，  实现起来不一样：</p>
<h5 id="STDIO-1"><a href="#STDIO-1" class="headerlink" title="STDIO"></a>STDIO</h5><p>这种方式在本地运行,<strong>它 将MCP Server作为子进程启动</strong>。 我们称为标准输入输出， 其实就是利用运行命令的方式写入和读取控制台的信息，以达到传输。  </p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747376380238-74bfcf1f-4ed0-41f2-ac6a-39cdf3b54fd1.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p> 通常我们会配置一段json，比如这里的百度地图MCP Server ：</p>
<ul>
<li>其中command和args代表运行的命令和参数。</li>
<li>其实env中的节点BAIDU_MAP_API_KEY就是做授权的。</li>
</ul>
<p>如果你传入的BAIDU_MAP_API_KEY不对， 就没有使用权限。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"baidu-map"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"cmd"</span><span class="token punctuation">,</span>
  <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"/c"</span><span class="token punctuation">,</span>
    <span class="token string">"npx"</span><span class="token punctuation">,</span>
    <span class="token string">"-y"</span><span class="token punctuation">,</span>
    <span class="token string">"@baidumap/mcp-server-baidu-map"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"BAIDU_MAP_API_KEY"</span><span class="token operator">:</span> <span class="token string">"LEyBQxG9UzR9C1GZ6zDHsFDVKvBem2do"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>所以STDIO做授权的方式很明确， 就是通过env【环境变量】，实现步骤如下：</p>
<ol>
<li>服务端发放一个用户的凭证（可以是秘钥、token）  这步不细讲，需要有一个授权中心发放凭证。</li>
<li>通过mcp client通过env传入凭证</li>
<li>mcp server通过环境变量鉴权</li>
</ol>
<p>所以在MCP Server端就可以通过获取环境变量的方式获取env里面的变量：</p>
<p>也可以通过AOP的方式统一处理</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Tool</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"获取用户余额"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"API_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// todo .. 鉴权处理</span>
    <span class="token keyword">return</span> <span class="token string">"未检索到当前用户"</span><span class="token operator">+</span>userName<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>这种方式要注意：  他不支持动态鉴权，  也就是动态更换环境变量，  因为STDIO是本地运行方式，<strong>它 将MCP Server作为子进程启动,</strong> 如果是多个用户动态切换凭证， 会对共享的环境变量造成争抢， 最终只能存储一个。  除非一个用户对应一个STDIO MCP  Server.     但是这样肯定很吃性能！   如果要多用户动态切换授权，  可以用SSE的方式；</p>
<h5 id="SSE-1"><a href="#SSE-1" class="headerlink" title="SSE"></a>SSE</h5><h6 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h6><p>不过，如果你想把 MCP 服务器开放给外部使用，就需要暴露一些标准的 HTTP 接口。对于私有场景，MCP 服务器可能并不需要严格的身份认证，但在企业级部署下，对这些接口的安全和权限把控就非常重要了。为了解决这个问题，<a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization">2025 年 3 月发布的最新 MCP 规范</a>引入了安全基础，借助了广泛使用的 <a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization">OAuth2 框架</a>。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/webp/22309163/1747373008252-ea86cf42-b7c5-49b2-96f4-9abdc4d986cf.webp?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>本文不会详细介绍 OAuth2 的所有内容，不过简单回顾一下还是很有帮助。</p>
<p><strong>在规范的草案中，MCP 服务器既是资源服务器，也是授权服务器。</strong></p>
<ul>
<li><strong>作为资源服务器</strong>，MCP 负责检查每个请求中的 <code>Authorization</code>请求头。这个请求头必须包括一个 OAuth2<code>access_token</code>（令牌），它代表客户端的“权限”。这个令牌通常是一个 JWT（JSON Web Token），也可能只是一个不可读的随机字符串。如果令牌缺失或无效（无法解析、已过期、不是发给本服务器的等），请求会被拒绝。正常情况下，调用示例如下：</li>
</ul>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">curl https://mcp.example.com/sse -H "Authorization: Bearer &lt;有效的 access token>"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><strong>作为授权服务器</strong>，MCP 还需要有能力为客户端安全地签发 <code>access_token</code>。在发放令牌前，服务器会校验客户端的凭据，有时还需要校验访问用户的身份。授权服务器决定令牌的有效期、权限范围、目标受众等特性。</li>
</ul>
<p>用 Spring Security 和 Spring Authorization Server，可以方便地为现有的 Spring MCP 服务器加上这两大安全能力。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/webp/22309163/1747373008252-989690c4-f96d-4333-87a1-0b027a0f42f0.webp?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h6 id="给-Spring-MCP-服务器加上-OAuth2-支持"><a href="#给-Spring-MCP-服务器加上-OAuth2-支持" class="headerlink" title="给 Spring MCP 服务器加上 OAuth2 支持"></a>给 Spring MCP 服务器加上 OAuth2 支持</h6><p>这里以官方例子仓库的【天气】MCP 工具演示如何集成 OAuth2，主要是让服务器端能签发和校验令牌。</p>
<p>首先，<code>pom.xml</code> 里添加必要的依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-oauth2-authorization-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着，在 <code>application.properties</code>配置里加上简易的 OAuth2 客户端信息，便于请求令牌：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.security.oauth2.authorizationserver.client.oidc-client.registration.client-id</span><span class="token punctuation">=</span><span class="token attr-value">xushu</span>
<span class="token attr-name">spring.security.oauth2.authorizationserver.client.oidc-client.registration.client-secret</span><span class="token punctuation">=</span><span class="token attr-value">&#123;noop&#125;xushu666</span>
<span class="token attr-name">spring.security.oauth2.authorizationserver.client.oidc-client.registration.client-authentication-methods</span><span class="token punctuation">=</span><span class="token attr-value">client_secret_basic</span>
<span class="token attr-name">spring.security.oauth2.authorizationserver.client.oidc-client.registration.authorization-grant-types</span><span class="token punctuation">=</span><span class="token attr-value">client_credentials</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样定义后，你可以直接通过 POST 请求和授权服务器交互，无需浏览器，用配置好的 <code>/secret</code> 作为固定凭据。 比如 最后一步是开启授权服务器和资源服务器功能。通常会新增一个安全配置类，比如 <code>SecurityConfiguration</code>，如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token punctuation">.</span>authorizationServer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">class</span> <span class="token class-name">SecurityConfiguration</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span>auth <span class="token operator">-></span> auth<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token function">authorizationServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span>resource <span class="token operator">-></span> resource<span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token class-name">CsrfConfigurer</span><span class="token operator">::</span><span class="token function">disable</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个过滤链主要做了这些事情：</p>
<ul>
<li>要求所有请求都要经过身份认证。也就是访问 MCP 的接口，必须带上 access_token。</li>
<li>同时启用了授权服务器和资源服务器两大能力。</li>
<li>关闭了 CSRF（跨站请求伪造防护），因为 MCP 不是给浏览器直接用的，这部分无需开启。</li>
<li>打开了 CORS（跨域资源共享），方便用 MCP inspector 测试。</li>
</ul>
<p>这样配置之后，只有带 access_token 的访问才会被接受，否则会直接返回 401 未授权错误，例如：</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">curl http:<span class="token operator">/</span><span class="token operator">/</span>localhost:8080<span class="token operator">/</span>sse <span class="token operator">--</span>fail<span class="token operator">-</span>with<span class="token operator">-</span>body
<span class="token comment"># 返回：</span>
<span class="token comment"># curl: (22) The requested URL returned error: 401</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>要使用 MCP 服务器，先要获取一个 access_token。可通过 <code>client_credentials</code> 授权方式（用于机器到机器、服务账号的场景）：</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">curl <span class="token operator">-</span>XPOST http:<span class="token operator">/</span><span class="token operator">/</span>localhost:8080<span class="token operator">/</span>oauth2<span class="token operator">/</span>token <span class="token operator">--</span><span class="token keyword">data</span> grant_type=client_credentials <span class="token operator">--</span>user xushu:xushu666
<span class="token comment"># 返回：</span>
<span class="token comment"># &#123;"access_token":"&lt;YOUR-ACCESS-TOKEN>","token_type":"Bearer","expires_in":299&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>把返回的 access_token 记下来（它一般以 “ey” 开头），之后就可以用它来正常请求服务器了：</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">curl http:<span class="token operator">/</span><span class="token operator">/</span>localhost:8080<span class="token operator">/</span>sse <span class="token operator">-</span>H<span class="token string">"Authorization: Bearer YOUR_ACCESS_TOKEN"</span>
<span class="token comment"># 服务器响应内容</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>你还可以直接在 MCP inspector 工具里用这个 access_token。从菜单的 Authentication &gt; Bearer 处粘贴令牌并连接即可。</p>
<h6 id="为MCP-Client设置请求头"><a href="#为MCP-Client设置请求头" class="headerlink" title="为MCP Client设置请求头"></a>为MCP Client设置请求头</h6><p>目前，  mcp 的java sdk 没有提供api直接调用，  经过徐庶老师研究源码后， 你只能通过2种方式实现：</p>
<h6 id="重写源码"><a href="#重写源码" class="headerlink" title="重写源码"></a>重写源码</h6><p>扩展mcp 的sse方式java sdk的源码，  整个重写一遍。 工作量较大， 并且我预计过不了多久， spring ai和mcp协议都会更新这块。  看你的紧急程度， 如果考虑整体扩展性维护性，可以整体重写一遍：</p>
<p>提供一个重写思路</p>
<p><strong>重写McpSseClientProperties</strong></p>
<p>MCPSse客户端属性配置：新增请求头字段</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>mcp<span class="token punctuation">.</span>client<span class="token punctuation">.</span>properties</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">"spring.ai.mcp.client.sse"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">McpSseClientProperties</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CONFIG_PREFIX <span class="token operator">=</span> <span class="token string">"spring.ai.mcp.client.sse"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SseParameters</span><span class="token punctuation">></span></span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> headersMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> defaultHeaderName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> defaultHeaderValue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> enableCompression <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> connectionTimeout <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">McpSseClientProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SseParameters</span><span class="token punctuation">></span></span> <span class="token function">getConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connections<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getHeadersMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>headersMap<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultHeaderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultHeaderName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDefaultHeaderName</span><span class="token punctuation">(</span><span class="token class-name">String</span> defaultHeaderName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultHeaderName <span class="token operator">=</span> defaultHeaderName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultHeaderValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultHeaderValue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDefaultHeaderValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> defaultHeaderValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultHeaderValue <span class="token operator">=</span> defaultHeaderValue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnableCompression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>enableCompression<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnableCompression</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enableCompression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>enableCompression <span class="token operator">=</span> enableCompression<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectionTimeout<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConnectionTimeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectionTimeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectionTimeout <span class="token operator">=</span> connectionTimeout<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">SseParameters</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">SseParameters</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><strong>重写SseWebFluxTransportAutoConfiguration</strong></p>
<p><strong>自动装配添加请求头配置信息</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>mcp<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@AutoConfiguration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">WebFluxSseClientTransport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">McpSseClientProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">McpClientCommonProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>
        prefix <span class="token operator">=</span> <span class="token string">"spring.ai.mcp.client"</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"enabled"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SseWebFluxTransportAutoConfiguration</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">SseWebFluxTransportAutoConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NamedClientMcpTransport</span><span class="token punctuation">></span></span> <span class="token function">webFluxClientTransports</span><span class="token punctuation">(</span><span class="token class-name">McpSseClientProperties</span> sseProperties<span class="token punctuation">,</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> webClientBuilderTemplate<span class="token punctuation">,</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NamedClientMcpTransport</span><span class="token punctuation">></span></span> sseTransports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span> var5 <span class="token operator">=</span> sseProperties<span class="token punctuation">.</span><span class="token function">getConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> headersMap <span class="token operator">=</span> sseProperties<span class="token punctuation">.</span><span class="token function">getHeadersMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">McpSseClientProperties<span class="token punctuation">.</span>SseParameters</span><span class="token punctuation">></span></span> serverParameters <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span>var5<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> webClientBuilder <span class="token operator">=</span> webClientBuilderTemplate<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">defaultHeaders</span><span class="token punctuation">(</span>headers <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>headersMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>headersMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            headersMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>headers<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">McpSseClientProperties<span class="token punctuation">.</span>SseParameters</span><span class="token punctuation">)</span>serverParameters<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WebFluxSseClientTransport</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebFluxSseClientTransport</span><span class="token punctuation">(</span>webClientBuilder<span class="token punctuation">,</span> objectMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sseTransports<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NamedClientMcpTransport</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>serverParameters<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> sseTransports<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> <span class="token function">webClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">WebClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p> 使用：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1747380936959-4787c998-23ca-4e5e-b3be-24fb49476be9.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_47,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_47,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><strong>设置WebClientCustomizer</strong></p>
<p>在用Spring-ai-M8版本的时候， 发现提供了WebClientCustomizer进行扩展。 可以尝试：</p>
<ol>
<li>根据用户凭证进行授权</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">curl <span class="token operator">-</span>XPOST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>oauth2<span class="token operator">/</span>token <span class="token operator">--</span>data grant_type<span class="token operator">=</span>client_credentials <span class="token operator">--</span>user xushu<span class="token operator">:</span>xushu666 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>根据授权后的token进行请求：</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">WebClientCustomizer</span> <span class="token function">webClientCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 认证 mcp server  /oauth?username:password   --> access_token</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>builder<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        builder<span class="token punctuation">.</span><span class="token function">defaultHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span><span class="token string">"Bearer eyJraWQiOiIzYmMzMDRmZC02NzcyLTRkYTItODJiMy1hNTEwNGExMDBjNTYiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ4dXNodSIsImF1ZCI6Inh1c2h1IiwibmJmIjoxNzQ2NzE4MjE5LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAiLCJleHAiOjE3NDY3MTg1MTksImlhdCI6MTc0NjcxODIxOSwianRpIjoiM2VhMzIyODctNTQ5NC00NWZlLThlZDItZGY1MjViNmIwNzkxIn0.Q-zWBZxa2CeFZo2YinenyaLb8KBMMua40X8YSs4n2fez7ODihtoVuCeJQnd2Q6qV2Pa8Z3cfH4QcMUuxMJ-_sLtZaSXpbCThH5q3KoQZ8C4MLJRTpuRqv4z1n7uLNXiVG2rya5hGwjTxu5qzHuBa2ri9pamRwmsjTz4vLHBJ1ILxDJcTkZUFuV1ExQJViewGt_7KMYcFqzGyRPiS4mm4wVvJTDjqcEGwMelu51L44K1DDYgt29vVLRVQEmnUtbBzePAxRqfw_HWJdhRSeQNiqRYCYhdAlPr3QZUFJa54GpuZn3CNyaXFoL7mENSR7wCYWx6wi--_REw6oaIfeSm-Xg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>SSE是支持动态切换token的，  因为一个请求就是一个新的http请求，  不会出现多线程争抢。 </p>
<p>但是需要动态请求：</p>
<p>curl -XPOST <a target="_blank" rel="noopener" href="http://localhost:8080/oauth2/token">http://localhost:8080/oauth2/token</a> –data grant_type=client_credentials –user xushu:xushu666    进行重新授权</p>
<h2 id="RAG"><a href="#RAG" class="headerlink" title="RAG"></a>RAG</h2><p>检索增强生成（Retrieval-augmented Generation）</p>
<p>对于基础大模型来说， 他只具备通用信息，他的参数都是拿公网进行训练，并且有一定的时间延迟，  无法得知一些具体业务数据和实时数据， 这些数据往往在各种文件中（比如txt、word、html、数据库…）</p>
<p>虽然function-call、SystemMessage可以用来解决一部分问题</p>
<p>但是它只能少量，并且针对的场景不一样</p>
<p>如果你要提供大量的业务领域信息，  就需要给他外接一个知识库：</p>
<p>比如</p>
<ol>
<li><p>我问他退订要多少费用</p>
</li>
<li><p>这些资料可能都由产品或者需求编写在了文档中：  <a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2025/txt/22309163/1749546158537-e2a594c3-1fd2-4513-adce-1870cb23b493.txt">📎terms-of-service.txt</a></p>
</li>
<li><ol>
<li>所以需要现在需求信息存到向量数据库（这个过程叫Embedding， 涉及到文档读取、分词、向量化存入）</li>
</ol>
</li>
<li><p>去向量数据库中查询“退订费用相关信息”</p>
</li>
<li><p>将查询到的数据和对话信息再请求大模型</p>
</li>
<li><p>此时会响应退订需要多少费用</p>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741158263487-85d26245-bcab-48ee-8d0c-45322c292687.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="向量："><a href="#向量：" class="headerlink" title="向量："></a>向量：</h4><p>向量通常用来做相似性搜索，比如语义的一维向量，可以表示词语或短语的语义相似性。例如，“你好”、“hello”和“见到你很高兴”可以通过一维向量来表示它们的语义接近程度。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741703979687-3dfe46b9-8bbc-4c8a-8ff7-11a63cd32800.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_33,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_33,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>然而，对于更复杂的对象，比如小狗，无法仅通过一个维度来进行相似性搜索。这时，我们需要提取多个特征，如颜色、大小、品种等，将每个特征表示为向量的一个维度，从而形成一个多维向量。例如，一只棕色的小型泰迪犬可以表示为一个多维向量 [棕色, 小型, 泰迪犬]。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741703733774-aafd18f8-6d1c-4f9c-ac0a-55eb5c2ef03e.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_44,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/watermark,type_d3F5LW1pY3JvaGVp,size_44,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>如果需要检索见过更加精准， 我们肯定还需要更多维度的向量， 组成更多维度的空间，在多维向量空间中，相似性检索变得更加复杂。我们需要使用一些算法，如余弦相似度或欧几里得距离，来计算向量之间的相似性。<strong>向量数据库</strong>会帮我实现。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752672648271-7cafe1a1-33e0-4c4d-8f70-d8c3fb819cd6.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_24,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="文本向量化"><a href="#文本向量化" class="headerlink" title="文本向量化"></a>文本向量化</h4><p>通过向量模型即可向量化,  这里我们学到了一种新的模型， 叫“向量模型” 专门用来做文本向量化的。</p>
<p>大语言模型不能做向量化， 所以需要单独找一个向量模型</p>
<ol>
<li><p>deepseek不支持向量模型</p>
</li>
<li><p>阿里百炼有大量向量模型</p>
</li>
<li><ol>
<li>默认模型<code>DashScopeEmbeddingProperties#DEFAULT_EMBEDDING_MODEL=&quot;text-embedding-v1&quot;</code></li>
</ol>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749557877276-e1c0b9b2-feed-410d-92e4-f6fb41b98775.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_48,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.ai.dashscope.embedding.options.model</span><span class="token punctuation">=</span> <span class="token attr-value">text-embedding-v4</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>ollama有大量向量模型, 自己拉取</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749557970769-1073e1ca-eee5-4275-ba03-6c46f03ba9f2.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_47,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>以ollama为例：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.ai.ollama.embedding.model</span><span class="token punctuation">=</span> <span class="token attr-value">nomic-embed-text</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmbaddingTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testEmbadding</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaEmbeddingModel</span> ollamaEmbeddingModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> embedded <span class="token operator">=</span> ollamaEmbeddingModel<span class="token punctuation">.</span><span class="token function">embed</span><span class="token punctuation">(</span><span class="token string">"我叫徐庶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>embedded<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>embedded<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749559505646-45b28c7e-2599-4f11-a628-d99b1c872573.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_32,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>从结果可以知道”我叫徐庶”这句话经过OllamaEmbeddingModel向量化之后得到的一个长度为768的float数组。注意，768是向量模型nomic-embed-text-v1.5固定的，不会随着句子长度而变化，不同的向量模型提供了不同的维度。</p>
<p>那么，我们通过这种向量模型得到一句话对应的向量有什么作用呢？非常有用，因为我们可以基于向量来判断两句话之间的相似度，举个例子：</p>
<p>查询跟秋田犬类似的狗，  在向量数据库中根据每个狗的特点进行多维向量， 你会发现秋田犬的向量数值和柴犬的向量数值最接近， 就可以查到类似的狗。    （当然我这里只是举例，让你对向量数据库有一个印象）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741159536310-23b0c084-513b-4801-9436-f63790fe47dc.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_30,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ul>
<li>向量模型的本质目标，就是把<strong>语义相似</strong>的内容用“相近”的向量表示，把“不相关”内容尽量拉远。  </li>
<li>所以好的向量模型能够更好的识别语义， 进行向量化.</li>
</ul>
<h4 id="向量数据库"><a href="#向量数据库" class="headerlink" title="向量数据库"></a>向量数据库</h4><p>对于向量模型生成出来的向量，我们可以持久化到向量数据库，并且能利用向量数据库来计算两个向量之间的相似度，或者根据一个向量查找跟这个向量最相似的向量。</p>
<p>在SpringAi中，VectorStore 表示向量数据库，目前支持的向量数据库有</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/azure.html">Azure Vector Search</a> - The <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/search/vector-search-overview">Azure</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/apache-cassandra.html">Apache Cassandra</a> - The <a target="_blank" rel="noopener" href="https://cassandra.apache.org/doc/latest/cassandra/vector-search/overview.html">Apache Cassandra</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/chroma.html">Chroma Vector Store</a> - The <a target="_blank" rel="noopener" href="https://www.trychroma.com/">Chroma</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/elasticsearch.html">Elasticsearch Vector Store</a> - The <a target="_blank" rel="noopener" href="https://www.elastic.co/">Elasticsearch</a> vector store. 可以“以向量+关键词”方式做混合检索。深度优化更多针对文本，不是专门“向量搜索引擎”。向量存储和检索容量有限制，查询延迟高于 Milvus。</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/gemfire.html">GemFire Vector Store</a> - The <a target="_blank" rel="noopener" href="https://tanzu.vmware.com/content/blog/vmware-gemfire-vector-database-extension">GemFire</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/mariadb.html">MariaDB Vector Store</a> - The <a target="_blank" rel="noopener" href="https://mariadb.com/">MariaDB</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/milvus.html">Milvus Vector Store</a> - The <a target="_blank" rel="noopener" href="https://milvus.io/">Milvus</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/mongodb.html">MongoDB Atlas Vector Store</a> - The <a target="_blank" rel="noopener" href="https://www.mongodb.com/atlas/database">MongoDB Atlas</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/neo4j.html">Neo4j Vector Store</a> - The <a target="_blank" rel="noopener" href="https://neo4j.com/">Neo4j</a> vector store.可以结合结构化图谱查询与向量检索， <strong>大规模嵌入检索（如千万—亿级高维向量）性能明显落后于 Milvus</strong></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/opensearch.html">OpenSearch Vector Store</a> - The <a target="_blank" rel="noopener" href="https://opensearch.org/platform/search/vector-database.html">OpenSearch</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/oracle.html">Oracle Vector Store</a> - The <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/database/oracle/oracle-database/23/vecse/overview-ai-vector-search.html">Oracle Database</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/pgvector.html">PgVector Store</a> - The <a target="_blank" rel="noopener" href="https://github.com/pgvector/pgvector">PostgreSQL/PGVector</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/pinecone.html">Pinecone Vector Store</a> - <a target="_blank" rel="noopener" href="https://www.pinecone.io/">PineCone</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/qdrant.html">Qdrant Vector Store</a> - <a target="_blank" rel="noopener" href="https://www.qdrant.tech/">Qdrant</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/redis.html">Redis Vector Store</a> - The <a target="_blank" rel="noopener" href="https://redis.io/">Redis</a> vector store.  低门槛实现小规模向量检索。对于高维大规模向量（如几百万到上亿条），性能和存储效率不如专用向量库。</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/hana.html">SAP Hana Vector Store</a> - The <a target="_blank" rel="noopener" href="https://news.sap.com/2024/04/sap-hana-cloud-vector-engine-ai-with-business-context/">SAP HANA</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/typesense.html">Typesense Vector Store</a> - The <a target="_blank" rel="noopener" href="https://typesense.org/docs/0.24.0/api/vector-search.html">Typesense</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/weaviate.html">Weaviate Vector Store</a> - The <a target="_blank" rel="noopener" href="https://weaviate.io/">Weaviate</a> vector store.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai/blob/main/spring-ai-vector-store/src/main/java/org/springframework/ai/vectorstore/SimpleVectorStore.java">SimpleVectorStore</a> - A simple implementation of persistent vector storage, good for educational purposes.</li>
</ul>
<p>其中有我们熟悉的几个数据库都可以用来存储向量，比如Elasticsearch、MongoDb、Neo4j、Pgsql、Redis。</p>
<p>视频中我会讲解2种：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai/blob/main/spring-ai-vector-store/src/main/java/org/springframework/ai/vectorstore/SimpleVectorStore.java">SimpleVectorStore</a> 教学版向量数据库</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/vectordbs/milvus.html">Milvus Vector Store</a>  Milvus（国产团队）、文档友好、社区国内活跃、性能最佳、市场占用率大。 实战中使用的向量数据库.</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749561837608-0462ab68-315f-4da5-89e5-17ee84dd843b.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_60,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="匹配检索"><a href="#匹配检索" class="headerlink" title="匹配检索"></a>匹配检索</h4><p>在这个示例中， 我分别存储了<code>预订航班</code>和<code>取消预订</code>2段说明到向量数据库中</p>
<p>然后通过”退票要多少钱” 进行查询</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741702267256-ccae55e5-3820-4f1a-8f52-feffc37affe7.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_40,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>代码执行结果为：</p>
<p>OllamaEmbedding结果</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">VectorStore</span> <span class="token function">vectorStore</span><span class="token punctuation">(</span><span class="token class-name">OllamaEmbeddingModel</span> embeddingModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">SimpleVectorStore<span class="token punctuation">.</span>SimpleVectorStoreBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">SimpleVectorStore</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>embeddingModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h5 id="SearchRequest"><a href="#SearchRequest" class="headerlink" title="SearchRequest"></a>SearchRequest</h5><p>可以利用searchRequest设置检索请求：</p>
<ul>
<li><p>query 代表要检索的内容</p>
</li>
<li><p>topK  设置检索结果的前N条   </p>
</li>
<li><ul>
<li>通常我们查询所有结果查出来， 因为查询结果最终要发给大模型， 查询过多的结果会：</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>\1. 过多的token意味着更长延迟，  更多的费用，  并且过多上下文会超限；</li>
<li>\2. 研究表明过多的内容会降低 LLM 的**<strong>召回性能*；*</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>similarityThreshold  设置相似度阈值， 可以通关设置分数限制召回内容相似度.  从而过滤掉废料。  （中文语料要适当降低分数）  ， 所以应遵循<strong>始终以“业务召回效果”为主，而不是追求网上常说的高分阈值。</strong></p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@BeforeEach</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span> <span class="token annotation punctuation">@Autowired</span>
                  <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. 声明内容文档</span>
    <span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
          预订航班:
          - 通过我们的网站或移动应用程序预订。
          - 预订时需要全额付款。
          - 确保个人信息（姓名、ID 等）的准确性，因为更正可能会产生 25 的费用。
          """</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Document</span> doc2 <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
          取消预订:
          - 最晚在航班起飞前 48 小时取消。
          - 取消费用：经济舱 75 美元，豪华经济舱 50 美元，商务舱 25 美元。
          - 退款将在 7 个工作日内处理。
          """</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 2. 将文本进行向量化，并且存入向量数据库（无需再手动向量化）</span>
    vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span>doc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">similaritySearchTest</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 3. 相似性查询</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token class-name">SearchRequest</span>
    <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"预定航班"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">topK</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">similarityThreshold</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> results <span class="token operator">=</span> vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.输出</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到明显阿里的向量模型归类的更加准确，Ollama的向量模型查出来后结果并不正确。  所以为了你的准确性，请选择性能更好的向量模型。  想要更快更相似的搜索，用好的向量数据库。</p>
<h3 id="接入ChatClient"><a href="#接入ChatClient" class="headerlink" title="接入ChatClient"></a>接入ChatClient</h3><ol>
<li>依赖</li>
</ol>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">&lt;dependency>
   &lt;groupId>org.springframework.ai&lt;/groupId>
   &lt;artifactId>spring-ai-advisors-vector-store&lt;/artifactId>
&lt;/dependency><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>代码</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">VectorStore</span> <span class="token function">vectorStore</span><span class="token punctuation">(</span><span class="token class-name">DashScopeEmbeddingModel</span> embeddingModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">SimpleVectorStore<span class="token punctuation">.</span>SimpleVectorStoreBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">SimpleVectorStore</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>embeddingModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>测试</li>
</ol>
<p>实际你会发现， 最核心的是通过拦截器：QuestionAnswerAdvisor  . 你应该能猜到底层肯定会通过拦截对话将相似内容发给大模型。   可以结合SimpleLoggerAdvisor 查看日志内容.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleVectorStoreTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span> <span class="token annotation punctuation">@Autowired</span>
            <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 声明内容文档</span>
        <span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                预订航班:
                - 通过我们的网站或移动应用程序预订。
                - 预订时需要全额付款。
                - 确保个人信息（姓名、ID 等）的准确性，因为更正可能会产生 25 的费用。
                """</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Document</span> doc2 <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                取消预订:
                - 最晚在航班起飞前 48 小时取消。
                - 取消费用：经济舱 75 美元，豪华经济舱 50 美元，商务舱 25 美元。
                - 退款将在 7 个工作日内处理。
                """</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 2. 将文本进行向量化，并且存入向量数据库（无需再手动向量化）</span>
        vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span>doc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">chatRagTest</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span>
            <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> chatModel
            <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> message<span class="token operator">=</span><span class="token string">"退费需要多少费用?"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">SimpleLoggerAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">QuestionAnswerAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">searchRequest</span><span class="token punctuation">(</span>
                                        <span class="token class-name">SearchRequest</span>
                                        <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">topK</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">similarityThreshold</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="RetrievalAugmentationAdvisor"><a href="#RetrievalAugmentationAdvisor" class="headerlink" title="RetrievalAugmentationAdvisor"></a>RetrievalAugmentationAdvisor</h4><ul>
<li>查询空时扩展策略  ：</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">queryAugmenter</span><span class="token punctuation">(</span><span class="token class-name">ContextualQueryAugmenter</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">allowEmptyContext</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">emptyContextPromptTemplate</span><span class="token punctuation">(</span><span class="token class-name">PromptTemplate</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token string">"用户查询位于知识库之外。礼貌地告知用户您无法回答"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>查询检索器</p>
</li>
<li><ul>
<li>检索提示词重写</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">queryTransformers</span><span class="token punctuation">(</span><span class="token class-name">RewriteQueryTransformer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">chatClientBuilder</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">targetSearchSystem</span><span class="token punctuation">(</span><span class="token string">"航空票务助手"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><ul>
<li><strong>翻译重写</strong></li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">queryTransformers</span><span class="token punctuation">(</span><span class="token class-name">TranslationQueryTransformer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">chatClientBuilder</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">targetLanguage</span><span class="token punctuation">(</span><span class="token string">"中文"</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>后置处理器：需要文档后处理和重排序</li>
</ul>
<ul>
<li>实现复杂的 RAG 流水线</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRag3</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>


        chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span><span class="token class-name">SimpleLoggerAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 增强多</span>
        <span class="token class-name">Advisor</span> retrievalAugmentationAdvisor <span class="token operator">=</span> <span class="token class-name">RetrievalAugmentationAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 查 = QuestionAnswerAdvisor</span>
                <span class="token punctuation">.</span><span class="token function">documentRetriever</span><span class="token punctuation">(</span><span class="token class-name">VectorStoreDocumentRetriever</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">similarityThreshold</span><span class="token punctuation">(</span><span class="token number">0.50</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">vectorStore</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 检索为空时，返回提示</span>
                <span class="token comment">/*.queryAugmenter(ContextualQueryAugmenter.builder()
                        .allowEmptyContext(false)
                        .emptyContextPromptTemplate(PromptTemplate.builder().template("用户查询位于知识库之外。礼貌地告知用户您无法回答").build())
                        .build())*/</span>
                <span class="token comment">// 相似性查询内容转换</span>
                <span class="token comment">/*.queryTransformers(RewriteQueryTransformer.builder()
                        .chatClientBuilder(ChatClient.builder(dashScopeChatModel))
                        .targetSearchSystem("航空票务助手")
                        .build())*/</span>
                <span class="token comment">// 检索后文档监控、操作</span>
                <span class="token comment">/*.documentPostProcessors((query, documents) -> &#123;
                    System.out.println("Original query: " + query.text());
                    System.out.println("Retrieved documents: " + documents.size());
                    return documents;
                &#125;)*/</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> answer <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>retrievalAugmentationAdvisor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"退一张票大概要多少费用？希望别扣太多啊"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@TestConfiguration</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestConfig</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Bean</span>
        <span class="token keyword">public</span> <span class="token class-name">VectorStore</span> <span class="token function">vectorStore</span><span class="token punctuation">(</span><span class="token class-name">DashScopeEmbeddingModel</span> embeddingModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">SimpleVectorStore</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>embeddingModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="ELT"><a href="#ELT" class="headerlink" title="ELT"></a>ELT</h3><p>在之前，我们主要完成了数据检索阶段，  但是完整的RAG流程还需要有emedding阶段， 即：</p>
<p>提取（读取）、转换（分隔）和加载（写入）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/jpeg/22309163/1752825687770-5d5b57f7-8aa6-48f9-aa9d-bfc071a044bb.jpeg?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_140,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="1-1-Document-Loaders-文档读取器"><a href="#1-1-Document-Loaders-文档读取器" class="headerlink" title="1.1. Document Loaders 文档读取器"></a>1.1. <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/category/document-loaders">Document Loaders</a> 文档读取器<img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741186496899-c89b21c0-6e7b-4503-853f-9c0e109d3b1b.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_38,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></h4><p><strong>springai提供了以下文档阅读器</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_json">JSON</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_text">文本</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_html_jsoup">HTML（JSoup）</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_markdown">Markdown</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_pdf_page">PDF页面</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_pdf_paragraph">PDF段落</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_tika_docx_pptx_html">Tika（DOCX、PPTX、HTML……）</a></li>
</ul>
<p><strong>alibaba ai也提供了很多阅读器</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-ai-alibaba/tree/main/community/document-parsers">https://github.com/alibaba/spring-ai-alibaba/tree/main/community/document-parsers</a></p>
<ul>
<li><strong>document-parser-apache-pdfbox</strong>：用于解析 PDF 格式文档。</li>
<li><strong>document-parser-bshtml</strong>：用于解析基于 BSHTML 格式的文档。</li>
<li><strong>document-parser-pdf-tables</strong>：专门用于从 PDF 文档中提取表格数据。</li>
<li><strong>document-parser-bibtex</strong>：用于解析 BibTeX 格式的参考文献数据。</li>
<li><strong>document-parser-markdown</strong>：用于解析 Markdown 格式的文档。</li>
<li><strong>document-parser-tika</strong>：一个多功能文档解析器，支持多种文档格式。</li>
</ul>
<p>以及<strong>网络来源</strong>文档读取器：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-ai-alibaba/tree/main/community/document-readers">https://github.com/alibaba/spring-ai-alibaba/tree/main/community/document-readers</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749974735407-b036f47f-1eb5-46fa-9a77-092eaa246fce.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_12,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h5 id="1-1-1-读取Text"><a href="#1-1-1-读取Text" class="headerlink" title="1.1.1.  读取Text"></a>1.1.1.  读取Text</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReaderText</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> documents<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="1-1-2-读取markdown"><a href="#1-1-2-读取markdown" class="headerlink" title="1.1.2. 读取markdown"></a>1.1.2. 读取markdown</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>ai<span class="token operator">-</span>markdown<span class="token operator">-</span>document<span class="token operator">-</span>reader<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReaderMD</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/9_横店影视股份有限公司_0.md"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MarkdownDocumentReaderConfig</span> config <span class="token operator">=</span> <span class="token class-name">MarkdownDocumentReaderConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withHorizontalRuleCreateDocument</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>     <span class="token comment">// 分割线创建新document</span>
                <span class="token punctuation">.</span><span class="token function">withIncludeCodeBlock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>                <span class="token comment">// 代码创建新document</span>
                <span class="token punctuation">.</span><span class="token function">withIncludeBlockquote</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>               <span class="token comment">// 引用创建新document</span>
                <span class="token punctuation">.</span><span class="token function">withAdditionalMetadata</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 每个document添加的元数据</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MarkdownDocumentReader</span> markdownDocumentReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MarkdownDocumentReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> markdownDocumentReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> documents<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="1-1-3-pdf"><a href="#1-1-3-pdf" class="headerlink" title="1.1.3. pdf"></a>1.1.3. pdf</h5><ul>
<li><code>PagePdfDocumentReader</code>一页1个document</li>
<li><code>ParagraphPdfDocumentReader</code> 按pdf目录分成一个个document</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
          <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
          <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>ai<span class="token operator">-</span>markdown<span class="token operator">-</span>document<span class="token operator">-</span>reader<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReaderPdf</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/平安银行2023年半年度报告摘要.pdf"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token class-name">PagePdfDocumentReader</span> pdfReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PagePdfDocumentReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span>
              <span class="token class-name">PdfDocumentReaderConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">withPageTopMargin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">withPageExtractedTextFormatter</span><span class="token punctuation">(</span><span class="token class-name">ExtractedTextFormatter</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                              <span class="token punctuation">.</span><span class="token function">withNumberOfTopTextLinesToDelete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">withPagesPerDocument</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> pdfReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> documents<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>


  <span class="token comment">// 必需要带目录，  按pdf的目录分document</span>
  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReaderParagraphPdf</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/平安银行2023年半年度报告.pdf"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">ParagraphPdfDocumentReader</span> pdfReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParagraphPdfDocumentReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span>
              <span class="token class-name">PdfDocumentReaderConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token comment">// 不同的PDF生成工具可能使用不同的坐标系 ， 如果内容识别有问题， 可以设置该属性为true</span>
                      <span class="token punctuation">.</span><span class="token function">withReversedParagraphPosition</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">withPageTopMargin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment">// 上边距</span>
                      <span class="token punctuation">.</span><span class="token function">withPageExtractedTextFormatter</span><span class="token punctuation">(</span><span class="token class-name">ExtractedTextFormatter</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                              <span class="token comment">// 从页面文本中删除前 N 行</span>
                              <span class="token punctuation">.</span><span class="token function">withNumberOfTopTextLinesToDelete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> pdfReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> documents<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="1-1-4-B站："><a href="#1-1-4-B站：" class="headerlink" title="1.1.4. B站："></a>1.1.4. B站：</h5><pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">    &lt;dependency>
        &lt;groupId>com.alibaba.cloud.ai&lt;/groupId>
        &lt;artifactId>spring-ai-alibaba-starter-document-reader-bilibili&lt;/artifactId>
    &lt;/dependency>
@Test
void bilibiliDocumentReaderTest() &#123;
    BilibiliDocumentReader bilibiliDocumentReader = new BilibiliDocumentReader(
            "https://www.bilibili.com/video/BV1C5UxYuEc2/?spm_id_from=333.1387.upload.video_card.click&amp;vd_source=fa810d8b8d6765676cb343ada918d6eb");
    List&lt;Document> documents = bilibiliDocumentReader.get();
    System.out.println(documents);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-2-DocumentSplitter‌-文档拆分器（转换器）"><a href="#1-2-DocumentSplitter‌-文档拆分器（转换器）" class="headerlink" title="1.2. DocumentSplitter‌ 文档拆分器（转换器）"></a>1.2. <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#document-splitter">DocumentSplitter‌</a> 文档拆分器（转换器）</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741186628965-bab8cbb0-71d6-4cd5-bfab-0287b13a2540.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_38,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>由于文本读取过来后， 还需要分成一段一段的片段(分块chunk)， 分块是为了更好地拆分语义单元，这样在后面可以更精确地进行语义相似性检索，也可以避免LLM的Token限制。</p>
<p>SpringAi就提供了一个文档拆分器：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_textsplitter">TextSplitter</a>    抽象类</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_tokentextsplitter">TokenTextSplitter</a>   按token分隔</li>
</ul>
<h5 id="1-2-1-TokenTextSplitter"><a href="#1-2-1-TokenTextSplitter" class="headerlink" title="1.2.1.  TokenTextSplitter"></a>1.2.1.  TokenTextSplitter</h5><ol>
<li><code>**chunkSize**</code> (默认值: 800)      100</li>
</ol>
<ul>
<li><ul>
<li>每个文本块的目标大小，以token为单位</li>
</ul>
</li>
</ul>
<ol>
<li><code>**minChunkSizeChars**</code> (默认值: 350)     建议小一点</li>
</ol>
<ul>
<li><ul>
<li>如果块超过最小块字符数( 按照块的最后. ! ? \n  符号截取)</li>
<li>如果块没超过最小块字符数，  不会按照符号截取(保留原块）。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">本服务条款适用于您对图灵航空 的体验。预订航班，即表示您同意这些条款。
<span class="token number">1.</span> 预订航班
<span class="token operator">-</span> 通过我们的网站或移动应用程序预订。
<span class="token operator">-</span> 预订时需要全额付款。  \n
<span class="token operator">-</span> 确保个人信息（姓名、ID 等）的准确性，因为更正可能会产生 <span class="token number">25</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><code>**minChunkLengthToEmbed**</code> (默认值: 5)  5</li>
</ol>
<ul>
<li><ul>
<li>丢弃短于此长度的文本块(如果去掉\r\n， 只剩5个有效文本， 那就丢掉）</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">本服务条<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li><code>**maxNumChunks**</code> (默认值: 10000)</li>
</ol>
<ul>
<li><ul>
<li>最多能分多少个块， 超过了就不管了</li>
</ul>
</li>
</ul>
<ol>
<li><code>**keepSeparator**</code> (默认值: true)</li>
</ol>
<ul>
<li><ul>
<li>是否在块中保留分隔符、换行符 \r\n</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTokenTextSplitter</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
       textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token class-name">TokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenTextSplitter</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>

       apply<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>整个流程如下：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749993911885-95202323-3010-46cb-8bc7-e69fe606b220.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_19,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h5 id="1-2-2-自定分割器："><a href="#1-2-2-自定分割器：" class="headerlink" title="1.2.2. 自定分割器："></a>1.2.2. 自定分割器：</h5><p><strong>支持中英文</strong>：同时支持中文和英文标点符号</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xushu<span class="token punctuation">.</span>springai<span class="token punctuation">.</span>rag<span class="token punctuation">.</span></span>ELT<span class="token punctuation">;</span>

 

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChineseTokenTextSplitter</span> <span class="token keyword">extends</span> <span class="token class-name">TextSplitter</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_CHUNK_SIZE <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MIN_CHUNK_SIZE_CHARS <span class="token operator">=</span> <span class="token number">350</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MIN_CHUNK_LENGTH_TO_EMBED <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_NUM_CHUNKS <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> KEEP_SEPARATOR <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EncodingRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">Encodings</span><span class="token punctuation">.</span><span class="token function">newLazyEncodingRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Encoding</span> encoding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token class-name">EncodingType</span><span class="token punctuation">.</span>CL100K_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// The target size of each text chunk in tokens</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">;</span>

	<span class="token comment">// The minimum size of each text chunk in characters</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> minChunkSizeChars<span class="token punctuation">;</span>

	<span class="token comment">// Discard chunks shorter than this</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> minChunkLengthToEmbed<span class="token punctuation">;</span>

	<span class="token comment">// The maximum number of chunks to generate from a text</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxNumChunks<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepSeparator<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_CHUNK_SIZE<span class="token punctuation">,</span> MIN_CHUNK_SIZE_CHARS<span class="token punctuation">,</span> MIN_CHUNK_LENGTH_TO_EMBED<span class="token punctuation">,</span> MAX_NUM_CHUNKS<span class="token punctuation">,</span> KEEP_SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keepSeparator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_CHUNK_SIZE<span class="token punctuation">,</span> MIN_CHUNK_SIZE_CHARS<span class="token punctuation">,</span> MIN_CHUNK_LENGTH_TO_EMBED<span class="token punctuation">,</span> MAX_NUM_CHUNKS<span class="token punctuation">,</span> keepSeparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token keyword">int</span> chunkSize<span class="token punctuation">,</span> <span class="token keyword">int</span> minChunkSizeChars<span class="token punctuation">,</span> <span class="token keyword">int</span> minChunkLengthToEmbed<span class="token punctuation">,</span> <span class="token keyword">int</span> maxNumChunks<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> keepSeparator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> chunkSize<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>minChunkSizeChars <span class="token operator">=</span> minChunkSizeChars<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>minChunkLengthToEmbed <span class="token operator">=</span> minChunkLengthToEmbed<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>maxNumChunks <span class="token operator">=</span> maxNumChunks<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>keepSeparator <span class="token operator">=</span> keepSeparator<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Builder</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">splitText</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">doSplit</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">doSplit</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> text<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tokens <span class="token operator">=</span> <span class="token function">getEncodedTokens</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> chunks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> num_chunks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">// maxNumChunks多能分多少个块， 超过了就不管了</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokens<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> num_chunks <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxNumChunks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// 按照chunkSize进行分隔</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> chunk <span class="token operator">=</span> tokens<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>chunkSize<span class="token punctuation">,</span> tokens<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> chunkText <span class="token operator">=</span> <span class="token function">decodeTokens</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Skip the chunk if it is empty or whitespace</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				tokens <span class="token operator">=</span> tokens<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tokens<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token comment">// Find the last period or punctuation mark in the chunk</span>
			<span class="token keyword">int</span> lastPunctuation <span class="token operator">=</span>
					<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'。'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'？'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					chunkText<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'！'</span><span class="token punctuation">)</span>
					<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 按照句子截取之后长度 > minChunkSizeChars</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>lastPunctuation <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> lastPunctuation <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>minChunkSizeChars<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// 保留按照句子截取之后的内容</span>
				chunkText <span class="token operator">=</span> chunkText<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastPunctuation <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token comment">// 按照句子截取之后长度 &lt; minChunkSizeChars 保留原块</span>


			<span class="token comment">// keepSeparator=true 替换/r/n   =false不管</span>
			<span class="token class-name">String</span> chunkTextToAppend <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>keepSeparator<span class="token punctuation">)</span> <span class="token operator">?</span> chunkText<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">:</span> chunkText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 替换/r/n之后的内容是不是&lt;this.minChunkLengthToEmbed 忽略</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkTextToAppend<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>minChunkLengthToEmbed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				chunks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkTextToAppend<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token comment">// Remove the tokens corresponding to the chunk text from the remaining tokens</span>
			tokens <span class="token operator">=</span> tokens<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token function">getEncodedTokens</span><span class="token punctuation">(</span>chunkText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tokens<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			num_chunks<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// Handle the remaining tokens</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokens<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">String</span> remaining_text <span class="token operator">=</span> <span class="token function">decodeTokens</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>remaining_text<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>minChunkLengthToEmbed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				chunks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>remaining_text<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">return</span> chunks<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">getEncodedTokens</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Text must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">decodeTokens</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tokens<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> <span class="token string">"Tokens must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> tokensIntArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntArrayList</span><span class="token punctuation">(</span>tokens<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		tokens<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>tokensIntArray<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>tokensIntArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Builder</span> <span class="token punctuation">&#123;</span>

		<span class="token keyword">private</span> <span class="token keyword">int</span> chunkSize <span class="token operator">=</span> DEFAULT_CHUNK_SIZE<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token keyword">int</span> minChunkSizeChars <span class="token operator">=</span> MIN_CHUNK_SIZE_CHARS<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token keyword">int</span> minChunkLengthToEmbed <span class="token operator">=</span> MIN_CHUNK_LENGTH_TO_EMBED<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token keyword">int</span> maxNumChunks <span class="token operator">=</span> MAX_NUM_CHUNKS<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token keyword">boolean</span> keepSeparator <span class="token operator">=</span> KEEP_SEPARATOR<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">withChunkSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> chunkSize<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">withMinChunkSizeChars</span><span class="token punctuation">(</span><span class="token keyword">int</span> minChunkSizeChars<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>minChunkSizeChars <span class="token operator">=</span> minChunkSizeChars<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">withMinChunkLengthToEmbed</span><span class="token punctuation">(</span><span class="token keyword">int</span> minChunkLengthToEmbed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>minChunkLengthToEmbed <span class="token operator">=</span> minChunkLengthToEmbed<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">withMaxNumChunks</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxNumChunks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>maxNumChunks <span class="token operator">=</span> maxNumChunks<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">withKeepSeparator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keepSeparator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>keepSeparator <span class="token operator">=</span> keepSeparator<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">public</span> <span class="token class-name">ChineseTokenTextSplitter</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minChunkSizeChars<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minChunkLengthToEmbed<span class="token punctuation">,</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>maxNumChunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keepSeparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="1-2-3-分隔经验："><a href="#1-2-3-分隔经验：" class="headerlink" title="1.2.3. 分隔经验："></a>1.2.3. 分隔经验：</h5><p><strong>过细分块的潜在问题</strong></p>
<ol>
<li>‌<strong>语义割裂</strong>‌： 破坏上下文连贯性，影响模型理解‌ 。</li>
<li>‌<strong>计算成本增加</strong>‌：分块过细会导致向量嵌入和检索次数增多，增加时间和算力开销‌。</li>
<li>‌<strong>信息冗余与干扰</strong>‌：碎片化的文本块可能引入无关内容，干扰检索结果的质量，降低生成答案的准确性‌。</li>
</ol>
<p><strong>分块过大的弊端</strong></p>
<ol>
<li>‌<strong>信息丢失风险</strong>‌：过大的文本块可能超出嵌入模型的输入限制，导致关键信息未被有效编码‌。</li>
<li>‌<strong>检索精度下降</strong>‌：大块内容可能包含多主题混合，与用户查询的相关性降低，影响模型反馈效果‌。</li>
</ol>
<table>
<thead>
<tr>
<th>‌<strong>场景</strong>‌</th>
<th>‌<strong>分块策略</strong>‌</th>
<th>‌<strong>参数参考</strong>‌</th>
</tr>
</thead>
<tbody><tr>
<td>微博/短文本</td>
<td>句子级分块，保留完整语义</td>
<td>每块100-200字符‌</td>
</tr>
<tr>
<td>学术论文</td>
<td>段落级分块，叠加10%重叠</td>
<td>每块300-500字符‌</td>
</tr>
<tr>
<td>法律合同</td>
<td>条款级分块，严格按条款分隔</td>
<td>每块200-400字符‌</td>
</tr>
<tr>
<td>长篇小说</td>
<td>章节级分块，过长段落递归拆分为段落</td>
<td>每块500-1000字符‌</td>
</tr>
</tbody></table>
<p> 不要过分指望按照文本主题进行分隔，  因为实战中的资料太多而且没有规律，  根本没办法保证每个chunk是一个完整的主题内容， 哪怕人为干预也很难。  所以实战中往往需要结合资料来决定分割器，大多数情况就是按token数分， 因为没有完美的， 还可以加入人工干预,或者大模型分隔。</p>
<h5 id="1-2-4-分块五种策略"><a href="#1-2-4-分块五种策略" class="headerlink" title="1.2.4. 分块五种策略"></a>1.2.4. 分块五种策略</h5><p>以下是 RAG 的五种分块策略：</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!us2E!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F92c70184-ba0f-4877-9a55-e4add0e311ad_870x1116.gif"><img src="https://cdn.nlark.com/yuque/0/2025/gif/22309163/1753853837683-32cb032f-28d9-406e-b3e5-cc7ec87038ed.gif" alt="img"></a></p>
<hr>
<h6 id="1-2-4-1-1）固定大小分块"><a href="#1-2-4-1-1）固定大小分块" class="headerlink" title="1.2.4.1. 1）固定大小分块"></a>1.2.4.1. 1）固定大小分块</h6><p>生成块的最直观和直接的方法是根据预定义的字符、单词或标记数量将文本分成统一的段。</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!RG5y!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98c422a0-f0e2-457c-a256-4476a56a601f_943x232.png"><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753853836122-f0cc462f-5950-4cba-b11d-e1bce7eb52e6.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_27,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></a></p>
<p>由于直接分割会破坏语义流，因此建议在两个连续的块之间保持一些重叠（上图蓝色部分）。</p>
<p>这很容易实现。而且，由于所有块的大小相同，它简化了批处理。</p>
<p>但有一个大问题。这通常会打断句子（或想法）。因此，重要的信息很可能会分散到不同的块之间。</p>
<hr>
<h6 id="1-2-4-2-2）语义分块"><a href="#1-2-4-2-2）语义分块" class="headerlink" title="1.2.4.2. 2）语义分块"></a>1.2.4.2. 2）语义分块</h6><p>这个想法很简单。</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!tmOD!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa6ad83a6-2879-4c77-9e49-393f16577aef_1066x288.gif"><img src="https://cdn.nlark.com/yuque/0/2025/gif/22309163/1753853837572-b20e461c-2dac-44d1-8edb-d3e2ae6ced7b.gif" alt="img"></a></p>
<ul>
<li><p>根据句子、段落或主题部分等有意义的单位对文档进行细分。</p>
</li>
<li><p>接下来，为每个片段创建嵌入。</p>
</li>
<li><p>假设我从第一个片段及其嵌入开始。</p>
</li>
<li><ul>
<li>如果第一个段的嵌入与第二个段的嵌入具有较高的余弦相似度，则这两个段形成一个块。</li>
<li>这种情况一直持续到余弦相似度显著下降。</li>
<li>一旦发生这种情况，我们就开始新的部分并重复。</li>
</ul>
</li>
</ul>
<p>输出可能如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!sTc2!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F74037e11-362d-4ea2-8ee2-ee85ab013523_963x231.png"><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753853836031-5db335da-e799-4a83-bc13-8f90a05c7dcb.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_27,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></a></p>
<p>与固定大小的块不同，这保持了语言的自然流畅并保留了完整的想法。</p>
<p>由于每个块都更加丰富，它提高了检索准确性，进而使 LLM 产生更加连贯和相关的响应。</p>
<p>一个小问题是，它依赖于一个阈值来确定余弦相似度是否显著下降，而这个阈值在不同文档之间可能会有所不同。</p>
<hr>
<h6 id="1-2-4-3-3）递归分块"><a href="#1-2-4-3-3）递归分块" class="headerlink" title="1.2.4.3. 3）递归分块"></a>1.2.4.3. 3）递归分块</h6><p>这也很简单。</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!WRuN!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff4009caa-34fc-48d6-8102-3d0f6f2c1386_1066x316.gif"><img src="https://cdn.nlark.com/yuque/0/2025/gif/22309163/1753853836600-2acd37dd-3cb8-4714-8688-72fd216e58ee.gif" alt="img"></a></p>
<p>首先，根据固有分隔符（如段落或章节）进行分块。</p>
<p>接下来，如果每个块的大小超出了预定义的块大小限制，则将其拆分成更小的块。但是，如果块符合块大小限制，则不再进行进一步拆分。</p>
<p>输出可能如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!5-DV!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0e40cc1-996f-48f4-9306-781b112536e4_984x428.png"><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753853837553-448a3d2b-1cf7-4036-955f-6efc28f602bf.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_28,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></a></p>
<p>如上图：</p>
<ul>
<li>首先，我们定义两个块（紫色的两个段落）。</li>
<li>接下来，第 1 段被进一步分成更小的块。</li>
</ul>
<p>与固定大小的块不同，这种方法还保持了语言的自然流畅性并保留了完整的想法。</p>
<p>然而，在实施和计算复杂性方面存在一些额外的开销。</p>
<hr>
<h6 id="1-2-4-4-4）基于文档结构的分块"><a href="#1-2-4-4-4）基于文档结构的分块" class="headerlink" title="1.2.4.4. 4）基于文档结构的分块"></a>1.2.4.4. 4）基于文档结构的分块</h6><p>这是另一种直观的方法。</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!NtgT!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe8febecd-ee68-42ff-ab06-41a0a3a43cd3_1102x306.gif"><img src="https://cdn.nlark.com/yuque/0/2025/gif/22309163/1753853838253-c6ae6f8e-08eb-41a8-83c0-c39e4b6ce25d.gif" alt="img"></a></p>
<p>它利用文档的固有结构（如标题、章节或段落）来定义块边界。</p>
<p>这样，它就通过与文档的逻辑部分对齐来保持结构完整性。</p>
<p>输出可能如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!9CjT!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40bdaf3b-601d-4357-bc7f-89b47f812097_1025x663.png"><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753853839556-9ea8dab6-5905-4fef-9469-7151da720546.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_29,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></a></p>
<p>也就是说，这种方法假设文档具有清晰的结构，但事实可能并非如此。</p>
<p>此外，块的长度可能会有所不同，可能会超出模型令牌的限制。您可以尝试使用递归拆分进行合并。</p>
<hr>
<h6 id="1-2-4-5-5）基于LLM的分块"><a href="#1-2-4-5-5）基于LLM的分块" class="headerlink" title="1.2.4.5. 5）基于LLM的分块"></a>1.2.4.5. 5）基于LLM的分块</h6><p><a target="_blank" rel="noopener" href="https://substackcdn.com/image/fetch/$s_!jVmL!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d1b6d60-8956-4030-8525-d899ee61a9d5_1140x198.gif"><img src="https://cdn.nlark.com/yuque/0/2025/gif/22309163/1753853841393-bfd2a2be-2db9-4b40-b723-4dfd1aaf3de6.gif" alt="img"></a></p>
<p>既然每种方法都有优点和缺点，为什么不使用 LLM 来创建块呢？</p>
<p>可以提示 LLM 生成语义上孤立且有意义的块。</p>
<p>显然，这种方法将确保较高的语义准确性，因为 LLM 可以理解超越简单启发式方法（用于上述四种方法）的上下文和含义。</p>
<p>唯一的问题是，它是这里讨论的所有五种技术中计算要求最高的分块技术。</p>
<p>此外，由于 LLM 通常具有有限的上下文窗口，因此需要注意这一点。</p>
<hr>
<p>每种技术都有其自身的优势和劣势。</p>
<p>我观察到语义分块在很多情况下效果很好，但同样，您需要进行测试。</p>
<p>选择将在很大程度上取决于内容的性质、嵌入模型的功能、计算资源等。</p>
<p>我们很快就会对这些策略进行实际演示。</p>
<p>同时，如果您错过了，昨天我们讨论了构建依赖于成对内容相似性的强大 NLP 系统的技术（RAG 就是其中之一）。</p>
<h5 id="1-2-5-ContentFormatTransformer"><a href="#1-2-5-ContentFormatTransformer" class="headerlink" title="1.2.5. ContentFormatTransformer"></a>1.2.5. ContentFormatTransformer</h5><p>检索到的内容最终会发给大模型，  由该组件决定发送到模型的RAG内容</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_TEXT_TEMPLATE <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s\n\n%s"</span><span class="token punctuation">,</span> TEMPLATE_METADATA_STRING_PLACEHOLDER<span class="token punctuation">,</span>
		TEMPLATE_CONTENT_PLACEHOLDER<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>即：假设：</p>
<ul>
<li>文本内容：<code>**&quot;The World is Big and Salvation Lurks Around the Corner&quot;**</code></li>
<li>元数据：<code>**Map.of(&quot;fileName&quot;, &quot;xushu.pdf&quot;)**</code></li>
</ul>
<p>最终发送给大模型的格式化内容是：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">source: xushu.pdf
  
The World is Big and Salvation Lurks Around the Corner<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>很少会去改， 了解即可</p>
<h5 id="1-2-6-KeywordMetadataEnriching"><a href="#1-2-6-KeywordMetadataEnriching" class="headerlink" title="1.2.6. KeywordMetadataEnriching"></a>1.2.6. KeywordMetadataEnriching</h5><p>使用生成式AI模型从文档内容中提取关键词并将其添加为元数据,为文档添加关键词标签，提升检索精度</p>
<pre class="line-numbers language-none"><code class="language-none">new KeywordMetadataEnricher(chatModel, 5);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>chatModel 需要提取关键字的模型</li>
<li>关键字数量</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testKeywordMetadataEnricher</span><span class="token punctuation">(</span>
           <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">,</span>
           <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
       textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
           <span class="token class-name">KeywordMetadataEnricher</span> enricher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeywordMetadataEnricher</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           apply<span class="token operator">=</span>  enricher<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> apply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
       apply<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1749997147499-7bafe6d5-bcaa-47cb-ae35-8489d3102d7c.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_28,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><strong>作用</strong>：<br>帮助做元数据过滤。    并不参数向量数据库的相似性检索</p>
<p><strong>问题</strong>：</p>
<p>KeywordMetadataEnriching 生成出来的关键字无法进行元数据过滤</p>
<p>在SpringAi1.0.1 中已支持KeywordMetadataEnriching 自定义模版：</p>
<ul>
<li>Enhanced KeywordMetadataEnricher with custom template functionality to provide more flexible metadata enrichment capabilities <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai/commit/2082a594a40b6552b57cdbc51cae7c2112efd0f9">2082a59</a></li>
</ul>
<h5 id="1-2-7-SummaryMetadataEnricher"><a href="#1-2-7-SummaryMetadataEnricher" class="headerlink" title="1.2.7. SummaryMetadataEnricher"></a>1.2.7. SummaryMetadataEnricher</h5><p>使用生成式AI模型为文档创建摘要并将其添加为元数据。它可以为当前文档以及相邻文档（前一个和后一个）生成摘要，以提供更丰富的上下文信息 。</p>
<p>场景： 有顺序关联的文档，比如西游记小说的RAG，‘三打白骨精的故事以及后续剧情’。</p>
<ul>
<li><strong>技术文档</strong>：前后章节有依赖关系</li>
<li><strong>教程内容</strong>：步骤之间有逻辑顺序</li>
<li><strong>法律文档</strong>：条款之间有关联性</li>
<li><strong>学术论文</strong>：章节间有逻辑递进</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSummaryMetadataEnricher</span><span class="token punctuation">(</span>
           <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">,</span>
           <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
       textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">SummaryMetadataEnricher</span> enricher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SummaryMetadataEnricher</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">,</span>
               <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">SummaryMetadataEnricher<span class="token punctuation">.</span>SummaryType</span><span class="token punctuation">.</span>PREVIOUS<span class="token punctuation">,</span>
                       <span class="token class-name">SummaryMetadataEnricher<span class="token punctuation">.</span>SummaryType</span><span class="token punctuation">.</span>CURRENT<span class="token punctuation">,</span>
                       <span class="token class-name">SummaryMetadataEnricher<span class="token punctuation">.</span>SummaryType</span><span class="token punctuation">.</span>NEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       apply <span class="token operator">=</span> enricher<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Document{id=’66e859b2-f719-43ca-8466-d97f1880b530’, text=’更改预订</p>
<p>- 允许在航班起飞前 24 小时更改。</p>
<p>- 通过在线更改或联系我们的支持人员。</p>
<p>- 改签费：经济舱 50，豪华经济舱 30，商务舱免费。</p>
<p>3.</p>
<p>取消预订</p>
<p>- 最晚在航班起飞前 48 小时取消。’, media=’null’, metadata={prev_section_summary=The key topics and entities of the section include:</p>
<p>\1. <strong>Service Terms Agreement</strong>: The terms apply to the user’s experience with 图灵航空 (Turing Airlines).</p>
<p>\2. <strong>Acceptance of Terms</strong>: By booking a flight, the user agrees to these terms.</p>
<p>\3. <strong>Flight Booking</strong>:</p>
<p>   - Bookings can be made via the website or mobile application.</p>
<p>   - Full payment is required at the time of booking.</p>
<p>   - Personal information must be accurate to avoid a correction fee of 25 units.</p>
<p>Entities:</p>
<p>- 图灵航空 (Turing Airlines)</p>
<p>- Website and mobile application</p>
<p>- Flight bookings</p>
<p>- Payment process</p>
<p>- Personal information (name, ID), charset=UTF-8, filename=terms-of-service.txt, source=terms-of-service.txt, section_summary=The key topics and entities of the section are as follows:</p>
<p>\1. <strong>更改预订 (Modifying Reservations)</strong>:</p>
<p>   - Allowed within 24 hours before the flight departure.</p>
<p>   - Can be done either online or by contacting support personnel.</p>
<p>   - Change fees: </p>
<p>​     - Economy class: 50</p>
<p>​     - Premium economy class: 30</p>
<p>​     - Business class: Free</p>
<p>\2. <strong>取消预订 (Canceling Reservations)</strong>:</p>
<p>   - Must be done at least 48 hours before the flight departure.</p>
<p>Summary: The section outlines the policies for modifying and canceling reservations, including timeframes and associated fees for different classes (economy, premium economy, and business)., next_section_summary=The section outlines the <strong>cancellation fees</strong> for different cabin classes and the <strong>refund processing time</strong>. Key entities include:  </p>
<p>- Cancellation fees: <strong>Economy class (75 USD)</strong>, <strong>Premium Economy class (50 USD)</strong>, <strong>Business class (25 USD)</strong>.  </p>
<p>- Refund processing time: <strong>7 business days</strong>.}, score=null}</p>
<h6 id="-5"><a href="#-5" class="headerlink" title=""></a></h6><h4 id="1-3-文本向量化"><a href="#1-3-文本向量化" class="headerlink" title="1.3. 文本向量化"></a>1.3. 文本向量化</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741188324988-536ef32b-5a6d-4999-9e08-df15d488a342.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_39,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>向量化存储之前在“文本向量化”介绍了， 就是通过向量模型库进行向量化</p>
<p>代码：</p>
<p>依然通过Qwen向量模型进行向量化：  将第分割的chunk进行向量化</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTokenTextSplitter</span><span class="token punctuation">(</span> 
           <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeEmbeddingModel</span> embeddingModel<span class="token punctuation">,</span>
           <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
       <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
       textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> apply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> embedded <span class="token operator">=</span> embeddingModel<span class="token punctuation">.</span><span class="token function">embed</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h4 id="1-4-存储向量"><a href="#1-4-存储向量" class="headerlink" title="1.4. 存储向量"></a>1.4. 存储向量</h4><p>但是我告诉你其实 ，  我们通过向量数据库存储document， 可以省略向量化这一步， 向量数据库会在底层自动完成向量化</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Document</span> document <span class="token operator">:</span> apply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> embedded <span class="token operator">=</span> embeddingModel<span class="token punctuation">.</span><span class="token function">embed</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// 替换为： 写入=向量化+存储</span>
vectorStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750055863649-e1a58a18-23f4-482d-9c0d-123ee5a893fc.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_29,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTokenTextSplitter</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="1-5-向量数据库检索"><a href="#1-5-向量数据库检索" class="headerlink" title="1.5. 向量数据库检索"></a>1.5. 向量数据库检索</h4><p>代码：</p>
<p>需要先将文本进行向量化， 然后去向量数据库查询，  </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 3. 相似性查询</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token class-name">SearchRequest</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"预定航班"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">topK</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">similarityThreshold</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> results <span class="token operator">=</span> vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.输出</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>完整代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRag</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. 读取</span>
    <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.分隔</span>
    <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 向量化+写入</span>
    vectorStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 相似性查询</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token class-name">SearchRequest</span>
            <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"退费需要多少费用"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">topK</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">similarityThreshold</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> results <span class="token operator">=</span> vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.输出</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h4 id="1-6-对话阶段"><a href="#1-6-对话阶段" class="headerlink" title="1.6. 对话阶段"></a>1.6. 对话阶段</h4><p>如果结合ChatClient 可以直接将检索和Advisor整合在一起</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1741847699874-61b078b9-8d57-4f61-ac3d-5927d7bad5f6.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_117,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRagToLLM</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> chatModel<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vectorStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 相似性查询  </span>
        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> message<span class="token operator">=</span><span class="token string">"退费需要多少费用?"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">SimpleLoggerAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">QuestionAnswerAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">searchRequest</span><span class="token punctuation">(</span>
                                        <span class="token class-name">SearchRequest</span>
                                                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">topK</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">similarityThreshold</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>SpringAI整个过程原理：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750057895102-987392e8-f52a-417d-9df1-35764077748c.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_67,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="提升检索精度—rerank-重排序）"><a href="#提升检索精度—rerank-重排序）" class="headerlink" title="提升检索精度—rerank(重排序）"></a>提升检索精度—rerank(重排序）</h3><h4 id="为什么需要-rerank"><a href="#为什么需要-rerank" class="headerlink" title="为什么需要 rerank"></a>为什么需要 rerank</h4><p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753779425195-b3fcc518-dd15-40cb-ac6d-fb5e77285348.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_35,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>传统的向量检索存在几个关键问题：</p>
<p><strong>语义相似度的局限性</strong>：向量检索主要基于余弦相似度等数学计算，但相似的向量表示不一定意味着内容一定绝对相关。单纯的向量相似度无法充分理解查询的真实意图和上下文。</p>
<p><strong>排序质量不佳</strong>：初始检索的排序往往不是最优的，可能将不太相关的文档排在前面，尤其性能差的向量模型更为明显。</p>
<p><strong>上下文理解缺失</strong>：传统检索（完全依赖向量数据库和向量模型）缺乏对查询和文档完整上下文的深度理解，容易出现语义漂移问题。</p>
<h4 id="重排序："><a href="#重排序：" class="headerlink" title="重排序："></a>重排序：</h4><p>主要在检索阶段进行改进：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753779476732-44858afa-eacb-4758-8362-411138c71e97.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_35,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><strong>二阶段优化架构</strong>：rerank 采用”粗排+精排”的两阶段架构。第一阶段快速检索大量候选文档，第二阶段使用专门的重排序模型进行精确评分。</p>
<p><strong>专业化模型</strong>：重排序模型（如 <code>**gte-rerank-hybrid**</code>）专门针对文档相关性评估进行训练，能够更准确地计算查询与文档的语义匹配度。</p>
<p><strong>分数阈值过滤</strong>：通过设置最小分数阈值，可以过滤掉低质量的文档，确保只有高相关性的内容被保留。在实现中可以看到这个过滤逻辑：  </p>
<p><strong>动态参数调整</strong>：支持根据实际效果动态调整 <code>**topN**</code> 等参数，优化最终返回的文档数量和质量。</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><p>说明：</p>
<p>为了更好的测试</p>
<ol>
<li>我这里用的事ollama一个性能较差的向量模型， 这样才能更好体现他瞎排的顺序</li>
<li>我分隔的比较小new ChineseTokenTextSplitter(80,10,5,10000,true);为了有更多的document；</li>
<li>粗排需要设置数量较大的topk(建议200） ， 精排（默认topN5）</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RerankTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 读取</span>
        <span class="token class-name">TextReader</span> textReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textReader<span class="token punctuation">.</span><span class="token function">getCustomMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> textReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 分隔</span>
        <span class="token class-name">ChineseTokenTextSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChineseTokenTextSplitter</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> apply <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 存储向量（内部会自动向量化)</span>
        vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@TestConfiguration</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestConfig</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Bean</span>
        <span class="token keyword">public</span> <span class="token class-name">VectorStore</span> <span class="token function">vectorStore</span><span class="token punctuation">(</span><span class="token class-name">OllamaEmbeddingModel</span> embeddingModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">SimpleVectorStore</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>embeddingModel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRerank</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeRerankModel</span> rerankModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">RetrievalRerankAdvisor</span> retrievalRerankAdvisor <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">RetrievalRerankAdvisor</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">,</span> rerankModel
                        <span class="token punctuation">,</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topK</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token string">"退票费用"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>retrievalRerankAdvisor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重排前：</p>
<p>排第一的doucment跟退费并没有关系：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752846171180-c3491a36-4fe2-451a-b3df-d7354e7423c9.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_45,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>重排后：</p>
<p>排第一的document:</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1752846203397-eba6baeb-fe2b-4a00-8ad1-c1cc17ccc841.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_46,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="-6"><a href="#-6" class="headerlink" title=""></a></h4><h2 id="《基于航空智能客服-RAG》实战"><a href="#《基于航空智能客服-RAG》实战" class="headerlink" title="《基于航空智能客服+RAG》实战"></a>《基于航空智能客服+RAG》实战</h2><ol>
<li>配置向量数据库</li>
<li>写入数据（Embedding）</li>
<li>查询</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2025/txt/22309163/1752848013056-c5d9eec3-e48d-4888-bfe9-b64ebab77f81.txt">📎terms-of-service.txt</a></p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">本服务条款适用于您对 Funnair 的体验。预订航班，即表示您同意这些条款。
1. 预订航班
- 通过我们的网站或移动应用程序预订。
- 预订时需要全额付款。
- 确保个人信息（姓名、ID 等）的准确性，因为更正可能会产生 25 的费用。
2. 更改预订
- 允许在航班起飞前 24 小时更改。
- 通过在线更改或联系我们的支持人员。
- 改签费：经济舱 50，豪华经济舱 30，商务舱免费。
3. 取消预订
- 最晚在航班起飞前 48 小时取消。
- 取消费用：经济舱 75 美元，豪华经济舱 50 美元，商务舱 25 美元。
- 退款将在 7 个工作日内处理。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="向量数据库-1"><a href="#向量数据库-1" class="headerlink" title="向量数据库"></a>向量数据库</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">VectorStore</span> <span class="token function">vectorStore</span><span class="token punctuation">(</span><span class="token class-name">EmbeddingModel</span> embeddingModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleVectorStore</span><span class="token punctuation">(</span>embeddingModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>写入向量数据库<img src="https://cdn.nlark.com/yuque/0/2024/jpeg/22309163/1730894384826-1fc20e94-3ba1-4514-b20f-bb04a24dc3e1.jpeg?x-oss-process=image/format,webp/resize,w_1634,limit_0/interlace,1/watermark,type_d3F5LW1pY3JvaGVp,size_47,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">CommandLineRunner</span> <span class="token function">ingestTermOfServiceToVectorStore</span><span class="token punctuation">(</span><span class="token class-name">EmbeddingModel</span> embeddingModel<span class="token punctuation">,</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:rag/terms-of-service.txt"</span><span class="token punctuation">)</span> <span class="token class-name">Resource</span> termsOfServiceDocs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">return</span> args <span class="token operator">-></span> <span class="token punctuation">&#123;</span> 
        vectorStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>                                  <span class="token comment">// 3.写入</span>
            <span class="token keyword">new</span> <span class="token class-name">TokenTextSplitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>          <span class="token comment">// 2.转换</span>
                <span class="token keyword">new</span> <span class="token class-name">TextReader</span><span class="token punctuation">(</span>termsOfServiceDocs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 1.读取</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p><strong>配置Advisor：</strong></p>
<p>new QuestionAnswerAdvisor(vectorStore, SearchRequest.defaults()), // RAG</p>
<p><code>QuestionAnswerAdvisor</code>可以在用户发起的提问时，先向数据库查询相关的文档，再把相关的文档拼接到用户的提问中，再让模型生成答案。那就是<code>RAG</code>的实现了。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClientBuilder
               <span class="token punctuation">.</span><span class="token function">defaultSystem</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
				   您是“图灵”航空公司的客户聊天支持代理。请以友好、乐于助人且愉快的方式来回复。
                      您正在通过在线聊天系统与客户互动。
                      
                       在提供有关预订或取消预订的信息之前，您必须始终
                       从用户处获取以下信息：预订号、客户姓名。
                       在询问用户之前，请检查消息历史记录以获取此信息。
                       在更改或退订之前，请先获取预订信息待用户回复确定之后才进行更改或退订的function-call。 
                      请讲中文。
                      今天的日期是 &#123;current_date&#125;.
				"""</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span>
                       <span class="token keyword">new</span> <span class="token class-name">PromptChatMemoryAdvisor</span><span class="token punctuation">(</span>chatMemory<span class="token punctuation">)</span><span class="token punctuation">,</span>
   						<span class="token keyword">new</span> <span class="token class-name">QuestionAnswerAdvisor</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">,</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">.</span><span class="token function">defaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// RAG</span>
                       <span class="token keyword">new</span> <span class="token class-name">LoggingAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">defaultFunctions</span><span class="token punctuation">(</span><span class="token string">"getBookingDetails"</span><span class="token punctuation">,</span> <span class="token string">"changeBooking"</span><span class="token punctuation">,</span> <span class="token string">"cancelBooking"</span><span class="token punctuation">)</span> <span class="token comment">// FUNCTION CALLING</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="文档嵌入"><a href="#文档嵌入" class="headerlink" title="文档嵌入"></a>文档嵌入</h4><p>在上面的<code>VectorStore</code>配置中我们提供了<code>EmbeddingModel</code>，调用<code>vectorStore.add(splitDocuments)</code>底层会把文档给<code>EmbeddingModel</code>把文本变成向量然后再存入向量数据库。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">;</span>
   <span class="token comment">/**
     * 嵌入文件
     *
     * @param file 待嵌入的文件
     * @return 是否成功
     */</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"embedding"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">embedding</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 从IO流中读取文件</span>
        <span class="token class-name">TikaDocumentReader</span> tikaDocumentReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TikaDocumentReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamResource</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将文本内容划分成更小的块</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> splitDocuments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenTextSplitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>tikaDocumentReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存入向量数据库，这个过程会自动调用embeddingModel,将文本变成向量再存入。</span>
        vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>splitDocuments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="文档查询"><a href="#文档查询" class="headerlink" title="文档查询"></a>文档查询</h4><p>调用<code>vectorStore.similaritySearch(query)</code>时同样会先把用户的提问给<code>EmbeddingModel</code>，将提问变成向量，然后与向量数据库中的文档向量进行相似度计算（cosine值）。</p>
<p>要注意：此时向量数据库不会回答用户的提问。要回答用户的提问需要指定advisor</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
     * 查询向量数据库
     *
     * @param query 用户的提问
     * @return 匹配到的文档
     */</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"query"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>指定advisor</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
                <span class="token comment">// 2. QuestionAnswerAdvisor会在运行时替换模板中的占位符`question_answer_context`，替换成向量数据库中查询到的文档。此时的query=用户的提问+替换完的提示词模板;</span>
                <span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuestionAnswerAdvisor</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">,</span> prompt<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 3. query发送给大模型得到答案</span>
                <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>chatResponse <span class="token operator">-></span> <span class="token class-name">ServerSentEvent</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatResponse<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h2 id="《基于RAG技术的个人知识库AI问答系统》实战"><a href="#《基于RAG技术的个人知识库AI问答系统》实战" class="headerlink" title="《基于RAG技术的个人知识库AI问答系统》实战"></a>《基于RAG技术的个人知识库AI问答系统》实战</h2><p><strong>不对外开放</strong></p>
<p>前端（提供）：  Vue 3 + TypeScript + Vite    </p>
<p>后端： </p>
<ul>
<li>Spring Boot: 3.4.2</li>
<li>JDK: 17</li>
<li>spring-ai: 1.0.0 GA</li>
<li>spring-ai-alibaba: 1.0.0.2</li>
<li>maven: 3.9.6</li>
<li>Mysql 5.7</li>
<li>Milvus(向量存储)</li>
<li>LLM使用的通义千问</li>
<li>对象存储使用阿里云OSS (文生图模型）</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/geren-t8lyq/ncgl94/ndw2tv9u6bu3zo2h?singleDoc#">https://www.yuque.com/geren-t8lyq/ncgl94/ndw2tv9u6bu3zo2h?singleDoc#</a> 《基于RAG技术的个人知识库AI问答系统》实战</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750060429372-81d7966d-b83b-457d-8a79-9232641f4be9.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_46,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750060452904-049ad8c2-878a-49b1-96e3-7e3ccf85a691.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_46,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="模型RAG评测"><a href="#模型RAG评测" class="headerlink" title="模型RAG评测"></a>模型RAG评测</h2><h3 id="模型理解力评测"><a href="#模型理解力评测" class="headerlink" title="模型理解力评测"></a>模型理解力评测</h3><p>RAG 之所以广受欢迎，是因为它（<strong>基于检索到的真实资料</strong>）能够减少幻觉。然而， RAG 并不一定意味着幻觉会被完全消除。</p>
<h4 id="现实中出现事实性幻觉的常见场景"><a href="#现实中出现事实性幻觉的常见场景" class="headerlink" title="现实中出现事实性幻觉的常见场景"></a>现实中出现事实性幻觉的常见场景</h4><ol>
<li><strong>上下文提供了明确事实，但模型未读取或匹配，凭常识胡乱生成。</strong></li>
<li><strong>模型“看”到的背景信息有限，但它仍然自信地“虚构”细节回答问题。</strong></li>
</ol>
<p><strong>问：马云在阿里巴巴创办初期遇到了哪些具体困难？</strong></p>
<p>**RAG:**马云，著名企业家，阿里巴巴创始人。</p>
<p><strong>答A（幻觉）：</strong></p>
<p>马云在阿里巴巴创立初期曾因办公楼失火导致数据全部丢失，团队一度陷入危机。</p>
<ol>
<li><strong>多个相似案例混淆，模型输出了正确格式但内容错误的事实</strong></li>
</ol>
<p>怎么你确定是否有这些问题：</p>
<p><strong>事实性的评估</strong>    </p>
<p>评估器主要用于以下场景：</p>
<ol>
<li><strong>开发和测试阶段</strong>：在集成测试中验证 RAG 系统的质量 </li>
<li><strong>批量质量检查</strong>：对一批历史对话进行离线评估 </li>
<li><strong>系统监控</strong>：定期抽样评估生产环境中的对话质量，比如每100次对话评估1次</li>
<li><strong>模型验证</strong>：当更换 AI 模型或调整 RAG 配置时，用于验证新配置的效果</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactCheckingTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testFactChecking</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OllamaChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>


        <span class="token comment">// 创建 FactCheckingEvaluator</span>
        <span class="token keyword">var</span> factCheckingEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FactCheckingEvaluator</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 示例上下文和声明</span>
        <span class="token class-name">String</span> context <span class="token operator">=</span> <span class="token string">"地球是仅次于太阳的第三颗行星，也是已知唯一孕育生命的天文物体。"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> claim <span class="token operator">=</span> <span class="token string">"地球是距离太阳第三大行星。"</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建 EvaluationRequest</span>
        <span class="token class-name">EvaluationRequest</span> evaluationRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvaluationRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> claim<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行评估</span>
        <span class="token class-name">EvaluationResponse</span> evaluationResponse <span class="token operator">=</span> factCheckingEvaluator<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>evaluationRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>evaluationResponse<span class="token punctuation">.</span><span class="token function">isPass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"The claim should not be supported by the context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解决：</p>
<ul>
<li>高风险领域（医疗、法律、金融等）必须进行事实性幻觉定期评估</li>
<li><strong>限定上下文范围</strong>：通过系统提示词让模型明确只能在指定背景或文档内容中作答，禁止引用未检索到的信息。</li>
<li><strong>“回答不确定”机制</strong> </li>
<li><strong>调整分数、定义精确RAG相似性搜索能力</strong></li>
</ul>
<h3 id="RAG幻觉评测"><a href="#RAG幻觉评测" class="headerlink" title="RAG幻觉评测"></a>RAG幻觉评测</h3><p>当我们发现大模型回答的内容并没有按照检索的documents进行有效回答， 就可以通过这种方式进行测试，评估 AI 生成的响应的事实准确性。该评估器通过验证给定的语句（responseContent）是否在逻辑上得到提供的上下文（文档）的支持，帮助检测并减少 AI 输出中的错觉。</p>
<p>“responseContent”和“document”将提交给人工智能模型进行评估。目前已有更小、更高效的人工智能模型专门用于此目的，例如 Bespoke 的 Minicheck，与 GPT-4 等旗舰模型相比，它有助于降低执行这些检查的成本。Minicheck 也可通过 Ollama 使用。</p>
<p><strong>什么时候需要用到：</strong></p>
<ul>
<li>验证已构建的RAG系统的响应质量</li>
<li>在集成测试中自动化质量检查</li>
<li>调试和优化RAG配置时评估效果</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RagEvalTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRag</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">VectorStore</span> vectorStore<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">></span></span> documents <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                        1. 预订航班
                        - 通过我们的网站或移动应用程序预订。
                        - 预订时需要全额付款。
                        - 确保个人信息（姓名、ID 等）的准确性，因为更正可能会产生 25 的费用。
                        """</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                        2. 更改预订
                        - 允许在航班起飞前 24 小时更改。
                        - 通过在线更改或联系我们的支持人员。
                        - 改签费：经济舱 50，豪华经济舱 30，商务舱免费。
                        """</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
                        3. 取消预订
                        - 最晚在航班起飞前 48 小时取消。
                        - 取消费用：经济舱 75 美元，豪华经济舱50美元，商务舱25美元。
                        - 退款将在 7 个工作日内处理。
                        """</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">RetrievalAugmentationAdvisor</span> retrievalAugmentationAdvisor <span class="token operator">=</span> <span class="token class-name">RetrievalAugmentationAdvisor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">documentRetriever</span><span class="token punctuation">(</span><span class="token class-name">VectorStoreDocumentRetriever</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">vectorStore</span><span class="token punctuation">(</span>vectorStore<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> query <span class="token operator">=</span> <span class="token string">"退票费用"</span><span class="token punctuation">;</span>
        <span class="token class-name">ChatResponse</span> chatResponse <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">advisors</span><span class="token punctuation">(</span>retrievalAugmentationAdvisor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">EvaluationRequest</span> evaluationRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvaluationRequest</span><span class="token punctuation">(</span>
                <span class="token comment">// The original user question</span>
                query<span class="token punctuation">,</span>
                <span class="token comment">// The retrieved context from the RAG flow</span>
                chatResponse<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RetrievalAugmentationAdvisor</span><span class="token punctuation">.</span>DOCUMENT_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// The AI model's response</span>
                chatResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RelevancyEvaluator</span> evaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RelevancyEvaluator</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EvaluationResponse</span> evaluationResponse <span class="token operator">=</span> evaluator<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>evaluationRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>evaluationResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>chatResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750393171415-ab39fd5d-e127-4c49-94eb-0af9f51be3c3.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_28,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<pre class="line-numbers language-none"><code class="language-none">query &#x3D; &quot;我叫什么名字&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1750393227492-de8a71f7-a330-4466-8e2e-6578cea525f7.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_29,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="观测性"><a href="#观测性" class="headerlink" title="观测性"></a>观测性</h2><h3 id="为什么Spring-AI应用急需可观测性？"><a href="#为什么Spring-AI应用急需可观测性？" class="headerlink" title="为什么Spring AI应用急需可观测性？"></a>为什么Spring AI应用急需可观测性？</h3><h4 id="AI服务成本失控的痛点"><a href="#AI服务成本失控的痛点" class="headerlink" title="AI服务成本失控的痛点"></a>AI服务成本失控的痛点</h4><p>在企业级AI应用中，使用DeepSeek、OpenAI、Google Gemini或Azure OpenAI等服务时，成本控制是一个严峻挑战：</p>
<ul>
<li>• <strong>Token消耗不透明</strong>：无法精确了解每次AI调用的成本</li>
<li>• <strong>费用增长失控</strong>：大规模应用中，AI服务费用可能呈指数级增长</li>
<li>• <strong>性能瓶颈难定位</strong>：AI调用链路复杂，问题排查困难</li>
<li>• <strong>资源使用不合理</strong>：缺乏数据支撑的优化决策</li>
</ul>
<h4 id="Spring-AI可观测性的价值"><a href="#Spring-AI可观测性的价值" class="headerlink" title="Spring AI可观测性的价值"></a>Spring AI可观测性的价值</h4><p>Spring AI的可观测性功能为这些痛点提供了完美解决方案：</p>
<ul>
<li>• ✅ <strong>精准Token监控</strong>：实时追踪输入/输出Token消耗，精确到每次调用</li>
<li>• ✅ <strong>智能成本控制</strong>：基于使用统计制定成本优化策略</li>
<li>• ✅ <strong>深度性能分析</strong>：识别AI调用瓶颈，优化响应时间</li>
<li>• ✅ <strong>完整链路追踪</strong>：端到端记录请求在Spring AI应用中的完整流转</li>
</ul>
<h3 id="实战演练：构建可观测的Spring-AI翻译应用"><a href="#实战演练：构建可观测的Spring-AI翻译应用" class="headerlink" title="实战演练：构建可观测的Spring AI翻译应用"></a>实战演练：构建可观测的Spring AI翻译应用</h3><h4 id="第一步：Spring-AI项目初始化"><a href="#第一步：Spring-AI项目初始化" class="headerlink" title="第一步：Spring AI项目初始化"></a>第一步：Spring AI项目初始化</h4><p>在start.spring.io[1]创建Spring Boot项目，集成Spring AI核心依赖：</p>
<p><strong>Maven依赖配置（Spring AI BOM管理）：</strong></p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">&lt;!--百炼-->
&lt;dependency>
    &lt;groupId>com.alibaba.cloud.ai&lt;/groupId>
    &lt;artifactId>spring-ai-alibaba-starter-dashscope&lt;/artifactId>
&lt;/dependency> 
&lt;!-- Spring Boot Actuator 监控 -->
&lt;dependency>
  &lt;groupId>org.springframework.boot&lt;/groupId>
  &lt;artifactId>spring-boot-starter-actuator&lt;/artifactId>
&lt;/dependency>
&lt;!--web-->
&lt;dependency>
  &lt;groupId>org.springframework.boot&lt;/groupId>
  &lt;artifactId>spring-boot-starter-web&lt;/artifactId>
&lt;/dependency><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="第二步：Spring-AI客户端配置"><a href="#第二步：Spring-AI客户端配置" class="headerlink" title="第二步：Spring AI客户端配置"></a>第二步：Spring AI客户端配置</h4><p><strong>主应用类配置：</strong></p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">@SpringBootApplication
publicclassSpringAiTranslationApplication &#123;
    
    publicstaticvoidmain(String[] args) &#123;
        SpringApplication.run(SpringAiTranslationApplication.class, args);
    &#125;
    
    @Bean
    public ChatClient chatClient(ChatClient.Builder builder) &#123;
        return builder.build();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Spring AI配置文件：</strong></p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain"># Spring AI 可观测性配置
management:
endpoints:
    web:
      exposure:
        include:"*"
endpoint:
    health:
      show-details:always
metrics:
    export:
      prometheus:
        enabled:true

spring:
threads:
    virtual:
      enabled:true
ai:
    deepseek:
      api-key:$&#123;DEEPSEEK_API_KEY&#125;
      chat:
        options:
          model:deepseek-chat
          temperature: 0.8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>环境变量设置：</strong></p>
<p>export DEEPSEEK_API_KEY=your-deepseek-api-key</p>
<h4 id="第三步：构建Spring-AI翻译服务"><a href="#第三步：构建Spring-AI翻译服务" class="headerlink" title="第三步：构建Spring AI翻译服务"></a>第三步：构建Spring AI翻译服务</h4><p><strong>智能翻译控制器：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringAiTranslationController</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatModel</span> chatModel<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/translate"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">TranslationResponse</span> <span class="token function">translate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">TranslationRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Spring AI翻译请求: &#123;&#125; -> &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getSourceLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getTargetLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> prompt<span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">"作为专业翻译助手，请将以下%s文本翻译成%s，保持原文的语气和风格：\n%s"</span><span class="token punctuation">,</span>
                request<span class="token punctuation">.</span><span class="token function">getSourceLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                request<span class="token punctuation">.</span><span class="token function">getTargetLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                request<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> translatedText<span class="token operator">=</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token class-name">TranslationResponse</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">originalText</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">translatedText</span><span class="token punctuation">(</span>translatedText<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sourceLanguage</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSourceLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">targetLanguage</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTargetLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">class</span> <span class="token class-name">TranslationRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> text<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sourceLanguage<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> targetLanguage<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">class</span> <span class="token class-name">TranslationResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> originalText<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> translatedText<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sourceLanguage<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> targetLanguage<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="第四步：Spring-AI翻译API测试"><a href="#第四步：Spring-AI翻译API测试" class="headerlink" title="第四步：Spring AI翻译API测试"></a>第四步：Spring AI翻译API测试</h4><pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">curl -X POST http://localhost:8080/api/v1/translate  
  -H "Content-Type: application/json"  
  -d '&#123;
    "text": "Spring AI makes AI integration incredibly simple and powerful",
    "sourceLanguage": "英语",
    "targetLanguage": "中文"
&#125;'

# 响应示例
&#123;
"originalText": "Spring AI makes AI integration incredibly simple and powerful",
"translatedText": "Spring AI让AI集成变得极其简单而强大",
"sourceLanguage": "英语",
"targetLanguage": "中文",
"timestamp": 1704067200000
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Spring-AI监控指标深度解析"><a href="#Spring-AI监控指标深度解析" class="headerlink" title="Spring AI监控指标深度解析"></a>Spring AI监控指标深度解析</h3><h4 id="核心指标1：Spring-AI操作性能监控"><a href="#核心指标1：Spring-AI操作性能监控" class="headerlink" title="核心指标1：Spring AI操作性能监控"></a>核心指标1：Spring AI操作性能监控</h4><p><strong>指标端点</strong>：<code>/actuator/metrics/spring.ai.chat.client</code></p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">&#123;
  "name":"spring.ai.chat.client.operation",
"description":"Spring AI ChatClient操作性能指标",
"baseUnit":"seconds",
"measurements":[
    &#123;
      "statistic":"COUNT",
      "value":15
    &#125;,
    &#123;
      "statistic":"TOTAL_TIME",
      "value":8.456780293
    &#125;,
    &#123;
      "statistic":"MAX",
      "value":2.123904083
    &#125;
],
"availableTags":[
    &#123;
      "tag":"gen_ai.operation.name",
      "values":["framework"]
    &#125;,
    &#123;
      "tag":"spring.ai.kind",
      "values":["chat_client"]
    &#125;
]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>业务价值</strong>：</p>
<ul>
<li>• 监控Spring AI翻译服务调用频次</li>
<li>• 分析Spring AI响应时间分布</li>
<li>• 识别Spring AI性能瓶颈</li>
</ul>
<h4 id="核心指标2：Spring-AI-Token使用量精准追踪"><a href="#核心指标2：Spring-AI-Token使用量精准追踪" class="headerlink" title="核心指标2：Spring AI Token使用量精准追踪"></a>核心指标2：Spring AI Token使用量精准追踪</h4><p><strong>指标端点</strong>：<code>/actuator/metrics/gen_ai.client.token.usage</code></p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">&#123;
  "name":"gen_ai.client.token.usage",
"description":"Spring AI Token使用量统计",
"measurements":[
    &#123;
      "statistic":"COUNT",
      "value":1250
    &#125;
],
"availableTags":[
    &#123;
      "tag":"gen_ai.response.model",
      "values":["deepseek-chat"]
    &#125;,
    &#123;
      "tag":"gen_ai.request.model",
      "values":["deepseek-chat"]
    &#125;,
    &#123;
      "tag":"gen_ai.token.type",
      "values":[
        "output",
        "input",
        "total"
      ]
    &#125;
]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>成本控制价值</strong>：</p>
<ul>
<li>• 精确计算Spring AI服务成本</li>
<li>• 优化Prompt设计降低Token消耗</li>
<li>• 制定基于使用量的预算策略</li>
</ul>
<h2 id="Agent应用"><a href="#Agent应用" class="headerlink" title="Agent应用"></a>Agent应用</h2><p>什么是ai agent: </p>
<p>你给个任务，它自己拆分、规划、调用资源、执行链路，直到返回结果。</p>
<p>你给个任务，它自己规划（根据你指定的规划方式）、拆分（根据你指定的拆分方式）、调用资源（根据你提供的资源）、（自动）执行链路，直到返回结果。</p>
<h3 id="1-评估优化器模式-evaluator-optimizer"><a href="#1-评估优化器模式-evaluator-optimizer" class="headerlink" title="1. 评估优化器模式(evaluator-optimizer)"></a>1. <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/evaluator-optimizer">评估优化器模式</a>(<strong>evaluator-optimizer)</strong></h3><p>根据任务–&gt;生成信息—&gt;通过评估器不断完善—&gt;最终输出结果</p>
<p><img src="https://raw.githubusercontent.com/spring-io/spring-io-static/refs/heads/main/blog/tzolov/20250520/anthropic-augmented-llm-agents.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_68,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>这个模式实现了双 LLM 过程，其中一个模型生成响应，另一个模型在迭代循环中提供评估和反馈</p>
<ol>
<li>生成器 LLM 为给定任务产生初始解决方案</li>
<li>评估器 LLM 根据质量标准评估解决方案</li>
<li>如果解决方案通过评估，则作为最终结果返回</li>
<li>如果需要改进，反馈被纳入新的生成周期</li>
<li>重复该过程直到达到满意的解决方案</li>
</ol>
<p>示例代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">CommandLineRunner</span> <span class="token function">commandLineRunner</span><span class="token punctuation">(</span><span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> chatClient <span class="token operator">=</span>  <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> args <span class="token operator">-></span> <span class="token punctuation">&#123;</span> 
			 <span class="token keyword">new</span> <span class="token class-name">SimpleEvaluatorOptimizer</span><span class="token punctuation">(</span>chatClient<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
					&lt;user input>
					 面试被问： 怎么高效的将100行list&lt;User>数据，转化成map&lt;id，user>，不是用stream.
					&lt;/user input>
					"""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleEvaluatorOptimizer</span> <span class="token punctuation">&#123;</span>  
      
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
      
    <span class="token comment">// 中文生成器提示词  </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> GENERATOR_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        你是一个Java代码生成助手。请根据任务要求生成高质量的Java代码。
        重要提醒：
        - 第一次生成时，创建一个基础但完整的实现  
        - 如果收到反馈，请仔细分析每一条建议并逐一改进  
        - 每次迭代都要在前一版本基础上显著提升代码质量  
        - 不要一次性实现所有功能，而是逐步完善  
          
        必须以JSON格式回复：  
        &#123;"thoughts":"详细说明本轮的改进思路","response":"改进后的Java代码"&#125;  
            """</span><span class="token punctuation">;</span>
      
    <span class="token comment">// 中文评估器提示词    </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> EVALUATOR_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
        你是一个非常严格的面试官。请从以下维度严格评估代码：
            1. 代码是否高效：从底层分析每一个类型以满足最佳性能！
              
            评估标准：
            - 只有当代码满足要求达到优秀水平时才返回PASS
            - 如果任何一个维度有改进空间，必须返回NEEDS_IMPROVEMENT 
            - 提供具体、详细的改进建议  
              
            必须以JSON格式回复：  
            &#123;"evaluation":"PASS或NEEDS_IMPROVEMENT或FAIL","feedback":"详细的分维度反馈"&#125;  
              
            记住：宁可严格也不要放松标准！ 
        """</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleEvaluatorOptimizer</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> iteration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> context <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">RefinedResponse</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token class-name">String</span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 第"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>iteration <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"轮迭代 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
              
            <span class="token comment">// 生成代码  </span>
            <span class="token class-name">Generation</span> generation <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
              
            <span class="token comment">// 评估代码  </span>
            <span class="token class-name">EvaluationResponse</span> evaluation <span class="token operator">=</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>generation<span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生成结果: "</span> <span class="token operator">+</span> generation<span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"评估结果: "</span> <span class="token operator">+</span> evaluation<span class="token punctuation">.</span><span class="token function">evaluation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"反馈: "</span> <span class="token operator">+</span> evaluation<span class="token punctuation">.</span><span class="token function">feedback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
              
            <span class="token keyword">if</span> <span class="token punctuation">(</span>evaluation<span class="token punctuation">.</span><span class="token function">evaluation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EvaluationResponse<span class="token punctuation">.</span>Evaluation</span><span class="token punctuation">.</span>PASS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"代码通过评估！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefinedResponse</span><span class="token punctuation">(</span>generation<span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token comment">// 准备下一轮的上下文</span>
                context <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"之前的尝试:\n%s\n\n评估反馈:\n%s\n\n请根据反馈改进代码。"</span><span class="token punctuation">,</span>
                        generation<span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evaluation<span class="token punctuation">.</span><span class="token function">feedback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                iteration<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">loop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">Generation</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> task<span class="token punctuation">,</span> <span class="token class-name">String</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"&#123;prompt&#125;\n&#123;context&#125;\n任务: &#123;task&#125;"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"prompt"</span><span class="token punctuation">,</span> GENERATOR_PROMPT<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"task"</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token class-name">Generation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">EvaluationResponse</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">String</span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"&#123;prompt&#125;\n\n任务: &#123;task&#125;\n\n代码:\n&#123;content&#125;"</span><span class="token punctuation">)</span>  
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"prompt"</span><span class="token punctuation">,</span> EVALUATOR_PROMPT<span class="token punctuation">)</span>  
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"task"</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>  
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token class-name">EvaluationResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token comment">// 使用原始的记录类  </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">Generation</span><span class="token punctuation">(</span><span class="token class-name">String</span> thoughts<span class="token punctuation">,</span> <span class="token class-name">String</span> response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">EvaluationResponse</span><span class="token punctuation">(</span><span class="token class-name">Evaluation</span> evaluation<span class="token punctuation">,</span> <span class="token class-name">String</span> feedback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Evaluation</span> <span class="token punctuation">&#123;</span> PASS<span class="token punctuation">,</span> NEEDS_IMPROVEMENT<span class="token punctuation">,</span> FAIL <span class="token punctuation">&#125;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">RefinedResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> solution<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li> 一个模型作为由浅入深的代码生成器</li>
<li>另一个模型作为性能分析员</li>
<li>一直优化直到最佳</li>
</ol>
<h3 id="2-路由模式-routing-workflow"><a href="#2-路由模式-routing-workflow" class="headerlink" title="2. 路由模式(routing-workflow)"></a>2. <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/routing-workflow">路由模式</a>(routing-workflow)</h3><p>模式能够根据用户请求和上下文的分类将输入智能路由到专门的处理程序。</p>
<p><img src="https://camo.githubusercontent.com/f24087710985a7d76000aab04f083eefcc7460fb965c9f2bac6ca0783329c5c3/68747470733a2f2f7777772e616e7468726f7069632e636f6d2f5f6e6578742f696d6167653f75726c3d68747470732533412532462532467777772d63646e2e616e7468726f7069632e636f6d253246696d61676573253246347a727a6f76626225324677656273697465253246356330633065396665346465663062353834633034643337383439393431646135356535653731632d3234303178313030302e706e6726773d3338343026713d3735?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_68,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>这个工作流特别适用于复杂任务，其中：</p>
<ul>
<li><strong>路由器LLM</strong>: 通过设置提示词进行路由规则设定，由usermessage决定路由的分支。  </li>
<li>分类可以通过 LLM 或业务代码进行处理</li>
<li>不同类型的输入需要不同的专门处理或专业知识</li>
</ul>
<h3 id="3-编排工作者-orchestrator-workers"><a href="#3-编排工作者-orchestrator-workers" class="headerlink" title="3. 编排工作者(orchestrator-workers)"></a>3. <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/orchestrator-workers">编排工作者</a>(orchestrator-workers)</h3><p>这种模式是一种灵活的方法，用于处理需要动态任务分解和专门处理的复杂任务 manus就是这个模式</p>
<p><img src="https://camo.githubusercontent.com/953d1b88a05e93e1707bc955924cff7742b408515af0df34c4790c2a27f60131/68747470733a2f2f7777772e616e7468726f7069632e636f6d2f5f6e6578742f696d6167653f75726c3d68747470732533412532462532467777772d63646e2e616e7468726f7069632e636f6d253246696d61676573253246347a727a6f76626225324677656273697465253246383938356663363833666165343738306662333465616231333635616237386337653531626338652d3234303178313030302e706e6726773d3338343026713d3735?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_68,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>该模式包含三个主要组件：</p>
<ul>
<li><strong>编排器（Orchestrator）</strong>：分析任务并确定所需子任务的LLM</li>
<li><strong>工作者（Workers）</strong>：执行特定子任务的专门 LLM</li>
<li><strong>合成器（Synthesizer）</strong>：将工作者输出合并为最终结果的组件</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleOrchestratorWorkers</span> <span class="token punctuation">&#123;</span>  
      
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
      
    <span class="token comment">// 中文编排器提示词  </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ORCHESTRATOR_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
                你是一个项目管理专家，需要将复杂任务分解为可并行执行的专业子任务。
                    任务: &#123;task&#125;
                    请分析任务的复杂性和专业领域需求，将其分解为2-4个需要不同专业技能的子任务。
                    每个子任务应该：
                    1. 有明确的专业领域（如：前端开发、后端API、数据库设计、测试等）
                    2. 可以独立执行
                    3. 有具体的交付物
                    
                    请以JSON格式回复：
                    &#123;
                        "analysis": "任务复杂度分析和分解策略",
                        "tasks": [
                            &#123;
                                "type": "后端API开发",
                                "description": "设计并实现RESTful API接口，包括数据验证和错误处理"
                            &#125;,
                            &#123;
                                "type": "前端界面开发",
                                "description": "创建响应式用户界面，实现与后端API的交互"
                            &#125;,
                            &#123;
                                "type": "数据库设计",
                                "description": "设计数据表结构，编写SQL脚本和索引优化"
                            &#125;
                        ]
                    &#125;
            """</span><span class="token punctuation">;</span>  
      
    <span class="token comment">// 中文工作者提示词  </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> WORKER_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            你是一个&#123;task_type&#125;领域的资深专家，请完成以下专业任务：
              项目背景: &#123;original_task&#125;
              专业领域: &#123;task_type&#125;
              具体任务: &#123;task_description&#125;
              
              请按照行业最佳实践完成任务，包括：
              1. 技术选型和架构考虑
              2. 具体实现方案
              3. 潜在风险和解决方案
              4. 质量保证措施
              
              请提供专业、详细的解决方案。
            """</span><span class="token punctuation">;</span>  
      
    <span class="token keyword">public</span> <span class="token class-name">SimpleOrchestratorWorkers</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskDescription<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 开始处理任务 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 步骤1: 编排器分析任务  </span>
        <span class="token class-name">OrchestratorResponse</span> orchestratorResponse <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"task"</span><span class="token punctuation">,</span> taskDescription<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>ORCHESTRATOR_PROMPT<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token class-name">OrchestratorResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"编排器分析: "</span> <span class="token operator">+</span> orchestratorResponse<span class="token punctuation">.</span><span class="token function">analysis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子任务列表: "</span> <span class="token operator">+</span> orchestratorResponse<span class="token punctuation">.</span><span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 步骤2: 工作者处理各个子任务  </span>
        orchestratorResponse<span class="token punctuation">.</span><span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">-></span> <span class="token punctuation">&#123;</span>  
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------处理子任务: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"--------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> content <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>WORKER_PROMPT<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"original_task"</span><span class="token punctuation">,</span> taskDescription<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"task_type"</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"task_description"</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> task<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 所有工作者完成任务 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">&#125;</span>
      
    <span class="token comment">// 数据记录类  </span>
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">OrchestratorResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> analysis<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">></span></span> tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">FinalResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> analysis<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> workerResponses<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>测试</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">CommandLineRunner</span> <span class="token function">commandLineRunner</span><span class="token punctuation">(</span><span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> chatClient <span class="token operator">=</span>  <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> args <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">new</span> <span class="token class-name">SimpleOrchestratorWorkers</span><span class="token punctuation">(</span>chatClient<span class="token punctuation">)</span>
					 <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">"设计一个企业级的员工考勤系统，支持多种打卡方式和报表生成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="4-链接（chain-workflow）"><a href="#4-链接（chain-workflow）" class="headerlink" title="4. 链接（chain-workflow）"></a>4. <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/chain-workflow">链接</a>（<strong>chain-workflow</strong>）</h3><p>该模式将复杂的任务分解为一系列步骤，其中每个 LLM 调用都会处理前一个调用的输出。</p>
<p><img src="https://camo.githubusercontent.com/093824e1ad0326017ab84b949bb2eafd5b3f28bbd8b55447f9a488a57f7c7701/68747470733a2f2f7777772e616e7468726f7069632e636f6d2f5f6e6578742f696d6167653f75726c3d68747470732533412532462532467777772d63646e2e616e7468726f7069632e636f6d253246696d61676573253246347a727a6f76626225324677656273697465253246373431383731396533646162323232646363623337396238383739653164633038616433346337382d3234303178313030302e706e6726773d3338343026713d3735?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_68,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>这种模式特别适用于：</p>
<ul>
<li>具有清晰顺序步骤的任务</li>
<li>当您愿意用延迟换取更高准确性时</li>
<li>每个步骤都建立在前一步输出基础上的场景</li>
</ul>
<p><strong>使用场景</strong></p>
<p>常见应用包括：</p>
<ul>
<li>数据转换管道</li>
<li>多步骤文本处理</li>
<li>结构化步骤的文档生成</li>
</ul>
<p>与 <code>orchestrator-workers</code> 或 <code>evaluator-optimizer</code> 模式不同，链式工作流不是基于多个独立的 LLM 角色协作，而是通过单一的处理链条，每个步骤都建立在前一步的输出基础上</p>
<p><strong>代码</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DocumentGenerationChainWorkflow</span> <span class="token punctuation">&#123;</span>
      
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>
      
    <span class="token keyword">public</span> <span class="token class-name">DocumentGenerationChainWorkflow</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token class-name">DocumentResult</span> <span class="token function">processDocumentGeneration</span><span class="token punctuation">(</span><span class="token class-name">String</span> requirements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> steps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> currentOutput <span class="token operator">=</span> requirements<span class="token punctuation">;</span>  
          
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 开始文档生成链式流程 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 门控：需求验证  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validateRequirements</span><span class="token punctuation">(</span>currentOutput<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DocumentResult</span><span class="token punctuation">(</span><span class="token string">"需求验证失败，流程终止"</span><span class="token punctuation">,</span> steps<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span>  
        steps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"需求验证: 通过"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 步骤1: 生成大纲 - 基于原始需求  </span>
        currentOutput <span class="token operator">=</span> <span class="token function">generateOutline</span><span class="token punctuation">(</span>currentOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        steps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"大纲生成: 完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 步骤2: 扩展内容 - 基于大纲  </span>
        currentOutput <span class="token operator">=</span> <span class="token function">expandContent</span><span class="token punctuation">(</span>currentOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        steps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"内容扩展: 完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 步骤3: 优化语言 - 基于扩展后的内容  </span>
        currentOutput <span class="token operator">=</span> <span class="token function">optimizeLanguage</span><span class="token punctuation">(</span>currentOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        steps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"语言优化: 完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token comment">// 步骤4: 格式化 - 基于优化后的内容  </span>
        currentOutput <span class="token operator">=</span> <span class="token function">formatDocument</span><span class="token punctuation">(</span>currentOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        steps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"文档格式化: 完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 文档生成流程完成 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DocumentResult</span><span class="token punctuation">(</span>currentOutput<span class="token punctuation">,</span> steps<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">validateRequirements</span><span class="token punctuation">(</span><span class="token class-name">String</span> requirements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token class-name">String</span> validationPrompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            请验证以下文档需求是否清晰完整：  
              
            需求: &#123;requirements&#125;  
              
            如果需求清晰完整，请回复"PASS"，否则回复"FAIL"。  
            """</span><span class="token punctuation">;</span>  
          
        <span class="token class-name">String</span> result <span class="token operator">=</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>validationPrompt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"requirements"</span><span class="token punctuation">,</span> requirements<span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"PASS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateOutline</span><span class="token punctuation">(</span><span class="token class-name">String</span> requirements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token class-name">String</span> outlinePrompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            基于以下需求，生成详细的文档大纲：  
              
            需求: &#123;input&#125;  
              
            请生成包含主要章节和子章节的结构化大纲。  
            """</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> <span class="token function">executeStep</span><span class="token punctuation">(</span>outlinePrompt<span class="token punctuation">,</span> requirements<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">expandContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> outline<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token class-name">String</span> contentPrompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            基于以下大纲，为每个章节生成详细内容：  
              
            大纲: &#123;input&#125;  
              
            请为每个章节编写具体内容，保持逻辑连贯。  
            """</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> <span class="token function">executeStep</span><span class="token punctuation">(</span>contentPrompt<span class="token punctuation">,</span> outline<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">optimizeLanguage</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token class-name">String</span> optimizePrompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            优化以下文档内容的语言表达：  
              
            原始内容: &#123;input&#125;  
              
            请改进语言表达，使其更加专业、清晰、易读。  
            """</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> <span class="token function">executeStep</span><span class="token punctuation">(</span>optimizePrompt<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">formatDocument</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token class-name">String</span> formatPrompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            将以下内容格式化为专业文档：  
              
            内容: &#123;input&#125;  
              
            请添加适当的标题层级、列表、表格等格式，生成最终的markdown文档。  
            """</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> <span class="token function">executeStep</span><span class="token punctuation">(</span>formatPrompt<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">executeStep</span><span class="token punctuation">(</span><span class="token class-name">String</span> prompt<span class="token punctuation">,</span> <span class="token class-name">String</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">DocumentResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> finalDocument<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> steps<span class="token punctuation">,</span> <span class="token keyword">boolean</span> success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">CommandLineRunner</span> <span class="token function">commandLineRunner</span><span class="token punctuation">(</span><span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> chatClient <span class="token operator">=</span>  <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> args <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
			  

			<span class="token class-name">String</span> requirements <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            需要编写一份关于微服务架构设计的技术文档，包括：  
            1. 架构概述  
            2. 服务拆分策略  
            3. 数据一致性方案  
            4. 监控和运维  
            目标读者：技术团队和架构师  
            """</span><span class="token punctuation">;</span>

			<span class="token class-name">DocumentGenerationChainWorkflow<span class="token punctuation">.</span>DocumentResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DocumentGenerationChainWorkflow</span><span class="token punctuation">(</span>chatClient<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">processDocumentGeneration</span><span class="token punctuation">(</span>requirements<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生成结果: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"成功"</span> <span class="token operator">:</span> <span class="token string">"失败"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最终文档:"</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">finalDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"处理步骤: "</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">steps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="5-并行化（parallelization-workflow）"><a href="#5-并行化（parallelization-workflow）" class="headerlink" title="5. 并行化（parallelization-workflow）"></a>5. <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-ai-examples/tree/main/agentic-patterns/parallelization-worflow">并行化</a>（<strong>parallelization-workflow</strong>）</h3><p>该模式对于需要并行执行 LLM 调用并自动进行输出聚合的情况很有用。</p>
<p>deepseek   MoE 多专家  多路并行  </p>
<p><img src="https://camo.githubusercontent.com/c0614dadbbcee40b9cb94111644400106384ee6254e83275cd11091824197c1f/68747470733a2f2f7777772e616e7468726f7069632e636f6d2f5f6e6578742f696d6167653f75726c3d68747470732533412532462532467777772d63646e2e616e7468726f7069632e636f6d253246696d61676573253246347a727a6f76626225324677656273697465253246343036626230333263613030376664313632346632363161663731376437306536636138363238362d3234303178313030302e706e6726773d3338343026713d3735?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_68,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>并行化工作流模式通过并发处理多个 LLM 操作来提高效率，主要有两种变体：</p>
<ol>
<li><strong>分段处理（Sectioning）</strong>：将复杂任务分解为独立的子任务并行处理</li>
<li><strong>投票机制（Voting）</strong>：对同一任务运行多次以获得不同视角或进行多数投票</li>
</ol>
<p><strong>使用场景</strong></p>
<p>该模式特别适用于：</p>
<ul>
<li>处理大量相似但独立的项目</li>
<li>需要多个独立视角的任务</li>
<li>处理时间关键且任务可并行化的场景</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParallelizationWorkflowWithAggregator</span> <span class="token punctuation">&#123;</span>
      
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> RISK_ASSESSMENT_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            你是一个风险评估专家，请分析以下部门在数字化转型过程中面临的主要风险：  
              
            请从以下角度分析：  
            1. 技术风险  
            2. 人员风险    
            3. 业务连续性风险  
            4. 预算风险  
            5. 应对建议  
            """</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ParallelizationWorkflowWithAggregator</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token class-name">AggregatedResult</span> <span class="token function">parallelWithAggregation</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> inputs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 步骤1: 并行处理  </span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> parallelResults <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
        <span class="token comment">// 步骤2: 聚合结果  </span>
        <span class="token class-name">String</span> aggregatedOutput <span class="token operator">=</span> <span class="token function">aggregateResults</span><span class="token punctuation">(</span>parallelResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AggregatedResult</span><span class="token punctuation">(</span>parallelResults<span class="token punctuation">,</span> aggregatedOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">parallel</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> inputs <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>inputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> futures <span class="token operator">=</span> inputs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>input <span class="token operator">-></span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>  
                    <span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>RISK_ASSESSMENT_PROMPT <span class="token operator">+</span> <span class="token string">"\n输入内容: "</span> <span class="token operator">+</span> input<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
                        <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">)</span>  
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> allFutures <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>  
                futures<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            allFutures<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
              
            <span class="token keyword">return</span> futures<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token operator">::</span><span class="token function">join</span><span class="token punctuation">)</span>  
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                  
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>  
            executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token comment">// 聚合器：将多个并行结果合并为统一输出  </span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">aggregateResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> aggregatorPrompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""  
            你是一个数据聚合专家，请将以下多个分析结果合并为一份综合报告：  
              
            原始分析任务: &#123;originalPrompt&#125;  
              
            各部门/地区分析结果:  
            &#123;results&#125;  
              
            请提供：  
            1. 综合分析摘要  
            2. 共同趋势和模式  
            3. 关键差异对比  
            4. 整体结论和建议  
              
            请生成一份统一的综合报告。  
            """</span><span class="token punctuation">;</span>  
          
        <span class="token class-name">String</span> combinedResults <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n\n---\n\n"</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>  
          
        <span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>u <span class="token operator">-></span> u<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>aggregatorPrompt<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"originalPrompt"</span><span class="token punctuation">,</span> RISK_ASSESSMENT_PROMPT<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"results"</span><span class="token punctuation">,</span> combinedResults<span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">AggregatedResult</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> individualResults<span class="token punctuation">,</span> <span class="token class-name">String</span> aggregatedOutput<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">CommandLineRunner</span> <span class="token function">commandLineRunner</span><span class="token punctuation">(</span><span class="token class-name">DashScopeChatModel</span> dashScopeChatModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> chatClient <span class="token operator">=</span>  <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>dashScopeChatModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> args <span class="token operator">-></span> <span class="token punctuation">&#123;</span>

			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> departments <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
					<span class="token string">"IT部门：负责系统架构升级，团队技术水平参差不齐，预算紧张"</span><span class="token punctuation">,</span>
					<span class="token string">"销售部门：需要学习新的CRM系统，担心影响客户关系，抗拒变化"</span><span class="token punctuation">,</span>
					<span class="token string">"财务部门：要求数据安全性极高，对云端存储有顾虑，流程复杂"</span><span class="token punctuation">,</span>
					<span class="token string">"人力资源部门：需要数字化招聘流程，缺乏相关技术人员，时间紧迫"</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 并行分析 + 聚合处理 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ParallelizationWorkflowWithAggregator<span class="token punctuation">.</span>AggregatedResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParallelizationWorkflowWithAggregator</span><span class="token punctuation">(</span>chatClient<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">parallelWithAggregation</span><span class="token punctuation">(</span> departments<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n=== 各部门独立分析结果 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result<span class="token punctuation">.</span><span class="token function">individualResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"部门"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">individualResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"-"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n=== 聚合器综合报告 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">aggregatedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="agent实战《手写manus》"><a href="#agent实战《手写manus》" class="headerlink" title="agent实战《手写manus》"></a>agent实战《手写manus》</h2><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><p>话不多说，先看运行效果，以下是我们通过几个实际问答记录展示的 Spring AI Alibaba OpenManus 实际使用效果。</p>
<ol>
<li><strong>打开百度浏览器，在搜索框输入：阿里巴巴最最近一周股价，根据搜索到的信息绘制最近一周的股价趋势图并保存到本地目录。</strong></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753361269042-5aa48e61-f6f5-49ff-9c33-5262cb61396f.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_43,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li><strong>我计划在接下来的五一劳动节假期到韩国旅行，行程是从杭州出发到韩国首尔，总预算为10000元。我想体验韩国的风土人情、文化、普通老百姓的生活，总行程计划为5天。请提供详细的行程并制作成一个简单的HTML旅行手册，其中包含地图、景点描述、基本的韩语短语和旅行提示，以供我在整个旅程中参考。</strong></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753361269161-8ce376b1-af1b-4608-a9ed-f37c786956d2.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_43,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ol>
<li><strong>在本机的/tmp/docs目录下有一些中文文档 ，请依次将这些文档翻译为中文并保存到一个独立文件，将新生成的文件都存放到/tmp/endocs目录下</strong></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753361269183-f3a033ea-b70d-464c-853a-f1cb326cf15e.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_43,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h2 id="总体架构与原理"><a href="#总体架构与原理" class="headerlink" title="总体架构与原理"></a>总体架构与原理</h2><p>Spring AI Alibaba Openmanus 与 Python 版本 OpenManus 设计理念相似，其总体架构如下图所示。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/22309163/1753361269182-043dee63-8a81-4e7e-bf18-609c0108d6f4.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_35,text_5b6Q5bq26ICB5biI,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>分析上图架构，我们可以把它看作是一款多 Agent 智能自动协作实现，其中：</p>
<ul>
<li>Planning Agent 负责任务的分解与规划，将用户问题拆解成几个可顺序执行的 step。planning agent 调用 planning tool 动态生成一个串行的 Manus Agent 子工作流。</li>
<li>多个 Manus Agent 组成一个链式、可顺序依次执行的子工作流。子工作流中的每个 agent 对应上述规划的一个 step，每个 agent 都是一个 ReAct 架构设计，即通过多轮 Tool 调用完成具体子任务。</li>
<li>Summary Agent 用来做最后的任务总结</li>
</ul>
<h2 id="-7"><a href="#-7" class="headerlink" title=""></a></h2>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">wmg</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://wumangeng.github.io/2025/09/20/spring-ai/">http://wumangeng.github.io/2025/09/20/spring-ai/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">wmg</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Spring/">
                                    <span class="chip bg-color">Spring</span>
                                </a>
                            
                                <a href="/tags/Spring-AI/">
                                    <span class="chip bg-color">Spring AI</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2025/09/20/spring-ai/">
                    <div class="card-image">
                        
                        <img src="https://wumangeng-github-io.oss-cn-guangzhou.aliyuncs.com/hexo-blog/blog-image/1747741091046-75e76e43-b253-4c0d-8c15-25ab15ab6e20.png" class="responsive-img" alt="Spring AI">
                        
                        <span class="card-title">Spring AI</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Spring AI
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-09-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring/" class="post-category">
                                    Spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring/">
                        <span class="chip bg-color">Spring</span>
                    </a>
                    
                    <a href="/tags/Spring-AI/">
                        <span class="chip bg-color">Spring AI</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/09/15/influxdb/">
                    <div class="card-image">
                        
                        <img src="https://img0.baidu.com/it/u=946849688,716705497&fm=253&fmt=auto&app=138&f=PNG?w=1200&h=445" class="responsive-img" alt="Influxdb安装">
                        
                        <span class="card-title">Influxdb安装</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Influxdb安装
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-09-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="chip bg-color">数据库</span>
                    </a>
                    
                    <a href="/tags/Influxdb/">
                        <span class="chip bg-color">Influxdb</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2025</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">wumangeng</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/wumangeng/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wumangeng" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2672885962@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>


<!--  -->
<!-- 
 -->


    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2672885962" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2672885962" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>


<!--  -->




</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
